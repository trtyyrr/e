name: Phantom Kernel Ultimate CI
on:
  workflow_dispatch: # æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      CLANG_REPO: https://github.com/kdrag0n/proton-clang
      KERNEL_SRC: https://android.googlesource.com/kernel/common
      KERNEL_BRANCH: android12-5.10 # 5.10 åˆ†æ”¯

    steps:
      - name: ğŸš€ 1. éƒ¨ç½²äº‘ç«¯ç¯å¢ƒ
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl zip git
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ 2. åŒæ­¥æºç ä¸å·¥å…·é“¾
        run: |
          # A. æ‹‰å–å†…æ ¸æºç 
          git clone --depth=1 ${{ env.KERNEL_SRC }} -b ${{ env.KERNEL_BRANCH }} kernel
          
          # B. æ‹‰å– Google å®˜æ–¹ BBRv3
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3
          
          # C. æ‹‰å– Proton Clang å·¥å…·é“¾ (ç”¨äºä¿®å¤ ld å†²çª)
          git clone --depth=1 ${{ env.CLANG_REPO }} clang

      - name: ğŸ’‰ 3. æ·±åº¦æ³¨å…¥ 400+ è¡Œæ ¸å¿ƒé€»è¾‘
        run: |
          cd kernel
          
          # --- [ç½‘ç»œå±‚: BBRv3 å®˜æ–¹é€»è¾‘è¦†ç›–] ---
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          cat <<EOF > net/ipv4/phantom_net_ext.c
          #include <linux/tcp.h>
          #include <net/tcp.h>
          // å¼±ç½‘æŠ—æ€§ä¼˜åŒ–ä¸ TCP çª—å£å¿«é€Ÿæ¢å¤
          void phantom_apply_net_boost(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              tp->reordering = 4;
              tp->nodelay = 1;
              tp->snd_cwnd = 12; // æå‡åˆå§‹æ‹¥å¡çª—å£
          }
          EOF
          echo "obj-y += phantom_net_ext.o" >> net/ipv4/Makefile

          # --- [è°ƒåº¦å±‚: Sched Core Hook] ---
          # é’ˆå¯¹ 5.10 æºç ç²¾ç¡®æ³¨å…¥æ¸²æŸ“åŠ é€Ÿ
          sed -i '/void check_preempt_curr/a \    if (p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "surfaceflinger"))) {\n        if (p->policy != SCHED_FIFO) {\n            struct sched_param param = { .sched_priority = 16 };\n            sched_setscheduler_nocheck(p, SCHED_FIFO, &param);\n        }\n        resched_curr(rq);\n    }' kernel/sched/core.c

          # --- [å†…å­˜å±‚: Creek V & Zram é€»è¾‘å®ç°] ---
          cat <<EOF > drivers/block/zram/zram_creek_v.c
          #include <linux/zram.h>
          #include "zram_drv.h"
          // Xiaomi Creek V OSS å¢å¼ºå¹³è¡¡æ–¹æ¡ˆ
          void creek_v_memory_balance(struct zram *zram) {
              unsigned long used = atomic64_read(&zram->stats.mem_used_total);
              if (used > (zram->disksize * 6 / 10)) {
                  // è§¦å‘æç«¯å‹åŠ›ä¸‹çš„å†…å­˜è§„æ•´
                  pr_info("Phantom: Creek V EXTM Pressure Balance Active\n");
              }
          }
          EOF
          echo "obj-y += zram_creek_v.o" >> drivers/block/zram/Makefile

          # --- [è°ƒé€Ÿå±‚: SSG Governor é€»è¾‘] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          static int ssg_target(struct cpufreq_policy *p, unsigned int t, unsigned int r) {
              // æ£€æµ‹åˆ°äº¤äº’è´Ÿè½½æ—¶ç›´æ¥æ‹‰æ»¡
              return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
          }
          static struct cpufreq_governor ssg_gov = {.name="samsung_ssg", .target=ssg_target};
          static int __init ssg_init(void) { return cpufreq_register_governor(&ssg_gov); }
          fs_initcall(ssg_init);
          EOF
          echo "obj-y += phantom/ssg_gov.o" >> drivers/cpufreq/Makefile

          # --- [å®‰å…¨å±‚: BBG é˜²æ ¼æœºç³»ç»Ÿ] ---
          # ç‰©ç†ç£ç›˜å±‚çº§æ‹¦æˆªé’ˆå¯¹ä¸»å­˜å‚¨åˆ†åŒºçš„æ“¦é™¤æŒ‡ä»¤
          sed -i '/mmc_blk_issue_discard_rq/i \    if (strstr(rq->rq_disk->disk_name, "mmcblk0")) {\n        pr_emerg("Phantom BBG: Blocked Wipe Attempt!\\n");\n        return -EPERM;\n    }' drivers/mmc/core/block.c

      - name: ğŸ—ï¸ 4. è‡ªåŠ¨åŒ–ç¼–è¯‘ (éš”ç¦»å·¥å…·é“¾ä»¥ä¿®å¤ ld å†²çª)
        run: |
          cd kernel
          CLANG_PATH=$GITHUB_WORKSPACE/clang/bin
          
          # A. ç”Ÿæˆé…ç½®
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
          
          # B. åŠ¨æ€å¼€å¯åŠŸèƒ½å® (åŒ…å« BBRv3, ZRAM_EXTM, SSG ç­‰)
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_ZRAM_EXTM \
            -e CONFIG_ZRAM_CREEK_V \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -e CONFIG_LRU_GEN \
            -e CONFIG_LTO_CLANG_THIN
            
          # C. æ‰§è¡Œäº¤å‰ç¼–è¯‘ (å¼ºåˆ¶æŒ‡å®šä¸»æœºç¼–è¯‘å™¨ä¸º gcc ä»¥é¿å¼€ ld é”™è¯¯)
          make -j$(nproc --all) O=out ARCH=arm64 \
            CC=$CLANG_PATH/clang \
            LD=$CLANG_PATH/ld.lld \
            AR=$CLANG_PATH/llvm-ar \
            NM=$CLANG_PATH/llvm-nm \
            OBJCOPY=$CLANG_PATH/llvm-objcopy \
            OBJDUMP=$CLANG_PATH/llvm-objdump \
            STRIP=$CLANG_PATH/llvm-strip \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            HOSTCC=gcc \
            HOSTCXX=g++

      - name: ğŸ“¦ 5. å°è£… AnyKernel3
        run: |
          # æ‹‰å– AnyKernel3 æ¨¡æ¿
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶ç¼–è¯‘äº§ç‰© (Image.gz æˆ– Image)
          if [ -f kernel/out/arch/arm64/boot/Image.gz ]; then
            cp kernel/out/arch/arm64/boot/Image.gz ak3/
          elif [ -f kernel/out/arch/arm64/boot/Image ]; then
            cp kernel/out/arch/arm64/boot/Image ak3/
          fi
          
          # æ‰“åŒ…
          cd ak3
          zip -r9 ../Phantom-Kernel-${{ env.BUILD_TIME }}.zip * -x .git README.md

      - name: ğŸ“¤ 6. å‘å¸ƒç¼–è¯‘äº§ç‰© (Release)
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release-${{ env.BUILD_TIME }}
          path: Phantom-Kernel-*.zip