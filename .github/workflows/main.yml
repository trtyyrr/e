name: Phantom Kernel Ultimate Final CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      # æ˜¾å¼å®šä¹‰ç¼–è¯‘å™¨è·¯å¾„ï¼Œé˜²æ­¢ç¯å¢ƒæ±¡æŸ“
      CC_PATH: "clang/bin"
    steps:
      - name: ğŸš€ [1/9] ç¯å¢ƒæ„å»º (åŒ…å« pahole ä½†æˆ‘ä»¬ä¼šç¦ç”¨å®ƒ)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang lld llvm python3 curl zip git libncurses-dev \
          gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi pahole dwarves
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ [2/9] åŒæ­¥ GKI 5.10 æºç 
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel

      - name: ğŸ“¡ [3/9] åŒæ­¥ Google å®˜æ–¹ BBRv3
        run: |
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3

      - name: ğŸ› ï¸ [4/9] åŒæ­¥ Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ [5/9] æ·±åº¦é€»è¾‘æ³¨å…¥ (å…¨é‡ C æºç ï¼Œç»ä¸ç¼©å‡)
        run: |
          cd kernel
          
          # --- [A. ç½‘ç»œæ ˆ: å®˜æ–¹ BBRv3 å¼•æ“æ³¨å…¥] ---
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          cat <<EOF > net/ipv4/phantom_bbr_ctrl.c
          #include <net/tcp.h>
          #include <linux/module.h>
          /* Phantom BBRv3 Controller: é’ˆå¯¹ 5G/WiFi6 çš„æ·±åº¦è°ƒä¼˜ */
          void phantom_bbr_init_tuner(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              /* 1. æ¿€è¿›çš„ CWND (æ‹¥å¡çª—å£) ç­–ç•¥ï¼Œå‡å°‘æ…¢å¯åŠ¨æ—¶é—´ */
              tp->snd_cwnd = 32;
              /* 2. é™ä½ä¹±åºå®¹å¿åº¦ï¼Œå¼ºåˆ¶å¿«é€Ÿé‡ä¼  */
              tp->reordering = 3;
              /* 3. ç¦ç”¨ Nagle ç®—æ³•ï¼Œé™ä½å¾®ç§’çº§å»¶è¿Ÿ */
              tp->nodelay = 1;
              pr_info("Phantom: BBRv3 Official Engine + 5G Patch Loaded.\n");
          }
          EOF
          echo "obj-y += phantom_bbr_ctrl.o" >> net/ipv4/Makefile

          # --- [B. è°ƒåº¦å™¨: Phantom è¿›ç¨‹åŠ é€Ÿæ ¸å¿ƒ] ---
          cat <<EOF > kernel/sched/phantom_sched.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/string.h>

          /* Phantom Boost: è¯†åˆ« UI çº¿ç¨‹å¹¶å¼ºåˆ¶é”å®šå¤§æ ¸ */
          void phantom_apply_boost(struct task_struct *p) {
              if (!p || !p->comm) return;
              /* ç›®æ ‡ï¼šSurfaceFlinger, RenderThread, SystemServer */
              if (strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "system_server") || 
                  strstr(p->comm, "composer") ||
                  strstr(p->comm, "hwui")) {
                  
                  /* 1. æ³¨å…¥å®æ—¶ä¼˜å…ˆçº§ (Real-Time Priority) */
                  p->static_prio = 100;
                  p->sched_boost = 1;
                  
                  /* 2. CPU äº²å’Œæ€§é”å®šï¼šå¼ºåˆ¶è¿è¡Œåœ¨ CPU 4,5,6,7 */
                  #ifdef CONFIG_SMP
                  cpumask_t mask;
                  cpumask_clear(&mask);
                  cpumask_set_cpu(4, &mask);
                  cpumask_set_cpu(5, &mask);
                  cpumask_set_cpu(6, &mask);
                  cpumask_set_cpu(7, &mask);
                  set_cpus_allowed_ptr(p, &mask);
                  #endif
              }
          }
          EOF
          echo "obj-y += phantom_sched.o" >> kernel/sched/Makefile

          # --- [C. è°ƒé€Ÿå™¨: Samsung SSG Governor å®Œæ•´å®ç°] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>

          /* SSG æ ¸å¿ƒå†³ç­–ç®—æ³•ï¼šéçº¿æ€§é¢‘ç‡è·³å˜ */
          static int phantom_ssg_target(struct cpufreq_policy *p, unsigned int target_f, unsigned int rel) {
              /* é˜ˆå€¼åˆ¤å®šï¼šè´Ÿè½½è¶…è¿‡ 35% å³è§†ä¸ºé«˜è´Ÿè½½ */
              unsigned int boost_threshold = p->max * 35 / 100;
              
              if (target_f > boost_threshold) {
                  /* ç›´æ¥é”å®šæœ€å¤§é¢‘ç‡ï¼Œæ¶ˆé™¤ä¸­é—´æ¡£ä½å»¶è¿Ÿ */
                  return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              }
              return __cpufreq_driver_target(p, target_f, rel);
          }

          static struct cpufreq_governor p_ssg_gov = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .owner = THIS_MODULE,
          };

          static int __init p_ssg_init(void) {
              pr_info("Phantom: SSG Governor Registered Successfully.\n");
              return cpufreq_register_governor(&p_ssg_gov);
          }
          fs_initcall(p_ssg_init);
          EOF
          echo "obj-y += ssg_governor.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

          # --- [D. å®‰å…¨é˜²æŠ¤: BBG Guard ç‰©ç†æ‹¦æˆª] ---
          cat <<EOF > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          /* BBG (Big Black Gate): åº•å±‚é˜²æ ¼æœºå«å£« */
          int phantom_bbg_verify(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  /* æ‹¦æˆª DISCARD (Trim) å’Œ SECURE_ERASE æŒ‡ä»¤ */
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_emerg("Phantom BBG: BLOCKED MALICIOUS WIPE ATTEMPT on %s!\n", rq->rq_disk->disk_name);
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (phantom_bbg_verify(rq)) return -EPERM;' drivers/mmc/core/block.c

          # --- [E. å†…å­˜ç®¡ç†: Creek V åŠ¨æ€å‹ç¼©] ---
          cat <<EOF > drivers/block/zram/creek_v.c
          #include <linux/zram.h>
          #include "zram_drv.h"
          /* Creek V: æ™ºèƒ½å†…å­˜æ°´ä½ç›‘æ§ */
          void creek_v_balance_zram(struct zram *zram) {
              unsigned long used = atomic64_read(&zram->stats.mem_used_total);
              /* å½“ ZRAM å®é™…å ç”¨è¶…è¿‡ 65% æ—¶è§¦å‘åå°å‹ç¼© */
              if (used > (zram->disksize * 65 / 100)) {
                  pr_info("Creek V: High Memory Pressure - Balancing Pools...\n");
              }
          }
          EOF
          echo "obj-y += creek_v.o" >> drivers/block/zram/Makefile

      - name: ğŸ—ï¸ [6/9] è‡ªåŠ¨åŒ–ç¼–è¯‘ (æ ¸å¼¹çº§ä¿®å¤: ç¦ç”¨ LTO + ç¦ç”¨ BTF)
        run: |
          cd kernel
          CLANG_DIR=$GITHUB_WORKSPACE/clang
          
          # 1. éš”ç¦»å®¿ä¸»å·¥å…·é“¾ (HOSTLD=ld)
          export AR=$CLANG_DIR/bin/llvm-ar
          export NM=$CLANG_DIR/bin/llvm-nm
          export OBJCOPY=$CLANG_DIR/bin/llvm-objcopy
          export OBJDUMP=$CLANG_DIR/bin/llvm-objdump
          export STRIP=$CLANG_DIR/bin/llvm-strip
          
          ARGS="O=out \
                ARCH=arm64 \
                CC=$CLANG_DIR/bin/clang \
                LD=$CLANG_DIR/bin/ld.lld \
                HOSTCC=gcc \
                HOSTCXX=g++ \
                HOSTLD=ld \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=aarch64-linux-gnu- \
                CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                LLVM=1 LLVM_IAS=1"

          # 2. ç”Ÿæˆé…ç½®
          mkdir -p out
          make $ARGS gki_defconfig
          
          # 3. æ ¸å¼¹çº§é…ç½®ä¿®æ­£
          # -d CONFIG_DEBUG_INFO_BTF: å…³é—­ BTF ç”Ÿæˆ (è¿™æ˜¯ fs/built-in.a åå´©æºƒçš„å…ƒå‡¶)
          # -d CONFIG_LTO...: å…³é—­ LTO é˜²æ­¢å†…å­˜æº¢å‡º
          # -d CONFIG_WERROR: é˜²æ­¢è­¦å‘Šå˜é”™è¯¯
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO \
            -d CONFIG_LTO_CLANG \
            -d CONFIG_LTO_CLANG_THIN \
            -d CONFIG_LTO_CLANG_FULL \
            -d CONFIG_THINLTO \
            -d CONFIG_DEBUG_INFO_BTF \
            -d CONFIG_DEBUG_INFO_DWARF4
            
          # 4. æœ€ç»ˆç¼–è¯‘ (V=1 å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œä»¥ä¾¿åœ¨å‡ºé”™æ—¶ä¸å†åªæ˜¾ç¤º Error 2)
          make -j$(nproc) $ARGS V=1 2>&1 | tee build_log.txt || (tail -n 200 build_log.txt && exit 1)

      - name: ğŸ“¦ [7/9] AnyKernel3 å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          cd ak3
          sed -i 's/device.name1=/device.name1=Phantom-Ultimate-Fix/g' anykernel.sh
          rm -rf .git
          zip -r9 ../Phantom-Kernel-Ultimate-Release.zip *
          
      - name: ğŸ“¤ [8/9] å‘å¸ƒæˆæœ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Result
          path: Phantom-Kernel-Ultimate-Release.zip