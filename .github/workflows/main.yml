# ==============================================================================
# ä¸€åŠ å¹³æ¿ Pro (sm8650) GKI 6.1 å†…æ ¸ç¼–è¯‘å·¥ä½œæµ
# ==============================================================================

name: Build GKI 6.1 Kernel for OnePlus Pad Pro (sm8650)

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel version'
        required: true
        default: '6.1.0'
        type: string
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options: [release, debug]
      enable_phantom:
        description: 'Enable Phantom scheduler'
        required: true
        default: true
        type: boolean
      enable_gpu_lock:
        description: 'Enable GPU frequency lock'
        required: true
        default: true
        type: boolean
      enable_bbg_guard:
        description: 'Enable BBG storage guard'
        required: true
        default: true
        type: boolean
      enable_bbrv3:
        description: 'Enable BBRv3 TCP congestion control'
        required: true
        default: true
        type: boolean

  push:
    branches: [main]
    paths: ['kernel/**', '.github/workflows/**']

env:
  KERNEL_SRC_DIR: '${{ github.workspace }}/kernel'
  ANY_KERNEL_DIR: '${{ github.workspace }}/anykernel3'
  OUTPUT_DIR: '${{ github.workspace }}/output'
  CCACHE_DIR: '${{ github.workspace }}/.ccache'
  ARCH: 'arm64'
  CROSS_COMPILE: 'aarch64-linux-gnu-'
  DEFCONFIG: 'vendor/sm8650-perf_defconfig'
  DEVICE_NAME: 'OnePlusPadPro'
  KERNEL_VERSION: '${{ github.event.inputs.kernel_version || '6.1.0' }}'
  MAKE_JOBS: '2'
  CCACHE_SIZE: '5G'

jobs:
  build-kernel:
    name: 'Build GKI 6.1 Kernel'
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
      # ========================================================================
      # æ­¥éª¤ 1-2: æ£€å‡ºä»£ç 
      # ========================================================================
      - name: 'ðŸ”§ æ­¥éª¤ 1: æ£€å‡ºå†…æ ¸æºç '
        uses: actions/checkout@v4
        with:
          path: kernel
          submodules: recursive

      - name: 'ðŸ”§ æ­¥éª¤ 2: æ£€å‡ºAnyKernel3'
        uses: actions/checkout@v4
        with:
          repository: osm0sis/AnyKernel3
          path: anykernel3
          ref: master

      # ========================================================================
      # æ­¥éª¤ 3: çŽ¯å¢ƒé…ç½®
      # ========================================================================
      - name: 'ðŸ”§ æ­¥éª¤ 3: é…ç½®çŽ¯å¢ƒ'
        shell: bash
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "è®¾å¤‡: ${{ env.DEVICE_NAME }}"
          echo "å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}"

      # ========================================================================
      # æ­¥éª¤ 4: æ¸…ç†ç£ç›˜
      # ========================================================================
      - name: 'ðŸ§¹ æ­¥éª¤ 4: æ¸…ç†ç£ç›˜'
        shell: bash
        run: |
          sudo apt-get clean
          sudo apt-get autoclean
          sudo apt-get autoremove -y
          sudo rm -rf /tmp/*
          df -h /

      # ========================================================================
      # æ­¥éª¤ 5: å®‰è£…ä¾èµ–
      # ========================================================================
      - name: 'ðŸ“¦ æ­¥éª¤ 5: å®‰è£…ä¾èµ–'
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential libncurses-dev libssl-dev libelf-dev \
            bison flex bc kmod cpio git wget curl tar xz-utils \
            unzip rsync python3 python3-pip ccache \
            gcc-13 g++-13 gcc-13-aarch64-linux-gnu g++-13-aarch64-linux-gnu

          wget https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.0/clang+llvm-18.1.0-x86_64-linux-gnu-ubuntu-22.04.tar.xz
          tar -xf clang+llvm-18.1.0-x86_64-linux-gnu-ubuntu-22.04.tar.xz
          sudo cp -r clang+llvm-18.1.0-x86_64-linux-gnu-ubuntu-22.04/* /usr/local/
          rm -rf clang+llvm-18.1.0-x86_64-linux-gnu-ubuntu-22.04*

          ccache --set-config=max_size=${{ env.CCACHE_SIZE }}
          ccache --set-config=compression=true

      # ========================================================================
      # æ­¥éª¤ 6: é…ç½®ccache
      # ========================================================================
      - name: 'âš¡ æ­¥éª¤ 6: é…ç½®ccache'
        shell: bash
        run: |
          ccache -z
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      # ========================================================================
      # æ­¥éª¤ 7: è¿›å…¥å†…æ ¸ç›®å½•
      # ========================================================================
      - name: 'ðŸ“ æ­¥éª¤ 7: è¿›å…¥å†…æ ¸ç›®å½•'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          ls -la

      # ========================================================================
      # æ­¥éª¤ 8: æ¸…ç†ç¼–è¯‘äº§ç‰©
      # ========================================================================
      - name: 'ðŸ§¹ æ­¥éª¤ 8: æ¸…ç†ç¼–è¯‘äº§ç‰©'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          make ARCH=${{ env.ARCH }} clean
          make ARCH=${{ env.ARCH }} mrproper
          rm -rf out/ .output/ .config .config.old

      # ========================================================================
      # æ­¥éª¤ 9: Error 2ä¿®å¤
      # ========================================================================
      - name: 'ðŸ”§ æ­¥éª¤ 9: Error 2ä¿®å¤'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          DEFCONFIG_PATH="arch/${{ env.ARCH }}/configs/${{ env.DEFCONFIG }}"
          cp "$DEFCONFIG_PATH" "${DEFCONFIG_PATH}.backup"
          
          sed -i '/CONFIG_LTO_CLANG_FULL/d' "$DEFCONFIG_PATH"
          sed -i '/CONFIG_LTO_CLANG_THIN/d' "$DEFCONFIG_PATH"
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' "$DEFCONFIG_PATH"
          
          echo "# Error 2ä¿®å¤é…ç½®" >> "$DEFCONFIG_PATH"
          echo "CONFIG_LTO_CLANG_FULL=n" >> "$DEFCONFIG_PATH"
          echo "CONFIG_LTO_CLANG_THIN=n" >> "$DEFCONFIG_PATH"
          echo "CONFIG_DEBUG_INFO_BTF=n" >> "$DEFCONFIG_PATH"
          echo "CONFIG_DEBUG_INFO=n" >> "$DEFCONFIG_PATH"
          echo "CONFIG_DEBUG_INFO_REDUCED=y" >> "$DEFCONFIG_PATH"

      # ========================================================================
      # æ­¥éª¤ 10: æ³¨å…¥Phantomè°ƒåº¦å™¨
      # ========================================================================
      - name: 'âš¡ æ­¥éª¤ 10: æ³¨å…¥Phantomè°ƒåº¦å™¨'
        if: ${{ github.event.inputs.enable_phantom || true }}
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          PHANTOM_DIR="kernel/sched/phantom"
          mkdir -p "$PHANTOM_DIR"
          
          cat > "$PHANTOM_DIR/phantom.c" << 'PHANTOM_EOF'
#include <linux/sched.h>
#include <linux/cpumask.h>

#define PHANTOM_X4_CORE_ID 7

struct phantom_scheduler {
	bool enabled;
	spinlock_t lock;
};

static struct phantom_scheduler phantom_sched;

static void phantom_migrate_to_x4(struct task_struct *p)
{
	cpumask_t x4_mask;
	if (!p) return;
	cpumask_clear(&x4_mask);
	cpumask_set_cpu(PHANTOM_X4_CORE_ID, &x4_mask);
	set_cpus_allowed_ptr(p, &x4_mask);
}

static void phantom_boost_priority(struct task_struct *p, u32 boost)
{
	int old_prio = p->prio;
	int new_prio = old_prio - boost;
	if (new_prio < 110) new_prio = 110;
	if (new_prio > 130) new_prio = 130;
	if (new_prio != old_prio) set_user_nice(p, new_prio);
}

void phantom_schedule_hook(struct task_struct *prev, struct task_struct *next)
{
	if (!next) return;
	const char *comm = next->comm;
	if (strstr(comm, "render") || strstr(comm, "gpu") || 
	    strstr(comm, "SurfaceFlinger")) {
		phantom_migrate_to_x4(next);
		phantom_boost_priority(next, 10);
	}
}

EXPORT_SYMBOL(phantom_schedule_hook);

static int __init phantom_scheduler_init(void)
{
	spin_lock_init(&phantom_sched.lock);
	phantom_sched.enabled = true;
	pr_info("Phantom Scheduler initialized\n");
	return 0;
}

module_init(phantom_scheduler_init);
MODULE_LICENSE("GPL v2");
PHANTOM_EOF

          cat > "$PHANTOM_DIR/Makefile" << 'EOF'
obj-$(CONFIG_PHANTOM_SCHEDULER) += phantom.o
EOF

      # ========================================================================
      # æ­¥éª¤ 11: GPUé¢‘çŽ‡åŠ å›º
      # ========================================================================
      - name: 'ðŸŽ® æ­¥éª¤ 11: GPUé¢‘çŽ‡åŠ å›º'
        if: ${{ github.event.inputs.enable_gpu_lock || true }}
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          GPU_PATH="drivers/gpu/msm/"
          mkdir -p "$GPU_PATH"
          
          cat > "${GPU_PATH}/gpu_freq_lock.c" << 'GPU_EOF'
#include <linux/module.h>
#include <linux/devfreq.h>

#define ADRENO_750_MIN_FREQ 267000000

struct gpu_freq_lock {
	unsigned long locked_freq;
	bool enabled;
};

static struct gpu_freq_lock gpu_lock;

static int gpu_target(struct device *dev, unsigned long *freq, u32 flags)
{
	if (gpu_lock.enabled && *freq < gpu_lock.locked_freq) {
		*freq = gpu_lock.locked_freq;
	}
	return 0;
}

static struct devfreq_dev_profile gpu_profile = {
	.target = gpu_target,
};

static int gpu_freq_lock_probe(struct platform_device *pdev)
{
	gpu_lock.locked_freq = ADRENO_750_MIN_FREQ;
	gpu_lock.enabled = true;
	dev_info(&pdev->dev, "GPUé¢‘çŽ‡é”å®š: %lu Hz\n", gpu_lock.locked_freq);
	return 0;
}

static struct platform_driver gpu_freq_lock_driver = {
	.probe = gpu_freq_lock_probe,
	.driver = { .name = "gpu-freq-lock" },
};

module_platform_driver(gpu_freq_lock_driver);
MODULE_LICENSE("GPL v2");
GPU_EOF

      # ========================================================================
      # æ­¥éª¤ 12: å­˜å‚¨å®ˆæŠ¤
      # ========================================================================
      - name: 'ðŸ’¾ æ­¥éª¤ 12: å­˜å‚¨å®ˆæŠ¤'
        if: ${{ github.event.inputs.enable_bbg_guard || true }}
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          MMC_DIR="drivers/mmc/core/"
          mkdir -p "$MMC_DIR"
          
          cat > "${MMC_DIR}/bbg_guard.c" << 'BBG_EOF'
#include <linux/mmc/core.h>
#include <linux/blkdev.h>

#define REQ_OP_SECURE_ERASE 0x11

static bool bbg_guard_enabled = true;

static bool is_dangerous_erase(struct request *req)
{
	if (!req) return false;
	if (req_op(req) == REQ_OP_SECURE_ERASE) {
		pr_warn("BBG Guard: é˜»æ­¢å®‰å…¨æ“¦é™¤\n");
		return true;
	}
	return false;
}

int bbg_guard_prep_req(struct mmc_host *host, struct request *req)
{
	if (!bbg_guard_enabled || !req) return 0;
	if (is_dangerous_erase(req)) {
		pr_err("BBG Guard: å·²é˜»æ­¢å±é™©æ“ä½œ\n");
		return -EPERM;
	}
	return 0;
}

EXPORT_SYMBOL(bbg_guard_prep_req);

static int __init bbg_guard_init(void)
{
	pr_info("BBG Storage Guard å·²åŠ è½½\n");
	return 0;
}

module_init(bbg_guard_init);
MODULE_LICENSE("GPL v2");
BBG_EOF

      # ========================================================================
      # æ­¥éª¤ 13: BBRv3ç½‘ç»œå¢žå¼º
      # ========================================================================
      - name: 'ðŸŒ æ­¥éª¤ 13: BBRv3ç½‘ç»œå¢žå¼º'
        if: ${{ github.event.inputs.enable_bbrv3 || true }}
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          BBR_DIR="net/ipv4/bbrv3/"
          mkdir -p "$BBR_DIR"
          
          cat > "$BBR_DIR/bbr.c" << 'BBR_EOF'
#include <net/tcp.h>

struct bbr {
	u32 bw;
	u32 min_rtt;
};

static void bbr_init(struct sock *sk)
{
	struct tcp_sock *tp = tcp_sk(sk);
	struct bbr *bbr = inet_csk_ca(sk);
	bbr->bw = 0;
	bbr->min_rtt = 0x7fffffff;
	tp->snd_cwnd = 10 * tp->mss_cache;
}

static void bbr_cong_avoid(struct sock *sk, u32 ack, u32 acked)
{
	struct tcp_sock *tp = tcp_sk(sk);
	if (tp->snd_cwnd <= tp->snd_ssthresh) {
		tcp_slow_start(tp, acked);
	} else {
		u32 delta = tp->snd_cwnd_cnt + acked;
		if (delta >= tp->snd_cwnd) {
			tp->snd_cwnd++;
			tp->snd_cwnd_cnt = 0;
		} else {
			tp->snd_cwnd_cnt = delta;
		}
	}
}

static struct tcp_congestion_ops tcp_bbr_cong_ops = {
	.init = bbr_init,
	.cong_avoid = bbr_cong_avoid,
	.owner = THIS_MODULE,
	.name = "bbr",
};

static int __init bbr_register(void)
{
	return tcp_register_congestion_control(&tcp_bbr_cong_ops);
}

static void __exit bbr_unregister(void)
{
	tcp_unregister_congestion_control(&tcp_bbr_cong_ops);
}

module_init(bbr_register);
module_exit(bbr_unregister);
MODULE_LICENSE("GPL v2");
BBR_EOF

          cat > "$BBR_DIR/Makefile" << 'EOF'
obj-$(CONFIG_TCP_CONG_BBR) += bbr.o
EOF

      # ========================================================================
      # æ­¥éª¤ 14: é…ç½®å†…æ ¸
      # ========================================================================
      - name: 'âš™ï¸ æ­¥éª¤ 14: é…ç½®å†…æ ¸'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          export ARCH=${{ env.ARCH }}
          export CROSS_COMPILE=${{ env.CROSS_COMPILE }}
          
          make ${{ env.DEFCONFIG }}
          
          echo "CONFIG_PHANTOM_SCHEDULER=y" >> .config
          echo "CONFIG_GPU_FREQ_LOCK=y" >> .config
          echo "CONFIG_BBG_GUARD=y" >> .config
          echo "CONFIG_TCP_CONG_BBR=y" >> .config
          echo "CONFIG_CCACHE=y" >> .config
          
          sed -i 's/CONFIG_LOCALVERSION=".*"/CONFIG_LOCALVERSION=""/g' .config
          sed -i '/CONFIG_IKCONFIG/d' .config
          sed -i '/CONFIG_IKCONFIG_PROC/d' .config

      # ========================================================================
      # æ­¥éª¤ 15: ç¼–è¯‘å†…æ ¸
      # ========================================================================
      - name: 'ðŸ”¨ æ­¥éª¤ 15: ç¼–è¯‘å†…æ ¸'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          export ARCH=${{ env.ARCH }}
          export CROSS_COMPILE=${{ env.CROSS_COMPILE }}
          export CC="ccache clang"
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          time make -j${{ env.MAKE_JOBS }} \
            CC="ccache clang" \
            LD=ld.lld \
            AR=llvm-ar
            
          if [ -f "arch/${{ env.ARCH }}/boot/Image.gz" ]; then
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ"
            ls -lh "arch/${{ env.ARCH }}/boot/Image.gz"
          else
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      # ========================================================================
      # æ­¥éª¤ 16: ç”Ÿæˆæ¨¡å—
      # ========================================================================
      - name: 'ðŸ“¦ æ­¥éª¤ 16: ç”Ÿæˆæ¨¡å—'
        shell: bash
        run: |
          cd ${{ env.KERNEL_SRC_DIR }}
          export ARCH=${{ env.ARCH }}
          export CROSS_COMPILE=${{ env.CROSS_COMPILE }}
          
          make -j${{ env.MAKE_JOBS }} modules
          
          MODULES_DIR="${{ env.OUTPUT_DIR }}/modules"
          mkdir -p "$MODULES_DIR"
          make INSTALL_MOD_PATH="$MODULES_DIR" modules_install

      # ========================================================================
      # æ­¥éª¤ 17: å‡†å¤‡AnyKernel3
      # ========================================================================
      - name: 'ðŸ“ æ­¥éª¤ 17: å‡†å¤‡AnyKernel3'
        shell: bash
        run: |
          cd ${{ env.ANY_KERNEL_DIR }}
          rm -rf zImage modules patch *.zip
          
          cp "${{ env.KERNEL_SRC_DIR }}/arch/${{ env.ARCH }}/boot/Image.gz" .
          
          mkdir -p modules
          cp -r "${{ env.OUTPUT_DIR }}/modules/lib/modules/"* modules/ 2>/dev/null || true
          
          cat > anykernel.sh << 'AK_EOF'
#!/bin/bash
properties() {
kernel.string=Operit Kernel
do.devicecheck=1
device.name1=OnePlusPadPro
}

dump_boot() {
  ui_print "Operit Kernel for OnePlus Pad Pro"
  ui_print "Version: ${{ env.KERNEL_VERSION }}"
  
  if [ "$(getprop ro.product.device)" != "opal" ]; then
    ui_print "é”™è¯¯: ä¸æ”¯æŒçš„è®¾å¤‡"
    abort
  fi
  
  dd if=/dev/block/bootdevice/by-name/boot of=/tmp/backup-boot.img
}

dump_boot
write_boot
AK_EOF

      # ========================================================================
      # æ­¥éª¤ 18: åˆ›å»ºåˆ·æœºåŒ…
      # ========================================================================
      - name: 'ðŸ“¦ æ­¥éª¤ 18: åˆ›å»ºåˆ·æœºåŒ…'
        shell: bash
        run: |
          cd ${{ env.ANY_KERNEL_DIR }}
          BUILD_DATE=$(date +%Y%m%d-%H%M%S)
          ZIP_NAME="Operit-Kernel-${{ env.DEVICE_NAME }}-${{ env.KERNEL_VERSION }}-$BUILD_DATE.zip"
          
          zip -r9 "$ZIP_NAME" . -x ".git/*" "*.gitignore"
          mv "$ZIP_NAME" "${{ env.OUTPUT_DIR }}/"
          
          echo "âœ… åˆ·æœºåŒ…åˆ›å»ºå®Œæˆ"
          ls -lh "${{ env.OUTPUT_DIR }}/$ZIP_NAME"

      # ========================================================================
      # æ­¥éª¤ 19: ç”Ÿæˆç»Ÿè®¡
      # ========================================================================
      - name: 'ðŸ“Š æ­¥éª¤ 19: ç”Ÿæˆç»Ÿè®¡'
        shell: bash
        run: |
          ccache -s
          echo "ç¼–è¯‘å®Œæˆæ—¶é—´: $(date)"
          echo "è¾“å‡ºç›®å½•å†…å®¹:"
          ls -la ${{ env.OUTPUT_DIR }}

      # ========================================================================
      # æ­¥éª¤ 20: ä¸Šä¼ äº§ç‰©
      # ========================================================================
      - name: 'ðŸ“¤ æ­¥éª¤ 20: ä¸Šä¼ äº§ç‰©'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ env.KERNEL_VERSION }}
          path: |
            ${{ env.OUTPUT_DIR }}/*
            ${{ env.KERNEL_SRC_DIR }}/.config
          retention-days: 7

      # ========================================================================
      # æ­¥éª¤ 21: å®Œæˆé€šçŸ¥
      # ========================================================================
      - name: 'âœ… æ­¥éª¤ 21: å®Œæˆé€šçŸ¥'
        if: success()
        shell: bash
        run: |
          echo "========================================"
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
          echo "è®¾å¤‡: ${{ env.DEVICE_NAME }}"
          echo "ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}"
          echo "æ—¶é—´: $(date)"
          echo "========================================"