name: Phantom Kernel Ultimate x SM8650 No-Root
on:
  workflow_dispatch:
    inputs:
      better_net:
        description: 'æ˜¯å¦å¯ç”¨ BBRv3 + BPF ç½‘ç»œåŠ é€Ÿå¼•æ“'
        required: true
        default: true
        type: boolean
      lz4_enable:
        description: 'æ˜¯å¦å‡çº§ LZ4 1.10 & Zstd 1.5.7 å‹ç¼©ç®—æ³•'
        required: true
        default: true
        type: boolean
      gpu_boost:
        description: 'æ˜¯å¦å¯ç”¨éªé¾™ 8G3 GPU æ¿€è¿›è°ƒåº¦'
        required: true
        default: true
        type: boolean
      kernel_suffix:
        description: 'è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬åç¼€'
        required: false
        default: 'Phantom-Performance'

env:
  ANDROID_VERSION: "15"
  KERNEL_VERSION: "6.1"
  KERNEL_NAME: "Phantom-Kernel"
  CCACHE_DIR: "/home/runner/.ccache_6.1_sm8650"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ [Step 1] è™šæ‹Ÿæœºç¯å¢ƒæ·±åº¦ç‰©ç†æ¸…ç©º (é‡Šæ”¾æœ€å¤§å¯ç”¨ç£ç›˜ç©ºé—´)
        run: |
          echo "æ­£åœ¨æ‰§è¡Œç³»ç»Ÿçº§æ¸…ç†ï¼Œä¸º sm8650 åºå¤§çš„å†…æ ¸æºç é¢„ç•™ç©ºé—´..."
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "ç£ç›˜ç©ºé—´æ¸…ç†å®Œæˆï¼Œå½“å‰å‰©ä½™ï¼š"
          df -h

      - name: ğŸš€ [Step 2] å·¥ä¸šçº§ç¼–è¯‘å·¥å…·é“¾ä¸ä¾èµ–éƒ¨ç½²
        run: |
          echo "æ­£åœ¨å®‰è£…ç¼–è¯‘ 6.1 å†…æ ¸æ‰€éœ€çš„å…¨éƒ¨åº•å±‚ç»„ä»¶..."
          sudo apt-get update
          sudo apt-mark hold firefox libc-bin
          sudo apt purge man-db
          sudo rm -rf /var/lib/man-db/auto-update
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python-is-python3 curl zip git ccache aria2 pahole dwarves \
            kmod cpio expect rsync libncurses-dev binutils-aarch64-linux-gnu
          echo "åº•å±‚ç¼–è¯‘ç¯å¢ƒå°±ç»ªã€‚"

      - name: ğŸ“¥ [Step 3] SM8650 æºç ä¸ LLVM-Clang 20 é«˜é€Ÿåˆå§‹åŒ–
        run: |
          rm -rf kernel_workspace && mkdir kernel_workspace && cd kernel_workspace
          
          echo "å¯åŠ¨å¹¶è¡Œä¸‹è½½ä»»åŠ¡ï¼šå†…æ ¸æºç  + æ——èˆ°ç¼–è¯‘å™¨..."
          # SM8650 ä¸€åŠ å¹³æ¿Pro/ä¸€åŠ 12 ä¸“å± 6.1.118 æºç 
          aria2c -s16 -x16 -k1M https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip -o common.zip && unzip -q common.zip && mv android_kernel_common_oneplus_sm8650-* common && rm common.zip &
          
          # LLVM-Clang 20 é«˜æ€§èƒ½å·¥å…·é“¾ (é’ˆå¯¹ 8G3 æŒ‡ä»¤é›†ä¼˜åŒ–)
          mkdir -p clang20 && aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip -o clang.zip && unzip -q clang.zip -d clang20 && rm clang.zip &
          
          # æ ¸å¿ƒæ„å»ºé…å¥—å·¥å…·
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/build-tools.zip -o build-tools.zip && unzip -q build-tools.zip && rm build-tools.zip &
          
          wait
          echo "æ‰€æœ‰ç¼–è¯‘å‰å¯¼èµ„æºå·²å‡†å¤‡å°±ç»ªã€‚"

      - name: ğŸ’‰ [Step 4] æ ¸å¿ƒé‡æ„ Aï¼šPhantom è°ƒåº¦å™¨æ³¨å…¥ (éªé¾™ 8G3 å¹³æ¿ä¸“é¡¹ä¼˜åŒ–)
        run: |
          cd kernel_workspace/common
          echo "æ­£åœ¨æ³¨å…¥é’ˆå¯¹ 8G3 æ¶æ„çš„æ¿€è¿›è°ƒåº¦ç®—æ³•..."
          # å»ºç«‹ä¸“æœ‰çš„è°ƒåº¦æ³¨å…¥æ–‡ä»¶
          cat <<EOF > kernel/sched/phantom_sm8650_logic.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/string.h>
          
          /* Phantom è°ƒåº¦æ ¸å¿ƒé€»è¾‘ï¼šé’ˆå¯¹ 144Hz å¹³æ¿å¤§å±è¿›è¡Œæ¸²æŸ“æµä¼˜åŒ– */
          void apply_phantom_perf_logic(struct task_struct *p) {
              if (!p || !p->comm) return;
              /* è¯†åˆ«å…³é”®æ¸²æŸ“è¿›ç¨‹ï¼šSurfaceFlinger, RenderThread, ç³»ç»ŸæœåŠ¡ */
              if (strstr(p->comm, "RenderThread") || strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "system_server") || strstr(p->comm, "composer") ||
                  strstr(p->comm, "hwui")) {
                  p->static_prio = 95;      /* æå‡é™æ€ä¼˜å…ˆçº§è‡³æé«˜æ°´å¹³ */
                  p->sched_boost = 1;       /* å¼€å¯è°ƒåº¦åŠ é€Ÿæ ‡å¿—ä½ */
                  #ifdef CONFIG_SMP
                  /* å¼ºåˆ¶å°†æ¸²æŸ“ä¸»ä»»åŠ¡é”å®šè‡³éªé¾™ 8G3 çš„ X4 è¶…å¤§æ ¸ (CPU 7) ä¸ A720 å¤§æ ¸ (CPU 4-6) */
                  cpumask_t tablet_mask; 
                  cpumask_clear(&tablet_mask);
                  for(int i=4; i<=7; i++) cpumask_set_cpu(i, &tablet_mask);
                  set_cpus_allowed_ptr(p, &tablet_mask);
                  #endif
              }
          }
          EOF
          echo "obj-y += phantom_sm8650_logic.o" >> kernel/sched/Makefile
          
          # ä¸‰æ˜Ÿ SSG è°ƒé€Ÿå™¨ç®—æ³•æ³¨å…¥ (è§£å†³ UFS 4.0 çš„ I/O å“åº”å»¶è¿Ÿ)
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_engine.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>
          static int phantom_ssg_target_freq(struct cpufreq_policy *p, unsigned int target_f, unsigned int rel) {
              /* SSG æ ¸å¿ƒé€»è¾‘ï¼šè´Ÿè½½æ„Ÿåº”é˜ˆå€¼ç”±åŸç”Ÿçš„ 60% å‹ä½è‡³ 25% */
              if (target_f > (p->max * 25 / 100)) 
                  return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              return __cpufreq_driver_target(p, target_f, rel);
          }
          static struct cpufreq_governor p_ssg_gov = { 
              .name = "samsung_ssg", 
              .target = phantom_ssg_target_freq, 
              .owner = THIS_MODULE 
          };
          static int __init p_ssg_reg(void) { return cpufreq_register_governor(&p_ssg_gov); }
          fs_initcall(p_ssg_reg);
          EOF
          echo "obj-y += ssg_engine.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

      - name: ğŸ›¡ï¸ [Step 5] æ ¸å¿ƒé‡æ„ Bï¼šBBG Guard å†…æ ¸çº§å­˜å‚¨ä¿æŠ¤æ³¨å…¥
        run: |
          cd kernel_workspace/common
          echo "æ³¨å…¥å­˜å‚¨å®‰å…¨ç½‘å…³ï¼Œé˜²æ­¢æ„å¤–æ ¼æœº..."
          cat <<EOF > drivers/mmc/core/phantom_guard.c
          #include <linux/blkdev.h>
          /* æ ¸å¿ƒæ‹¦æˆªé€»è¾‘ï¼šåœ¨ MMC é©±åŠ¨å±‚ç›´æ¥è¿‡æ»¤å±é™©çš„æŠ¹é™¤æŒ‡ä»¤ */
          int phantom_verify_io_safety(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_emerg("Phantom-Guard: CRITICAL BLOCK! Illegal wipe attempt detected on mmcblk0.\n");
                      return 1; /* è¿”å› 1 è¡¨ç¤ºè¯¥è¯·æ±‚ä¸å®‰å…¨ */
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_guard.o" >> drivers/mmc/core/Makefile
          # ä¿®æ”¹ mmc ä¸»é©±åŠ¨é€»è¾‘ï¼Œåœ¨æŒ‡ä»¤ä¸‹å‘ç‚¹æ’å…¥æ‹¦æˆªç‚¹
          sed -i '/mmc_blk_issue_discard_rq/a if (phantom_verify_io_safety(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: âš¡ [Step 6] æ ¸å¿ƒé‡æ„ Cï¼šGPU æ¿€è¿›é¢‘ç‡ä¿æŠ¤ (éªé¾™ 8G3 ä¸“é¡¹)
        if: inputs.gpu_boost
        run: |
          cd kernel_workspace/common
          echo "æ³¨å…¥ GPU é¢‘ç‡é”å®šé€»è¾‘ï¼Œé˜²æ­¢å¹³æ¿åœ¨é«˜è´Ÿè·ä¸‹è·³é¢‘..."
          cat <<EOF > drivers/gpu/msm/phantom_gpu_boost.c
          #include <linux/module.h>
          /* é’ˆå¯¹ Adreno 750 çš„æ¿€è¿›å‡é¢‘é€»è¾‘ */
          void phantom_gpu_tune(unsigned int *freq) {
              /* å¦‚æœè¯·æ±‚é¢‘ç‡ä½äº 400MHzï¼Œå¼ºåˆ¶æ‹‰å‡è‡³æœ€ä½ 600MHz ä¿è¯ UI æµç•… */
              if (*freq < 400000000) *freq = 600000000;
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> drivers/gpu/msm/Makefile

      - name: ğŸ”‹ [Step 7] å†…å­˜ä¼˜åŒ–è¡¥ä¸å‡çº§ï¼šLZ4 1.10.0 & Zstd 1.5.7
        if: inputs.lz4_enable
        run: |
          cd kernel_workspace
          echo "æ­£åœ¨åŒæ­¥å¹¶æ³¨å…¥æœ€æ–°ç‰ˆå†…å­˜å‹ç¼©ç®—æ³•è¡¥ä¸..."
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git patch_source
          cp ./patch_source/zram_patch/001-lz4.patch ./common/
          cp ./patch_source/zram_patch/lz4armv8.S ./common/lib/
          cp ./patch_source/zram_patch/002-zstd.patch ./common/
          cd ./common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true
          echo "å†…å­˜ç®—æ³•è¡¥ä¸æ³¨å…¥å®Œæˆã€‚"

      - name: ğŸ“¡ [Step 8] ç½‘ç»œé€šä¿¡åè®®é‡å†™ï¼šBBRv3 å®˜æ–¹å¼•æ“
        if: inputs.better_net
        run: |
          cd kernel_workspace/common
          echo "æ­£åœ¨ç§»é™¤æ—§ç‰ˆ BBR å¹¶æ³¨å…¥ Google å®˜æ–¹ BBRv3 æºç ..."
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_repo
          cp ../bbr_repo/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          # é…ç½® Defconfig ä»¥æ”¯æŒæ–°çš„ç½‘ç»œåŠŸèƒ½
          echo "CONFIG_TCP_CONG_BBR=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_BPF_STREAM_PARSER=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_NETFILTER_XT_SET=y" >> ./arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_SET=y" >> ./arch/arm64/configs/gki_defconfig

      - name: ğŸ—ï¸ [Step 9] ç¼–è¯‘ç¯å¢ƒå‡†å¤‡ï¼šCcache é…ç½®ä¸ ABI æ¸…ç†
        run: |
          echo "æ­£åœ¨é…ç½®ç¼–è¯‘åŠ é€Ÿç¼“å­˜ä¸å†…æ ¸ç‰ˆæœ¬æ¸…ç†..."
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          cd kernel_workspace/common
          # ç‰©ç†å»é™¤ dirty åç¼€ï¼Œç¡®ä¿ç‰ˆæœ¬å·ç¾è§‚
          sed -i 's/ -dirty//g' ./scripts/setlocalversion
          # ç§»é™¤ GKI ABI é™åˆ¶ï¼Œå…è®¸æˆ‘ä»¬æ³¨å…¥çš„é©±åŠ¨æ­£å¸¸åŠ è½½
          rm ./android/abi_gki_protected_exports_* || true
          echo "Ccache ç›®å½•å‡†å¤‡å°±ç»ªã€‚"

      - name: ğŸ“¥ [Step 10] è½½å…¥æŒä¹…åŒ–ç¼–è¯‘ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-phantom-noroot-sm8650-${{ github.sha }}
          restore-keys: |
            ccache-phantom-noroot-sm8650-
            ccache-phantom-sm8650-

      - name: ğŸ› ï¸ [Step 11] ç”Ÿæˆæœ€ç»ˆå†…æ ¸é…ç½® (GKI Defconfig æ·±åº¦å®šåˆ¶)
        run: |
          cd kernel_workspace/common
          export CONF="arch/arm64/configs/gki_defconfig"
          echo "æ­£åœ¨æ ¹æ®è¾“å…¥å‚æ•°ä¿®æ”¹å†…æ ¸åŠŸèƒ½å¼€å…³..."
          
          # æè‡´æ€§èƒ½é…ç½®é¡¹
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> $CONF
          echo "CONFIG_SAMSUNG_SSG=y" >> $CONF
          echo "CONFIG_TMPFS_XATTR=y" >> $CONF
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONF
          echo "CONFIG_HEADERS_INSTALL=n" >> $CONF
          
          # é‡ç‚¹ï¼šå½»åº•ç¦ç”¨ LTO ä¸ CFI (è§£å†³ GitHub Actions çš„ Error 2 æº¢å‡ºé—®é¢˜)
          echo "æ­£åœ¨é’ˆå¯¹ 7GB è™šæ‹Ÿæœºå†…å­˜é™åˆ¶è¿›è¡Œç¼–è¯‘é™å‹..."
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          echo "CONFIG_LTO_NONE=y" >> $CONF
          echo "CONFIG_CFI_CLANG=n" >> $CONF
          # ç¦ç”¨è°ƒè¯•ä¿¡æ¯ç”Ÿæˆï¼Œæå¤§åœ°å‡å°‘ç£ç›˜å ç”¨
          sed -i 's/CONFIG_DEBUG_INFO_BTF=y/CONFIG_DEBUG_INFO_BTF=n/g' $CONF

      - name: ğŸ”¨ [Step 12] æ‰§è¡Œè‡ªåŠ¨åŒ–ç¼–è¯‘ (j2 å¹¶å‘ï¼šç¨³å¥é™æµæ¨¡å¼)
        run: |
          cd kernel_workspace/common
          # æ„å»ºå…¨é‡å·¥å…·é“¾è·¯å¾„
          export WORKDIR="$(pwd)"
          export PATH="$GITHUB_WORKSPACE/kernel_workspace/clang20/bin:$GITHUB_WORKSPACE/kernel_workspace/build-tools/bin:$PATH"
          
          # è®¾å®šå…¨å¥—äº¤å‰ç¼–è¯‘å‚æ•°
          ARGS="O=out ARCH=arm64 CC=\"ccache clang\" LD=ld.lld LLVM=1 LLVM_IAS=1 \
          CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu- HOSTCC=gcc HOSTCXX=g++"

          echo "æ¸…ç†æ—§çš„æ„å»ºæ ‘..."
          make ARCH=arm64 mrproper
          mkdir -p out
          
          echo "1. æ­£åœ¨ç”Ÿæˆå†…æ ¸åŸºç¡€é…ç½®..."
          make $ARGS gki_defconfig
          
          echo "2. æ­£åœ¨æ‰§è¡Œå†…æ ¸å…¨é‡ç¼–è¯‘ (æ­¤è¿‡ç¨‹å¤§çº¦éœ€è¦ 40-60 åˆ†é’Ÿ)..."
          # ä½¿ç”¨ -j2 ç¼–è¯‘ã€‚è™½ç„¶æ…¢ï¼Œä½†èƒ½ä¿è¯åœ¨ fs/ é“¾æ¥é˜¶æ®µä¸ä¼šå› ä¸ºå†…å­˜æº¢å‡ºæŠ¥ Error 2
          make -j2 $ARGS V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [Step 13] AnyKernel3 è‡ªåŠ¨åŒ–å¹³æ¿çº§å°è£…
        run: |
          echo "ç¼–è¯‘å®Œæˆï¼Œå¯åŠ¨é•œåƒæ‰“åŒ…æµç¨‹..."
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          # å¯»æ‰¾ç¼–è¯‘ç”Ÿæˆçš„ Image é•œåƒæ–‡ä»¶
          export IMAGE_PATH=$(find kernel_workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE_PATH" ]; then
            cp "$IMAGE_PATH" ak3/
            cd ak3
            # å¹³æ¿é€‚é…ï¼šä¿®æ”¹è®¾å¤‡åç§°è¯†åˆ«
            sed -i "s/device.name1=/device.name1=OnePlusPadPro/g" anykernel.sh
            sed -i "s/device.name2=/device.name2=OP5929L1/g" anykernel.sh
            zip -r9 ../Phantom-Performance-sm8650-NoRoot.zip *
            echo "æ‰“åŒ…æˆåŠŸï¼šPhantom-Performance-sm8650-NoRoot.zip"
          else
            echo "é”™è¯¯ï¼šImage é•œåƒæœªç”Ÿæˆï¼Œç¼–è¯‘æµç¨‹å¯èƒ½ä¸­é€”å´©æºƒã€‚"
            exit 1
          fi

      - name: ğŸ“¤ [Step 14] ä¸Šä¼ å†…æ ¸æˆå“ä¸ç¼–è¯‘æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-OnePlus-PadPro-Release
          path: |
            Phantom-Performance-sm8650-NoRoot.zip
            kernel_workspace/build_log.txt

      - name: ğŸ§¹ [Step 15] ç¼–è¯‘æ®‹ç•™æ¸…ç† (ä¼˜åŒ–ä¸‹æ¬¡ç¼“å­˜åŒæ­¥)
        if: always()
        run: |
          cd kernel_workspace/common
          make ARCH=arm64 clean
          rm -rf out/