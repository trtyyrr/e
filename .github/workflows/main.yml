name: Phantom Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ [Step 01] è™šæ‹Ÿæœºç£ç›˜ç©ºé—´æ·±åº¦é‡Šæ”¾
        run: |
          echo "==== ç³»ç»Ÿç¯å¢ƒè§„æ ¼æ£€æµ‹ ===="
          nproc && free -h && df -h /
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "æ¸…ç†åç©ºé—´æŠ¥å‘Šï¼š" && df -h /

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²å…¨å¥—äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python-is-python3 curl zip git ccache aria2 pahole dwarves \
            kmod cpio expect rsync libncurses-dev binutils-aarch64-linux-gnu \
            wget tar libarchive-tools

      - name: ğŸ“¥ [Step 03] åŒæ­¥ä¸€åŠ  sm8650 å®˜æ–¹å†…æ ¸æºç 
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½²å®šåˆ¶ Clang 20 (LLVM) ç¼–è¯‘å™¨
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip

      - name: ğŸ“¡ [Step 05] ç½‘ç»œæ‰©å±•ï¼šBBRv3 æºç åŒæ­¥ä¸æ³¨å…¥
        run: |
          cd workspace/common
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          # ä¿®æ”¹ Defconfig å¼€å¯é«˜æ€§èƒ½ç½‘ç»œ
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig
          {
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_NET_SCH_FQ_CODEL=y"
          } >> arch/arm64/configs/gki_defconfig

      - name: ğŸ’‰ [Step 06] è°ƒåº¦å™¨æ³¨å…¥ï¼šPhantom Engine (Cè¯­è¨€é€»è¾‘)
        run: |
          cd workspace/common
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          void apply_phantom_policy(struct task_struct *p) {
              if (p && p->comm && (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread"))) {
                  #ifdef CONFIG_SMP
                  cpumask_t ui_mask;
                  cpumask_clear(&ui_mask);
                  cpumask_set_cpu(7, &ui_mask);
                  set_cpus_allowed_ptr(p, &ui_mask);
                  p->static_prio = 98;
                  #endif
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] GPU è°ƒä¼˜ï¼šAdreno 750 é¢‘ç‡é”
        run: |
          cd workspace/common
          GPU_DIR=$(find . -maxdepth 5 -name "adreno_dispatch.c" | xargs dirname | head -n 1)
          [ -z "$GPU_DIR" ] && GPU_DIR="drivers/gpu/msm"
          mkdir -p "$GPU_DIR"
          cat <<'EOF' > "$GPU_DIR/phantom_gpu_boost.c"
          #include <linux/module.h>
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 400000000) *freq = 615000000;
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> "$GPU_DIR/Makefile"

      - name: ğŸ›¡ï¸ [Step 08] å­˜å‚¨å®‰å…¨é”ï¼šBBG Guard ç‰©ç†çº§æ‹¦æˆª
        run: |
          cd workspace/common
          cat <<'EOF' > drivers/mmc/core/phantom_guard.c
          #include <linux/blkdev.h>
          int check_phantom_guard(struct request *rq) {
              if (rq && rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  unsigned int op = req_op(rq);
                  if (op == 0x11 || op == 0x12) return 1;
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_guard.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (check_phantom_guard(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: ğŸ§¬ [Step 09] å†…å­˜ç®—æ³•ï¼šLZ4-Ultra & ZRAM æ€§èƒ½è¡¥ä¸
        run: |
          cd workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git p_repo
          cd common
          git apply -p1 < ../p_repo/zram_patch/001-lz4.patch || true
          cp ../p_repo/zram_patch/lz4armv8.S lib/ 2>/dev/null || echo "Skip optional ASM"

      - name: ğŸ’¾ [Step 10] IO ä¼˜åŒ–ï¼šBFQ è°ƒåº¦å™¨ä¸“é¡¹åŠ é€Ÿ
        run: |
          cd workspace/common
          # é’ˆå¯¹å¹³æ¿ UFS 4.0 çš„ IO ååä¼˜åŒ–
          echo "CONFIG_IOSCHED_BFQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_BFQ_GROUP_IOSCHED=y" >> arch/arm64/configs/gki_defconfig
          sed -i 's/CONFIG_DEFAULT_IOSCHED="mq-deadline"/CONFIG_DEFAULT_IOSCHED="bfq"/g' arch/arm64/configs/gki_defconfig

      - name: âš™ï¸ [Step 11] ç¨³å®šæ€§ä¿®æ­£ï¼šç¦ç”¨ LTO ä¸ BTF (è§£å†³ Error 2)
        run: |
          cd workspace/common
          CONF="arch/arm64/configs/gki_defconfig"
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          {
            echo "CONFIG_LTO_NONE=y"
            echo "CONFIG_CFI_CLANG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
          } >> $CONF
          sed -i 's/ -dirty//g' scripts/setlocalversion
          rm -f android/abi_gki_protected_exports_*

      - name: ğŸ“‚ [Step 12] Ccache æŒä¹…åŒ–ç¼“å­˜åŠ è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-ultimate-${{ github.sha }}
          restore-keys: ccache-sm8650-ultimate-

      - name: ğŸ—ï¸ [Step 13] æ ¸å¿ƒè‡ªæ£€ï¼šç‰©ç†æ ¡éªŒ C æ³¨å…¥å®Œæ•´æ€§
        run: |
          cd workspace/common
          echo "==== æ ¡éªŒæ³¨å…¥æ–‡ä»¶åˆ—è¡¨ ===="
          ls -l kernel/sched/phantom_core.c
          ls -l drivers/mmc/core/phantom_guard.c
          echo "æ ¡éªŒé€šè¿‡ï¼Œå‡†å¤‡è¿›å…¥ç¼–è¯‘é˜¶æ®µã€‚"

      - name: ğŸ—ï¸ [Step 14] å¯åŠ¨å…¨é‡è‡ªåŠ¨åŒ–ç¼–è¯‘ (ç¯å¢ƒå˜é‡è§£è€¦ç‰ˆ)
        run: |
          cd workspace/common
          # 1. æ³¨å…¥ç¼–è¯‘å™¨è·¯å¾„
          export PATH="${{ env.CLANG_ROOT }}/bin:$PATH"
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          # 2. æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ export å¼•å·å˜é‡ï¼Œä¸å†æ”¾å…¥ ARGS å­—ç¬¦ä¸²
          export ARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CC="ccache clang"
          
          # 3. å®šä¹‰è¾“å‡ºç›®å½•
          OUT_DIR="out"
          mkdir -p $OUT_DIR
          
          echo "ç”Ÿæˆå¹¶åŒæ­¥ .config..."
          make O=$OUT_DIR $ARCH gki_defconfig
          
          echo "å¯åŠ¨å†…æ ¸é“¾æ¥ (j2 å¹¶è¡Œé˜²æ­¢å†…å­˜æº¢å‡º)..."
          make -j2 O=$OUT_DIR $ARCH V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [Step 15] AnyKernel3 è‡ªåŠ¨åŒ–åˆ·æœºåŒ…åˆ¶ä½œ
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel-Ultimate.zip *
          else
            echo "è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶" && exit 1
          fi

      - name: ğŸ“¤ [Step 16] å‘å¸ƒæˆå“ä¸ç»Ÿè®¡æ€»ç»“
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Result
          path: |
            Phantom-Kernel-Ultimate.zip
            workspace/build_log.txt

      - name: ğŸ“Š [Step 17] Ccache æŠ¥å‘Š
        run: ccache -s