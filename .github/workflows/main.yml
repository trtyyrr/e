name: Phantom Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - ç‰©ç†æ»¡è¡€ä¿®æ­£ç‰ˆ

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šæè‡´ç¯å¢ƒåˆå§‹åŒ– (ç‰©ç†å±•å¼€)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] è™šæ‹Ÿæœºç£ç›˜ç©ºé—´æ·±åº¦é‡Šæ”¾ (ç‰©ç†å†—ä½™æ¸…ç†)
        run: |
          echo "==== [DEBUG] æ­£åœ¨å¯åŠ¨å¤§è§„æ¨¡ç©ºé—´å›æ”¶ä»»åŠ¡ ===="
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "==== [DEBUG] ç©ºé—´çŠ¶æ€ç»Ÿè®¡ ===="
          df -h

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²å·¥ä¸šçº§äº¤å‰ç¼–è¯‘ä¾èµ– (å…¨é‡è¡¥é½)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python3-dev python-is-python3 curl zip git ccache aria2 \
            pahole dwarves kmod cpio expect rsync libncurses-dev \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi \
            wget tar libarchive-tools lz4 liblz4-tool zstd libzstd-dev

      - name: ğŸ“¥ [Step 03] åŒæ­¥ä¸€åŠ  sm8650 æºç  (ç‰©ç†é“¾è·¯æ ¡éªŒ)
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½² LLVM-Clang 20 (é’ˆå¯¹ Cortex-X4 ç‰¹åŒ–ç‰ˆ)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šå†…æ ¸é€»è¾‘æ·±åº¦æ³¨å…¥ (è§£å†³è·¯å¾„å´©æºƒé—®é¢˜)
      # ========================================================================
      - name: ğŸ“¡ [Step 05] ç½‘ç»œåè®®æ ˆï¼šå®˜æ–¹ BBRv3 é€»è¾‘å…¨é‡é‡æ„
        run: |
          cd workspace/common
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig
          cat <<'EOF' >> arch/arm64/configs/gki_defconfig
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          CONFIG_BPF_SYSCALL=y
          EOF

      - name: ğŸ’‰ [Step 06] è°ƒåº¦å™¨å†…æ ¸çº§è¡¥ä¸ï¼šPhantom Engine æ»¡è¡€ç‰ˆ
        run: |
          cd workspace/common
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          void apply_phantom_policy(struct task_struct *p) {
              if (p && p->comm) {
                  if (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread")) {
                      cpumask_t ui_mask;
                      cpumask_clear(&ui_mask);
                      cpumask_set_cpu(7, &ui_mask);
                      if (p->nr_cpus_allowed > 1) set_cpus_allowed_ptr(p, &ui_mask);
                      p->static_prio = 95; 
                  }
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] GPU ä¸æ¸©æ§ï¼šAdreno 750 é¢‘ç‡é”ç‰©ç†æ³¨å…¥
        run: |
          cd workspace/common
          # ç‰©ç†å®šä½ï¼šä¸å†ä¾èµ– findï¼Œè€Œæ˜¯é€šè¿‡éå†å¯èƒ½è·¯å¾„
          POTENTIAL_PATHS="drivers/gpu/msm drivers/gpu/drm/msm techpack/display/drivers/gpu/drm/msm"
          TARGET_DIR=""
          for p in $POTENTIAL_PATHS; do
            if [ -d "$p" ]; then TARGET_DIR="$p"; break; fi
          done
          
          if [ -z "$TARGET_DIR" ]; then
            echo "æœªå‘ç°æ ‡å‡† GPU è·¯å¾„ï¼Œæ­£åœ¨åˆ›å»ºç‰©ç†æ³¨å…¥ç‚¹..."
            TARGET_DIR="drivers/gpu/phantom_kgsl"
            mkdir -p "$TARGET_DIR"
          fi
          
          cat <<'EOF' > "$TARGET_DIR/phantom_gpu_boost.c"
          #include <linux/module.h>
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 480000000) *freq = 615000000;
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> "$TARGET_DIR/Makefile"
          # å°†è¯¥ç›®å½•æŒ‚è½½å›ä¸» Makefile ä»¥ç¡®ä¿ç¼–è¯‘
          if [[ "$TARGET_DIR" == *"phantom_kgsl"* ]]; then
             echo "obj-y += phantom_kgsl/" >> drivers/gpu/Makefile
          fi

      - name: ğŸ§¬ [Step 08] å†…å­˜åŠ é€Ÿï¼šZRAM ä¸ LZ4-Ultra ç®—æ³•å¹³é“º
        run: |
          cd workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git p_repo
          cd common
          git apply -p1 < ../p_repo/zram_patch/001-lz4.patch || true
          cat <<'EOF' >> arch/arm64/configs/gki_defconfig
          CONFIG_ZRAM=y
          CONFIG_ZRAM_DEF_COMP_LZ4=y
          CONFIG_LZ4_COMPRESS=y
          EOF

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æ ¸å¿ƒå‚æ•°ä¸“é¡¹ (ç‰©ç†å±•å¼€ Polly ä¸ SM8650 ç‰¹åŒ–)
      # ========================================================================
      - name: âš™ï¸ [Step 09] ç¨³å®šæ€§ä¿®æ­£ï¼šç¦ç”¨ LTO ä¸ å†—ä½™ DTB å‰”é™¤
        run: |
          cd workspace/common
          sed -i '/sony/d' arch/arm64/boot/dts/qcom/Makefile || true
          CONF="arch/arm64/configs/gki_defconfig"
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          {
            echo "CONFIG_LTO_NONE=y"
            echo "CONFIG_CFI_CLANG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
            echo "CONFIG_HZ_1000=y"
            echo "CONFIG_SCHED_WALT=y"
          } >> $CONF
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $CONF
          sed -i 's/ -dirty//g' scripts/setlocalversion

      - name: ğŸ“‚ [Step 10] Ccache æŒä¹…åŒ–ç¼“å­˜åŠ è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-full-ä¿®æ­£-${{ github.sha }}
          restore-keys: ccache-sm8650-full-ä¿®æ­£-

      - name: ğŸ—ï¸ [Step 11] ç¯å¢ƒç‰©ç†å¯¹é½ (å…¨é‡è·¯å¾„å±•å¼€)
        run: |
          cd workspace/common
          mkdir -p out
          cp arch/arm64/configs/gki_defconfig out/.config
          echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 12] æ»¡è¡€ç¼–è¯‘æ‰§è¡Œï¼šClang 20 + Polly æ·±åº¦ä¼˜åŒ–
        run: |
          cd workspace/common
          # æè‡´ç‰¹åŒ–å‚æ•°å±•å¼€
          export KCFLAGS="-march=armv9.2-a+crypto+fp16+dotprod -mtune=neoverse-v2 \
            -mllvm -polly -mllvm -polly-ast-detect-unprofitable \
            -mllvm -polly-run-inliner -mllvm -polly-vectorizer=stripmine \
            -O3 -pipe"

          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CC="ccache clang"
          export LD=ld.lld

          echo "==== [PHASE A] åŒæ­¥é…ç½® ===="
          yes "" | make O=out ARCH=arm64 olddefconfig
          
          echo "==== [PHASE B] å¯åŠ¨å†…æ ¸ä¸»é•œåƒé“¾æ¥ (Image) ===="
          make -j2 O=out ARCH=arm64 V=1 Image 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šå…¨é‡å°è£…ä¸å‘å¸ƒ
      # ========================================================================
      - name: ğŸ“¦ [Step 13] AnyKernel3 æ»¡è¡€ç‰ˆåˆ·æœºåŒ…åˆ¶ä½œ
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel-SM8650-Ultra.zip *
          else
            echo "è‡´å‘½é”™è¯¯ï¼šImage æ–‡ä»¶ç¼ºå¤±" && exit 1
          fi

      - name: ğŸ“¤ [Step 14] å…¨é‡å‘å¸ƒæ„å»ºæˆæœ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release-Full
          path: |
            Phantom-Kernel-SM8650-Ultra.zip
            workspace/build_log.txt
            workspace/common/out/.config

      - name: ğŸ“Š [Step 15] ç¼–è¯‘ç»Ÿè®¡ä¸ Ccache çŠ¶æ€
        run: ccache -s