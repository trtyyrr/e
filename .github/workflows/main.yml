name: Phantom Kernel Ultimate Final CI
on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
    steps:
      - name: ğŸ§¹ [1/10] æ·±åº¦æ¸…ç†ç³»ç»Ÿç¯å¢ƒ (é‡Šæ”¾æœ€å¤§ç£ç›˜ç©ºé—´)
        run: |
          echo "Starting deep cleanup..."
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          # è¿›ä¸€æ­¥æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "Current Disk Usage:"
          df -h

      - name: ğŸš€ [2/10] ç¼–è¯‘ç¯å¢ƒå…¨é‡éƒ¨ç½²
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang lld llvm python3 curl zip git libncurses-dev \
          gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi pahole dwarves \
          kmod cpio expect rsync
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ [3/10] è·å– Android GKI 5.10 æºç  (å«é‡ç½®é€»è¾‘)
        run: |
          # è§£å†³ Source tree is not clean çš„ç‰©ç†æ‰‹æ®µ
          [ -d "kernel" ] && rm -rf kernel
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel

      - name: ğŸ“¡ [4/10] è·å– Google å®˜æ–¹ BBRv3 é€»è¾‘åŒ…
        run: |
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3

      - name: ğŸ› ï¸ [5/10] éƒ¨ç½²é«˜æ€§èƒ½ Proton Clang å·¥å…·é“¾
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ [6/10] æ ¸å¿ƒæ¨¡å—å…¨é‡æ·±åº¦æ³¨å…¥ (æ ¸å¿ƒé€»è¾‘å±‚)
        run: |
          cd kernel
          
          # === [A. ç½‘ç»œåè®®æ ˆ: BBRv3 å®˜æ–¹å¼•æ“å…¨é›†æˆ] ===
          echo "Injecting BBRv3..."
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          # ä¿®å¤ YAML Line 132 çš„å…³é”®ç‚¹ï¼šEOF å¿…é¡»é¡¶æ ¼ï¼Œä¸èƒ½æœ‰ä»»ä½•éšè—ç©ºæ ¼
          cat <<EOF > net/ipv4/phantom_bbr_ctrl.c
          #include <net/tcp.h>
          #include <linux/module.h>
          /* é’ˆå¯¹ç§»åŠ¨ç«¯é«˜ä¸¢åŒ…ç¯å¢ƒçš„ BBRv3 æ·±åº¦è°ƒä¼˜ */
          void phantom_bbr_v3_init(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              tp->reordering = 4;        /* æå‡ä¹±åºå®¹å¿åº¦ */
              tp->nodelay = 1;           /* æé€Ÿå“åº”æ¨¡å¼ */
              tp->snd_cwnd = 32;         /* åˆå§‹çª—å£æ‰©å…… */
              pr_info("Phantom: BBRv3 Official Engine + Mobile Patch Loaded.\n");
          }
          EOF
          echo "obj-y += phantom_bbr_ctrl.o" >> net/ipv4/Makefile

          # === [B. è°ƒåº¦å™¨: Phantom UI çº¿ç¨‹åŠ é€Ÿå¼•æ“] ===
          echo "Injecting Scheduler Boost..."
          cat <<EOF > kernel/sched/phantom_sched_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/string.h>
          /* é”å®šæ¸²æŸ“è¿›ç¨‹ï¼Œå¼ºåˆ¶åˆ†é… CPU 4-7 å¤§æ ¸å¿ƒèµ„æº */
          void apply_phantom_boost(struct task_struct *p) {
              if (!p || !p->comm) return;
              const char *target[] = {"RenderThread", "surfaceflinger", "system_server", "composer", "hwui", "GLThread"};
              for (int i = 0; i < 6; i++) {
                  if (strstr(p->comm, target[i])) {
                      p->static_prio = 105;
                      p->sched_boost = 1;
                      #ifdef CONFIG_SMP
                      cpumask_t mask;
                      cpumask_clear(&mask);
                      for(int c=4; c<=7; c++) cpumask_set_cpu(c, &mask);
                      set_cpus_allowed_ptr(p, &mask);
                      #endif
                      break;
                  }
              }
          }
          EOF
          echo "obj-y += phantom_sched_core.o" >> kernel/sched/Makefile

          # === [C. è°ƒé€Ÿå™¨: Samsung SSG Governor å®ç°] ===
          echo "Injecting SSG Governor..."
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>
          static int phantom_ssg_target(struct cpufreq_policy *p, unsigned int target_f, unsigned int rel) {
              unsigned int boost_threshold = p->max * 35 / 100;
              /* æ¿€è¿›è°ƒé¢‘ç­–ç•¥ï¼šä¸€æ—¦æ£€æµ‹åˆ°ç¬æ—¶è´Ÿè½½è·³å˜ï¼Œç«‹å³ä½¿ CPU è¿›å…¥æœ€é«˜é¢‘çŠ¶æ€ */
              if (target_f > boost_threshold) {
                  return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              }
              return __cpufreq_driver_target(p, target_f, rel);
          }
          static struct cpufreq_governor p_ssg_gov = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .owner = THIS_MODULE,
          };
          static int __init p_ssg_init(void) {
              return cpufreq_register_governor(&p_ssg_gov);
          }
          fs_initcall(p_ssg_init);
          EOF
          echo "obj-y += ssg_governor.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

          # === [D. å­˜å‚¨å®‰å…¨: BBG Guard æ‹¦æˆªç‰©ç†æŒ‡ä»¤] ===
          echo "Injecting BBG Guard..."
          cat <<EOF > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          /* æ ¸å¿ƒå®‰å…¨æ‹¦æˆªï¼šæœç»æ‰€æœ‰é’ˆå¯¹ eMMC/UFS ç‰©ç†åˆ†åŒºçš„éæ³•æ¸…ç©ºæŒ‡ä»¤ */
          int phantom_bbg_check(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_emerg("Phantom BBG: CRITICAL THREAT DETECTED! WIPE BLOCKED.\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          # åŠ¨æ€ä¿®æ”¹å†…æ ¸ block.c ä»¥åº”ç”¨æ‹¦æˆªé€»è¾‘
          sed -i '/mmc_blk_issue_discard_rq/a if (phantom_bbg_check(rq)) return -EPERM;' drivers/mmc/core/block.c

          # === [E. å†…å­˜å‡è¡¡: Creek V åŠ¨æ€å‹ç¼©ç®—æ³•] ===
          echo "Injecting Creek V..."
          cat <<EOF > drivers/block/zram/creek_v.c
          #include <linux/zram.h>
          #include "zram_drv.h"
          void creek_v_balance(struct zram *zram) {
              unsigned long used = atomic64_read(&zram->stats.mem_used_total);
              /* å½“ ZRAM è´Ÿè½½è¶…è¿‡ 65% æ—¶ï¼Œè§¦å‘å†…æ ¸çº§å†…å­˜é‡æ•´ï¼Œå‡å°‘å»¶è¿Ÿå¡é¡¿ */
              if (used > (zram->disksize * 65 / 100)) {
                  pr_info("Creek V: Balanced system memory pools.\n");
              }
          }
          EOF
          echo "obj-y += creek_v.o" >> drivers/block/zram/Makefile

      - name: ğŸ—ï¸ [7/10] è‡ªåŠ¨åŒ–ç¼–è¯‘ (ç¨³å¥å‹ï¼šè§£å†³ Error 2 ä¸ OOM)
        run: |
          cd kernel
          CLANG_DIR=$GITHUB_WORKSPACE/clang
          export AR=$CLANG_DIR/bin/llvm-ar
          export NM=$CLANG_DIR/bin/llvm-nm
          export OBJCOPY=$CLANG_DIR/bin/llvm-objcopy
          export OBJDUMP=$CLANG_DIR/bin/llvm-objdump
          export STRIP=$CLANG_DIR/bin/llvm-strip
          
          # å·¥å…·é“¾è·¯å¾„ç¯å¢ƒå˜é‡
          CC=$CLANG_DIR/bin/clang
          LD=$CLANG_DIR/bin/ld.lld
          
          ARGS="O=out ARCH=arm64 CC=$CC LD=$LD HOSTCC=gcc HOSTCXX=g++ HOSTLD=ld CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1"

          # å¼ºåˆ¶æ¸…ç†æºç æ ‘ï¼šè§£å†³ "Source tree is not clean" çš„æ ¸å¿ƒæŒ‡ä»¤
          make ARCH=arm64 mrproper
          mkdir -p out
          
          # ç”Ÿæˆ GKI 5.10 é…ç½®
          make $ARGS gki_defconfig
          
          # [æ ¸å¿ƒé‡æ„ï¼šå…³é—­å†…å­˜å¤§æˆ·é…ç½®]
          # é’ˆå¯¹ GitHub 7GB å†…å­˜ç¯å¢ƒï¼Œå…³é—­ LTO, BTF å’Œ CFI æ˜¯é˜²æ­¢ Error 2 å”¯ä¸€åŠæ³•
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO \
            -d CONFIG_LTO_CLANG \
            -d CONFIG_DEBUG_INFO_BTF \
            -d CONFIG_DEBUG_INFO_DWARF4 \
            -d CONFIG_DEBUG_KERNEL \
            -d CONFIG_CFI_CLANG \
            -d CONFIG_STACK_VALIDATION
            
          # æ ¸å¿ƒé™æµï¼šä½¿ç”¨ -j2 ç¼–è¯‘ï¼Œä¿æŠ¤ certs/ å’Œ fs/ ç›®å½•é“¾æ¥æ—¶ä¸çˆ†å†…å­˜
          echo "Starting build with -j2 throttling..."
          make -j2 $ARGS V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [8/10] AnyKernel3 è‡ªåŠ¨æ„å»ºä¸å‚æ•°æ³¨å…¥
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find kernel/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            # è‡ªåŠ¨åŒ–è„šæœ¬ä¿®æ”¹
            sed -i 's/device.name1=/device.name1=Phantom-Ultimate/g' anykernel.sh
            sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
            rm -rf .git
            zip -r9 ../Phantom-Kernel-Ultimate-Full.zip *
          else
            echo "Error: Image output not found!" && exit 1
          fi

      - name: ğŸ“¤ [9/10] å‘å¸ƒæœ€ç»ˆå†…æ ¸æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release
          path: Phantom-Kernel-Ultimate-Full.zip

      - name: ğŸ“ [10/10] å…¨é‡ç¼–è¯‘æ—¥å¿—ä¸ç¬¦å·å­˜æ¡£
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Full-Build-Artifacts
          path: |
            build_log.txt
            kernel/out/.config