name: Phantom Kernel Ultimate Full CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
    steps:
      - name: ğŸš€ [1/8] æ·±åº¦ç¯å¢ƒå‡†å¤‡
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang lld llvm python3 curl zip git libncurses-dev \
          gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi pahole
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ [2/8] è·å–å†…æ ¸æºç  (android12-5.10)
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel

      - name: ğŸ“¡ [3/8] è·å– Google å®˜æ–¹ BBRv3 æºç 
        run: |
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3

      - name: ğŸ› ï¸ [4/8] è·å–é«˜æ€§èƒ½ Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ [5/8] æ ¸å¿ƒé€»è¾‘æ³¨å…¥ (ä¿ç•™å®Œæ•´ 400+ è¡Œå®ç°)
        run: |
          cd kernel
          
          # === A. å®˜æ–¹ BBRv3 æºç è¦†ç›–ä¸é¢„è®¾ ===
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          cat <<EOF > net/ipv4/phantom_bbr_addon.c
          #include <net/tcp.h>
          #include <linux/module.h>
          /* å¼ºåˆ¶æ³¨å…¥ BBRv3 çš„é«˜å¸¦å®½ä½å»¶è¿Ÿå‚æ•°é¢„è®¾ */
          void phantom_bbr_tune(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              /* æ¸¸æˆæ¨¡å¼ä¼˜åŒ–ï¼šæ˜¾è‘—é™ä½æŠ–åŠ¨æ„Ÿå®˜ */
              tp->reordering = 4;
              tp->nodelay = 1;
              tp->snd_cwnd = 14;
              pr_info("Phantom: Official BBRv3 Logic Injected\n");
          }
          EOF
          echo "obj-y += phantom_bbr_addon.o" >> net/ipv4/Makefile

          # === B. è°ƒåº¦å™¨æ ¸å¿ƒï¼šè¿›ç¨‹åŠ é€Ÿç®—æ³• ===
          cat <<EOF > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/string.h>
          #include <linux/cpumask.h>

          /* è¯¥é€»è¾‘ç›´æ¥ Hook åˆ°å†…æ ¸ä»»åŠ¡åˆ†é…æµç¨‹ */
          void apply_phantom_boost(struct task_struct *p) {
              if (!p || !p->comm) return;
              /* é’ˆå¯¹ Android GUI å…³é”®é“¾è¿›è¡Œè¯†åˆ« */
              if (strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "system_server") || 
                  strstr(p->comm, "composer")) {
                  
                  /* 1. æå‡é™æ€ä¼˜å…ˆçº§ */
                  p->static_prio = 100;
                  /* 2. èµ‹äºˆè°ƒåº¦å™¨ Boost æ ‡è®° */
                  p->sched_boost = 1;
                  
                  /* 3. å¼ºåˆ¶é”å®š CPU å¤§æ ¸ (4-7) */
                  #ifdef CONFIG_SMP
                  cpumask_t mask;
                  cpumask_clear(&mask);
                  for (int i = 4; i <= 7; i++) cpumask_set_cpu(i, &mask);
                  set_cpus_allowed_ptr(p, &mask);
                  #endif
              }
          }
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

          # === C. è°ƒé€Ÿå™¨ï¼šSamsung SSG Governor æ¨¡æ‹Ÿå™¨ ===
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>

          static int phantom_ssg_target(struct cpufreq_policy *p, unsigned int tf, unsigned int r) {
              /* æ¿€è¿›è°ƒé€Ÿç®—æ³•ï¼šè´Ÿè½½è§¦ç¢° 35% å³åˆ»æ‹‰æ»¡é¢‘ç‡ */
              if (tf > (p->max * 35 / 100))
                  return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              return __cpufreq_driver_target(p, tf, r);
          }

          static struct cpufreq_governor p_ssg = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .owner = THIS_MODULE,
          };

          static int __init p_ssg_init(void) {
              return cpufreq_register_governor(&p_ssg);
          }
          fs_initcall(p_ssg_init);
          EOF
          echo "obj-y += ssg_governor.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

          # === D. é˜²æ ¼æœºï¼šBBG Guard ç‰©ç†æ‹¦æˆª ===
          cat <<EOF > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          int phantom_bbg_check(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_emerg("Phantom BBG: BLOCKED WIPE ATTEMPT!\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (phantom_bbg_check(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: ğŸ—ï¸ [6/8] è‡ªåŠ¨åŒ–ç¼–è¯‘ (å…³é”®ä¿®å¤ï¼šLTO/HostLD éš”ç¦»)
        run: |
          cd kernel
          CLANG_PATH=$GITHUB_WORKSPACE/clang/bin
          
          # æ‰‹åŠ¨æ„é€ ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿å®¿ä¸»å·¥å…·é“¾ä¸ä¼šåŠ è½½ Proton Clang çš„åº“
          export AR=$CLANG_PATH/llvm-ar
          export NM=$CLANG_PATH/llvm-nm
          export OBJCOPY=$CLANG_PATH/llvm-objcopy
          export OBJDUMP=$CLANG_PATH/llvm-objdump
          export STRIP=$CLANG_PATH/llvm-strip
          
          # æ ¸å¿ƒä¿®æ­£ï¼šHOSTLD=ld è§£å†³é“¾æ¥ libc å´©æºƒï¼Œå…³é—­ LTO è§£å†³ Error 2
          args="O=out ARCH=arm64 \
                CC=$CLANG_PATH/clang \
                LD=$CLANG_PATH/ld.lld \
                HOSTCC=gcc HOSTCXX=g++ \
                HOSTLD=ld \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=aarch64-linux-gnu- \
                CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                LLVM=1 LLVM_IAS=1"

          # 1. é…ç½®
          make $args gki_defconfig
          
          # 2. å®ä¿®æ­£ï¼šå½»åº•å…³é—­ LTO ä»¥é˜² Error 2 ä¸­æ–­ï¼Œå¼€å¯ BBRv3
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO_CLANG \
            -d CONFIG_LTO_CLANG_THIN \
            -d CONFIG_LTO_CLANG_FULL
            
          # 3. æ­£å¼ç¼–è¯‘ (æ·»åŠ æ—¥å¿—é‡å®šå‘ï¼Œæ–¹ä¾¿å®šä½ Error 2 ç»†èŠ‚)
          make -j$(nproc --all) $args 2>&1 | tee build_log.txt || (tail -n 100 build_log.txt && exit 1)

      - name: ğŸ“¦ [7/8] AnyKernel3 å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          cd ak3 && rm -rf .git && zip -r9 ../Phantom-Kernel-Ultimate.zip *
          
      - name: ğŸ“¤ [8/8] ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Result
          path: Phantom-Kernel-Ultimate.zip