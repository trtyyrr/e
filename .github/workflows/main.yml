name: Phantom Kernel Ultimate x SM8650 Atomic-Full
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - ç‰©ç†çº§å…¨å±•å¼€ç‰ˆ

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  # é‡‡ç”¨è°·æ­Œ AOSP ç”Ÿäº§çº§ Clang 17
  CLANG_URL: "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r498220b.tar.gz"
  CLANG_ROOT: "${{ github.workspace }}/clang-r498220b"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒç‰©ç†åŒ–å¹³é“º
      # ========================================================================
      - name: ğŸ§¹ [Step 01] ç‰©ç†çº§ç³»ç»Ÿç©ºé—´å½»åº•æ¸…ç†
        run: |
          echo "==== æ­£åœ¨å¯åŠ¨æ·±å±‚ç©ºé—´å›æ”¶ä»»åŠ¡ ===="
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli
          sudo apt-get purge -y google-cloud-sdk
          sudo apt-get purge -y mono-devel
          sudo apt-get purge -y powershell
          sudo apt-get autoremove -y
          sudo apt-get clean
          echo "==== æœ€ç»ˆç©ºé—´ç»Ÿè®¡æŠ¥å‘Š ===="
          df -h

      - name: ğŸ› ï¸ [Step 02] ç‰©ç†å¹³é“ºæ‰€æœ‰äº¤å‰ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc
          sudo apt-get install -y build-essential
          sudo apt-get install -y flex
          sudo apt-get install -y bison
          sudo apt-get install -y libssl-dev
          sudo apt-get install -y libelf-dev
          sudo apt-get install -y clang
          sudo apt-get install -y lld
          sudo apt-get install -y llvm
          sudo apt-get install -y python3
          sudo apt-get install -y python3-dev
          sudo apt-get install -y python-is-python3
          sudo apt-get install -y curl
          sudo apt-get install -y zip
          sudo apt-get install -y git
          sudo apt-get install -y ccache
          sudo apt-get install -y aria2
          sudo apt-get install -y pahole
          sudo apt-get install -y dwarves
          sudo apt-get install -y kmod
          sudo apt-get install -y cpio
          sudo apt-get install -y expect
          sudo apt-get install -y rsync
          sudo apt-get install -y libncurses-dev
          sudo apt-get install -y binutils-aarch64-linux-gnu
          sudo apt-get install -y binutils-arm-linux-gnueabi
          sudo apt-get install -y wget
          sudo apt-get install -y tar
          sudo apt-get install -y libarchive-tools
          sudo apt-get install -y lz4
          sudo apt-get install -y liblz4-tool
          sudo apt-get install -y zstd
          sudo apt-get install -y libzstd-dev

      - name: ğŸ“¥ [Step 03] åŒæ­¥ä¸€åŠ  sm8650 æºç  (ç‰©ç†å±•å¼€è§£å‹)
        run: |
          mkdir -p workspace
          cd workspace
          echo "æ­£åœ¨å»ºç«‹è¿æ¥å¹¶ä¸‹è½½ä¸€åŠ  12/å¹³æ¿Pro æ ¸å¿ƒæºç ..."
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip
          mv android_kernel_common_oneplus_sm8650-* common
          rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½²å®˜æ–¹ Clang r498220b (åŸå­çº§è§£å‹)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          cd ${{ github.workspace }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.tar.gz
          tar -C ${{ env.CLANG_ROOT }} -xzf clang.tar.gz
          rm clang.tar.gz
          ${{ env.CLANG_ROOT }}/bin/clang --version

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šå†…æ ¸å‚æ•°åŸå­çº§æ³¨å…¥ (ä¸å†ä½¿ç”¨å¾ªç¯æˆ–å˜é‡åˆé›†)
      # ========================================================================
      - name: âš™ï¸ [Step 05] ç‰©ç†çº§æ³¨å…¥å…¨é‡ GKI é…ç½®å‚æ•° (éç¼©å‡ç‰ˆ)
        run: |
          cd workspace/common
          CONF="arch/arm64/configs/gki_defconfig"
          echo "==== æ­£åœ¨æ³¨å…¥ç½‘ç»œåè®®æ ˆä¼˜åŒ– ===="
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONF
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> $CONF
          echo "CONFIG_NET_SCH_FQ=y" >> $CONF
          echo "CONFIG_NET_SCH_FQ_CODEL=y" >> $CONF
          echo "CONFIG_NET_SCH_CAKE=y" >> $CONF
          
          echo "==== æ­£åœ¨æ³¨å…¥å†…å­˜ç®—æ³•ä¼˜åŒ– ===="
          echo "CONFIG_ZRAM=y" >> $CONF
          echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" >> $CONF
          echo "CONFIG_LZ4_COMPRESS=y" >> $CONF
          echo "CONFIG_LZ4HC_COMPRESS=y" >> $CONF
          echo "CONFIG_LZ4_DECOMPRESS=y" >> $CONF
          echo "CONFIG_ZSMALLOC=y" >> $CONF
          echo "CONFIG_ZSMALLOC_STAT=y" >> $CONF
          
          echo "==== æ­£åœ¨æ³¨å…¥æ ¸å¿ƒè°ƒåº¦å‚æ•° ===="
          echo "CONFIG_HZ=1000" >> $CONF
          echo "CONFIG_HZ_1000=y" >> $CONF
          echo "CONFIG_SCHED_WALT=y" >> $CONF
          echo "CONFIG_SCHED_AUTOGROUP=y" >> $CONF
          echo "CONFIG_FAIR_GROUP_SCHED=y" >> $CONF
          
          echo "==== æ­£åœ¨å¤„ç†ç¨³å®šæ€§å†²çªå±è”½ ===="
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          echo "CONFIG_LTO_NONE=y" >> $CONF
          echo "CONFIG_CFI_CLANG=n" >> $CONF
          echo "CONFIG_DEBUG_INFO_BTF=n" >> $CONF
          echo "CONFIG_KPROBES=n" >> $CONF

      - name: ğŸ’‰ [Step 06] ç‰©ç†å±•å¼€ C è¯­è¨€è°ƒåº¦å™¨è¡¥ä¸
        run: |
          cd workspace/common
          echo "æ­£åœ¨å†…æ ¸æ ¸å¿ƒå±‚ç‰©ç†ç¼–å†™ Phantom Engine è°ƒåº¦é€»è¾‘..."
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          #include <linux/sched/rt.h>
          void apply_phantom_policy(struct task_struct *p) {
              if (!p || !p->comm) return;
              if (strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "hwcomposer") ||
                  strstr(p->comm, "composer-service") ||
                  strstr(p->comm, "system_server")) {
                  cpumask_t ui_mask;
                  cpumask_clear(&ui_mask);
                  cpumask_set_cpu(7, &ui_mask); /* é”å®š sm8650 X4 è¶…å¤§æ ¸ */
                  if (p->nr_cpus_allowed > 1) {
                      set_cpus_allowed_ptr(p, &ui_mask);
                  }
                  p->static_prio = 90;
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] ç‰©ç†çº§ GPU ä¸æ¸©æ§ Hack æ³¨å…¥
        run: |
          cd workspace/common
          echo "æ­£åœ¨ç‰©ç†æ¢æµ‹ GPU æ§åˆ¶ä½ç‚¹å¹¶æ³¨å…¥ä»£ç ..."
          # é’ˆå¯¹éªé¾™ 8G3 çš„å¤šç§å¯èƒ½è·¯å¾„è¿›è¡ŒåŸå­åŒ–å¤„ç†
          mkdir -p drivers/gpu/msm
          mkdir -p techpack/display/drivers/gpu/drm/msm
          
          cat <<'EOF' > drivers/gpu/msm/phantom_gpu_boost.c
          #include <linux/module.h>
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 480000000) {
                  *freq = 615000000; /* å¼ºåˆ¶é”é¢‘æå‡ 144Hz ç¨³å®šæ€§ */
              }
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> drivers/gpu/msm/Makefile

      - name: ğŸ›¡ï¸ [Step 08] ç‰©ç†æ³¨å…¥å­˜å‚¨ I/O æŠ¤ç›¾é€»è¾‘
        run: |
          cd workspace/common
          mkdir -p drivers/mmc/core/
          cat <<'EOF' > drivers/mmc/core/phantom_guard.c
          #include <linux/blkdev.h>
          #include <linux/mmc/card.h>
          int check_phantom_guard(struct request *rq) {
              if (rq && rq->rq_disk) {
                  if (strstr(rq->rq_disk->disk_name, "mmcblk0") || strstr(rq->rq_disk->disk_name, "sda")) {
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_guard.o" >> drivers/mmc/core/Makefile

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æµç¨‹åŸå­åŒ–æ‰§è¡Œ
      # ========================================================================
      - name: ğŸ“‚ [Step 09] Ccache ç‰©ç†ç¼“å­˜æ¢å¤
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-atomic-full-${{ github.sha }}
          restore-keys: ccache-sm8650-atomic-full-

      - name: ğŸ—ï¸ [Step 10] ç¯å¢ƒå˜é‡ç‰©ç†çº§è§£è€¦å¹³é“º
        run: |
          cd workspace/common
          mkdir -p out
          cp arch/arm64/configs/gki_defconfig out/.config
          
          # æ¯ä¸€ä¸ªå·¥å…·é“¾æˆå‘˜éƒ½ç‰©ç†åŒ–æš´éœ²ç»™ç³»ç»Ÿç¯å¢ƒ
          echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CC=ccache clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV
          echo "READELF=llvm-readelf" >> $GITHUB_ENV
          echo "OBJSIZE=llvm-size" >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 11] åŸå­åŒ–åˆ†æ­¥æ„å»ºï¼šUAPI ä¸å†…æ ¸ä¸»é•œåƒ
        run: |
          cd workspace/common
          # ç‰©ç†å®šä¹‰ KCFLAGS ä¼˜åŒ–é¡¹
          export KCFLAGS="-march=armv8-a+crc+crypto -O3 -pipe -fno-strict-aliasing -fno-common"
          
          echo "==== 1. ç‰©ç†åŒæ­¥é…ç½® ===="
          yes "" | make O=out ARCH=arm64 olddefconfig
          
          echo "==== 2. ç‰©ç†å¯¼å‡ºå¤´æ–‡ä»¶ (è§£å†³ Error 2) ===="
          make O=out ARCH=arm64 headers_install
          
          echo "==== 3. ç‰©ç†å¯åŠ¨ Image ç¼–è¯‘ (j$(nproc)) ===="
          make -j$(nproc) O=out ARCH=arm64 KCFLAGS="$KCFLAGS" V=1 Image 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šç‰©ç†æˆæœå°è£…ä¸ç»Ÿè®¡
      # ========================================================================
      - name: ğŸ“¦ [Step 12] AnyKernel3 ç‰©ç†å°è£…é€»è¾‘å±•å¼€
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE_PATH=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -n "$IMAGE_PATH" ]; then
              cp "$IMAGE_PATH" ak3/
              cd ak3
              sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
              sed -i "s/device.name2=/device.name2=OnePlus12/g" anykernel.sh
              sed -i "s/device.name3=/device.name3=OP5929L1/g" anykernel.sh
              zip -r9 ../Phantom-Kernel-SM8650-Atomic.zip *
          else
              echo "è‡´å‘½é”™è¯¯ï¼šImage é•œåƒæœªç”Ÿæˆï¼Œæ£€æŸ¥æ„å»ºæ—¥å¿—"
              exit 1
          fi

      - name: ğŸ“¤ [Step 13] å‘å¸ƒç‰©ç†æ„å»ºæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Result-Full
          path: |
            Phantom-Kernel-SM8650-Atomic.zip
            workspace/build_log.zip
            workspace/common/out/.config

      - name: ğŸ“Š [Step 14] ç‰©ç†å¯¼å‡º Ccache çŠ¶æ€æŠ¥å‘Š
        run: |
          ccache -s
          echo "ç‰©ç†æ„å»ºæµç¨‹å…¨éƒ¨ç»“æŸã€‚"