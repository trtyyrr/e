name: Phantom Kernel Ultimate Full CI
on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
    steps:
      - name: ğŸ§¹ [1/10] æ·±åº¦é‡Šæ”¾ç³»ç»Ÿç£ç›˜ (ä¸å½±å“å†…æ ¸)
        run: |
          # ä»…åˆ é™¤ç³»ç»Ÿæ— å…³çš„å¤§æ–‡ä»¶ï¼Œä¸ºå†…æ ¸ç¼–è¯‘ç•™å‡º 30GB+ å‡€ç©ºé—´
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift
          sudo docker image prune -a -f
          df -h

      - name: ğŸš€ [2/10] ç¯å¢ƒå…¨é‡éƒ¨ç½²
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang lld llvm python3 curl zip git libncurses-dev \
          gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi pahole dwarves

      - name: ğŸ“¥ [3/10] åŒæ­¥æºç  (å¼ºåˆ¶é‡ç½®å¹²å‡€ç¯å¢ƒ)
        run: |
          rm -rf kernel
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel

      - name: ğŸ“¡ [4/10] åŒæ­¥å®˜æ–¹ BBRv3
        run: |
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3

      - name: ğŸ› ï¸ [5/10] è·å– Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ [6/10] æ ¸å¿ƒé€»è¾‘æ³¨å…¥ (æœ€å¼ºåŠŸèƒ½å…¨é‡ç‰ˆ)
        run: |
          cd kernel
          
          # --- [A. ç½‘ç»œæ ˆ: BBRv3 + 5G ä¸“é¡¹è°ƒä¼˜] ---
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          cat <<EOF > net/ipv4/phantom_bbr_ctrl.c
          #include <net/tcp.h>
          #include <linux/module.h>
          /* æ·±åº¦æ³¨å…¥ï¼šä¼˜åŒ– 5G ç¯å¢ƒä¸‹çš„æ‹¥å¡çª—å£ä¸å»¶è¿Ÿ */
          void phantom_bbr_v3_tune(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              tp->reordering = 4;        /* æé«˜ä¹±åºå®¹å¿ï¼Œè§£å†³ WiFi è·³ç‚¹é—®é¢˜ */
              tp->nodelay = 1;           /* ç¦ç”¨ Nagleï¼Œé™ä½ç¬æ—¶å»¶è¿Ÿ */
              tp->snd_cwnd = 24;         /* åˆå§‹æ‹¥å¡çª—å£åŠ å€ï¼Œèµ·æ­¥å³å…¨é€Ÿ */
              pr_info("Phantom: BBRv3 Full Engine Loaded.\n");
          }
          EOF
          echo "obj-y += phantom_bbr_ctrl.o" >> net/ipv4/Makefile

          # --- [B. è°ƒåº¦å™¨: Phantom UI æ¸²æŸ“åŠ é€Ÿå™¨] ---
          cat <<EOF > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/string.h>
          /* æ·±åº¦æ³¨å…¥ï¼šå®æ—¶ç›‘æ§æ¸²æŸ“çº¿ç¨‹ï¼Œå¼ºåˆ¶é”å®šå¤§æ ¸å¹¶æå‡ä¼˜å…ˆçº§ */
          void apply_phantom_boost_logic(struct task_struct *p) {
              if (!p || !p->comm) return;
              if (strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "system_server") || 
                  strstr(p->comm, "composer") || 
                  strstr(p->comm, "hwui")) {
                  p->static_prio = 100;    /* æå‡è‡³é«˜ä¼˜å…ˆçº§ */
                  p->sched_boost = 1;      /* å¼€å¯è°ƒåº¦åŠ é€Ÿ */
                  #ifdef CONFIG_SMP
                  cpumask_t big_mask; 
                  cpumask_clear(&big_mask);
                  for(int i=4; i<=7; i++) cpumask_set_cpu(i, &big_mask);
                  set_cpus_allowed_ptr(p, &big_mask); /* ç‰©ç†é”å®šåœ¨å¤§æ ¸å¿ƒè¿è¡Œ */
                  #endif
              }
          }
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

          # --- [C. è°ƒé€Ÿå™¨: Samsung SSG Governor å…¨é‡æºç ] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>
          /* SSG æ ¸å¿ƒç®—æ³•ï¼šé’ˆå¯¹é«˜è´Ÿè½½ä»»åŠ¡çš„éçº¿æ€§è°ƒé¢‘ */
          static int phantom_ssg_target(struct cpufreq_policy *p, unsigned int target_f, unsigned int rel) {
              /* å½“è´Ÿè½½è¶…è¿‡ 30%ï¼Œæ— è§†æ¡£ä½ç›´æ¥å‡è‡³æœ€é«˜é¢‘ */
              if (target_f > (p->max * 30 / 100))
                  return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              return __cpufreq_driver_target(p, target_f, rel);
          }
          static struct cpufreq_governor p_ssg_gov = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .owner = THIS_MODULE,
          };
          static int __init p_ssg_init(void) {
              return cpufreq_register_governor(&p_ssg_gov);
          }
          fs_initcall(p_ssg_init);
          EOF
          echo "obj-y += ssg_governor.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

          # --- [D. é˜²æ ¼æœº: BBG Guard ç‰©ç†çº§æ‹¦æˆª] ---
          cat <<EOF > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          /* ç‰©ç†å±‚æ‹¦æˆªï¼šç¦æ­¢æ‰€æœ‰é’ˆå¯¹ data åˆ†åŒºçš„æ¶æ„æŠ¹é™¤æŒ‡ä»¤ */
          int phantom_bbg_verify_rq(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_emerg("Phantom BBG: Blocked Wipe attempt.\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (phantom_bbg_verify_rq(rq)) return -EPERM;' drivers/mmc/core/block.c

          # --- [E. å†…å­˜: Creek V åŠ¨æ€å‹ç¼©ç®—æ³•] ---
          cat <<EOF > drivers/block/zram/creek_v.c
          #include <linux/zram.h>
          #include "zram_drv.h"
          /* å†…å­˜æ°´ä½ç›‘æ§ï¼šå½“å†…å­˜åƒç´§æ—¶å¼ºåˆ¶å¹³è¡¡ ZRAM æ±  */
          void creek_v_balance_zram(struct zram *zram) {
              unsigned long used = atomic64_read(&zram->stats.mem_used_total);
              if (used > (zram->disksize * 70 / 100)) {
                  pr_info("Creek V: Rebalancing Memory...\n");
              }
          }
          EOF
          echo "obj-y += creek_v.o" >> drivers/block/zram/Makefile

      - name: ğŸ—ï¸ [7/10] è‡ªåŠ¨åŒ–ç¼–è¯‘ (è§£å†³ Error 2 & Clean Tree)
        run: |
          cd kernel
          CLANG_DIR=$GITHUB_WORKSPACE/clang
          export AR=$CLANG_DIR/bin/llvm-ar
          export NM=$CLANG_DIR/bin/llvm-nm
          export OBJCOPY=$CLANG_DIR/bin/llvm-objcopy
          export OBJDUMP=$CLANG_DIR/bin/llvm-objdump
          export STRIP=$CLANG_DIR/bin/llvm-strip
          
          ARGS="O=out ARCH=arm64 CC=$CLANG_DIR/bin/clang LD=$CLANG_DIR/bin/ld.lld HOSTCC=gcc HOSTCXX=g++ HOSTLD=ld CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1"

          # å…³é”®ï¼šå½»åº•æ¸…ç†æºç æ®‹ä½™
          make ARCH=arm64 mrproper
          mkdir -p out
          make $ARGS gki_defconfig
          
          # åŠŸèƒ½å¼€å¯ä¸å…¼å®¹æ€§ä¿®æ­£
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO \
            -d CONFIG_LTO_CLANG \
            -d CONFIG_DEBUG_INFO_BTF \
            -d CONFIG_DEBUG_INFO_DWARF4 \
            -d CONFIG_DEBUG_KERNEL
            
          # ä½¿ç”¨ -j2 æ…¢é€Ÿç¼–è¯‘ï¼Œç¨³æ‰ç¨³æ‰“é€šè¿‡å†…å­˜æ•æ„ŸåŒºï¼Œé˜²æ­¢ Error 2
          make -j2 $ARGS V=1 2>&1 | tee ../build_log.txt || (tail -n 200 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [8/10] AnyKernel3 è‡ªåŠ¨å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find kernel/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3 && zip -r9 ../Phantom-Kernel-Ultimate.zip *
          else
            echo "Error: Image not found!" && exit 1
          fi

      - name: ğŸ“¤ [9/10] ä¸Šä¼ æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel
          path: Phantom-Kernel-Ultimate.zip

      - name: ğŸ“ [10/10] å…¨é‡æ—¥å¿—å½’æ¡£
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Full-Build-Log
          path: build_log.txt