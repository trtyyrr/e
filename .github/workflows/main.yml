name: OKI Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ OKI æ¶æ„ä¸€åŠ å¹³æ¿ Pro æ»¡è¡€æ„å»º [ç‰©ç†å…¨å±•å¼€] - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_URL: "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r483580.tar.gz"
  CLANG_ROOT: "${{ github.workspace }}/clang-oki"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_oki"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"

jobs:
  ultimate_oki_build:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šåŸå­åŒ–ç¯å¢ƒéƒ¨ç½² (ç¦æ­¢åˆå¹¶å‘½ä»¤)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 1
        run: sudo docker image prune -a -f
      - name: ğŸ§¹ [Step 02] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 2
        run: sudo rm -rf /usr/share/dotnet
      - name: ğŸ§¹ [Step 03] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 3
        run: sudo rm -rf /usr/local/lib/android
      - name: ğŸ§¹ [Step 04] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 4
        run: sudo rm -rf /opt/ghc
      - name: ğŸ§¹ [Step 05] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 5
        run: sudo rm -rf /usr/local/share/powershell
      - name: ğŸ§¹ [Step 06] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 6
        run: sudo rm -rf /usr/share/swift
      - name: ğŸ§¹ [Step 07] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 7
        run: sudo rm -rf /usr/local/lib/node_modules
      - name: ğŸ§¹ [Step 08] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 8
        run: sudo rm -rf /usr/lib/google-cloud-sdk
      - name: ğŸ§¹ [Step 09] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - èŠ‚ç‚¹ 9
        run: sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
      - name: ğŸ§¹ [Step 10] ç‰©ç†ç©ºé—´æ·±åº¦é‡Šæ”¾ - æœ€ç»ˆæ¸…ç†
        run: sudo apt-get autoremove -y && sudo apt-get clean && df -h

      - name: ğŸ› ï¸ [Step 11] éƒ¨ç½²ç¼–è¯‘å·¥å…· - bc
        run: sudo apt-get install -y bc
      - name: ğŸ› ï¸ [Step 12] éƒ¨ç½²ç¼–è¯‘å·¥å…· - build-essential
        run: sudo apt-get install -y build-essential
      - name: ğŸ› ï¸ [Step 13] éƒ¨ç½²ç¼–è¯‘å·¥å…· - flex
        run: sudo apt-get install -y flex
      - name: ğŸ› ï¸ [Step 14] éƒ¨ç½²ç¼–è¯‘å·¥å…· - bison
        run: sudo apt-get install -y bison
      - name: ğŸ› ï¸ [Step 15] éƒ¨ç½²ç¼–è¯‘å·¥å…· - libssl-dev
        run: sudo apt-get install -y libssl-dev
      - name: ğŸ› ï¸ [Step 16] éƒ¨ç½²ç¼–è¯‘å·¥å…· - libelf-dev
        run: sudo apt-get install -y libelf-dev
      - name: ğŸ› ï¸ [Step 17] éƒ¨ç½²ç¼–è¯‘å·¥å…· - clang
        run: sudo apt-get install -y clang
      - name: ğŸ› ï¸ [Step 18] éƒ¨ç½²ç¼–è¯‘å·¥å…· - lld
        run: sudo apt-get install -y lld
      - name: ğŸ› ï¸ [Step 19] éƒ¨ç½²ç¼–è¯‘å·¥å…· - llvm
        run: sudo apt-get install -y llvm
      - name: ğŸ› ï¸ [Step 20] éƒ¨ç½²ç¼–è¯‘å·¥å…· - python3
        run: sudo apt-get install -y python3
      - name: ğŸ› ï¸ [Step 21] éƒ¨ç½²ç¼–è¯‘å·¥å…· - git
        run: sudo apt-get install -y git
      - name: ğŸ› ï¸ [Step 22] éƒ¨ç½²ç¼–è¯‘å·¥å…· - ccache
        run: sudo apt-get install -y ccache
      - name: ğŸ› ï¸ [Step 23] éƒ¨ç½²ç¼–è¯‘å·¥å…· - aria2
        run: sudo apt-get install -y aria2
      - name: ğŸ› ï¸ [Step 24] éƒ¨ç½²ç¼–è¯‘å·¥å…· - pahole
        run: sudo apt-get install -y pahole
      - name: ğŸ› ï¸ [Step 25] éƒ¨ç½²ç¼–è¯‘å·¥å…· - rsync
        run: sudo apt-get install -y rsync
      - name: ğŸ› ï¸ [Step 26] éƒ¨ç½²ç¼–è¯‘å·¥å…· - device-tree-compiler
        run: sudo apt-get install -y device-tree-compiler

      - name: ğŸ“¥ [Step 27] ä¸‹è½½ OKI æºç 
        run: |
          mkdir -p workspace
          cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip
          mv android_kernel_common_oneplus_sm8650-* common
          rm kernel.zip

      - name: ğŸ“¥ [Step 28] ä¸‹è½½å®˜æ–¹ Clang r483580
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.tar.gz
          tar -C ${{ env.CLANG_ROOT }} -xzf clang.tar.gz
          rm clang.tar.gz

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šOKI æ ¸å¿ƒé…ç½®ç‰©ç†æ³¨å…¥ (åŸå­çº§ ECHO)
      # ========================================================================
      - name: âš™ï¸ [Step 29] OKI Config ç‰©ç†å±•å¼€ - ç½‘ç»œéƒ¨
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONF
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> $CONF
          echo "CONFIG_NET_SCH_FQ=y" >> $CONF
          echo "CONFIG_NET_SCH_FQ_CODEL=y" >> $CONF
      
      - name: âš™ï¸ [Step 30] OKI Config ç‰©ç†å±•å¼€ - è°ƒåº¦éƒ¨
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_HZ_1000=y" >> $CONF
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $CONF
          echo "CONFIG_SCHED_WALT=y" >> $CONF
          echo "CONFIG_SCHED_AUTOGROUP=y" >> $CONF

      - name: âš™ï¸ [Step 31] OKI Config ç‰©ç†å±•å¼€ - å†…å­˜éƒ¨
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_ZRAM=y" >> $CONF
          echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" >> $CONF
          echo "CONFIG_LZ4_COMPRESS=y" >> $CONF
          echo "CONFIG_LZ4HC_COMPRESS=y" >> $CONF

      - name: âš™ï¸ [Step 32] OKI Config ç‰©ç†å±•å¼€ - å…¼å®¹æ€§éƒ¨
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          echo "CONFIG_LTO_NONE=y" >> $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          echo "CONFIG_DEBUG_INFO_BTF=n" >> $CONF
          echo "CONFIG_UNUSED_SYMBOLS=y" >> $CONF
          echo "CONFIG_TRIM_UNUSED_KSYMS=n" >> $CONF

      - name: ğŸ’‰ [Step 33] ç‰©ç†æ³¨å…¥ OKI è°ƒåº¦å™¨æ ¸å¿ƒä»£ç 
        run: |
          cd workspace/common
          cat <<'EOF' > kernel/sched/oki_logic.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          void apply_oki_policy(struct task_struct *p) {
              if (p && p->comm) {
                  if (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread")) {
                      cpumask_t mask;
                      cpumask_clear(&mask);
                      cpumask_set_cpu(7, &mask);
                      set_cpus_allowed_ptr(p, &mask);
                  }
              }
          }
          EXPORT_SYMBOL_GPL(apply_oki_policy);
          EOF
          echo "obj-y += oki_logic.o" >> kernel/sched/Makefile

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æµç¨‹åŸå­çº§æ‰§è¡Œ (ç‰©ç†æ­¥éª¤æ‹†åˆ†)
      # ========================================================================
      - name: ğŸ“‚ [Step 34] åŠ è½½ Ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: oki-ccache-sm8650-full-${{ github.sha }}
          restore-keys: oki-ccache-sm8650-full-

      - name: ğŸ—ï¸ [Step 35] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - æ¶æ„é¡¹
        run: echo "ARCH=arm64" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 36] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - ç¼–è¯‘å™¨è·¯å¾„
        run: echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH
      - name: ğŸ—ï¸ [Step 37] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - LLVM å¼€å¯
        run: echo "LLVM=1" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 38] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - IAS å¼€å¯
        run: echo "LLVM_IAS=1" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 39] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - CC
        run: echo "CC=ccache clang" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 40] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - LD
        run: echo "LD=ld.lld" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 41] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - AR
        run: echo "AR=llvm-ar" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 42] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - NM
        run: echo "NM=llvm-nm" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 43] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - OBJCOPY
        run: echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 44] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - STRIP
        run: echo "STRIP=llvm-strip" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 45] ç¯å¢ƒå˜é‡ç‰©ç†å£°æ˜ - CCACHEç›®å½•
        run: echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 46] OKI æ„å»º - åŒæ­¥é…ç½®
        run: |
          cd workspace/common
          make O=out ARCH=arm64 gki_defconfig
          yes "" | make O=out ARCH=arm64 olddefconfig

      - name: ğŸ—ï¸ [Step 47] OKI æ„å»º - å¯¼å‡ºå¤´æ–‡ä»¶
        run: |
          cd workspace/common
          make O=out ARCH=arm64 headers_install

      - name: ğŸ—ï¸ [Step 48] OKI æ„å»º - ç¼–è¯‘å†…æ ¸é•œåƒ
        run: |
          cd workspace/common
          export KCFLAGS="-march=armv8-a+crc+crypto -O3 -pipe"
          make -j$(nproc) O=out ARCH=arm64 KCFLAGS="$KCFLAGS" V=1 Image 2>&1 | tee ../build_image_log.txt

      - name: ğŸ—ï¸ [Step 49] OKI æ„å»º - ç¼–è¯‘è®¾å¤‡æ ‘
        run: |
          cd workspace/common
          make -j$(nproc) O=out ARCH=arm64 dtbs 2>&1 | tee ../build_dtbs_log.txt

      - name: ğŸ—ï¸ [Step 50] OKI æ„å»º - ç¼–è¯‘å†…æ ¸æ¨¡å—
        run: |
          cd workspace/common
          make -j$(nproc) O=out ARCH=arm64 modules 2>&1 | tee ../build_modules_log.txt

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šç‰©ç†æˆæœæ‰“åŒ… (OKI ä¸“ç”¨)
      # ========================================================================
      - name: ğŸ“¦ [Step 51] AnyKernel3 å‡†å¤‡
        run: git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
      - name: ğŸ“¦ [Step 52] ç‰©ç†ç§»åŠ¨ Image
        run: cp workspace/common/out/arch/arm64/boot/Image ak3/
      - name: ğŸ“¦ [Step 53] ç‰©ç†ç§»åŠ¨ DTB
        run: find workspace/common/out/arch/arm64/boot/dts/qcom/ -name "*.dtb" -exec cp {} ak3/dtb \; || true
      - name: ğŸ“¦ [Step 54] ç‰©ç†é€‚é… AnyKernel3
        run: |
          cd ak3
          sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
          zip -r9 ../OKI-Kernel-SM8650-Atomic.zip *

      - name: ğŸ“¤ [Step 55] å‘å¸ƒæˆå“
        uses: actions/upload-artifact@v4
        with:
          name: OKI-Full-Result
          path: |
            OKI-Kernel-SM8650-Atomic.zip
            workspace/*.txt
            workspace/common/out/.config

      - name: ğŸ“Š [Step 56] ç»Ÿè®¡
        run: ccache -s