name: Phantom Kernel Ultimate x SM8650 Official-Toolchain
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - å®˜æ–¹ Clang å…¨é‡ç‰ˆ

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  # æ¢ç”¨è°·æ­Œ AOSP å®˜æ–¹ç¨³å®šçš„ Clang 17 (r498220b)
  CLANG_URL: "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r498220b.tar.gz"
  CLANG_ROOT: "${{ github.workspace }}/clang-r498220b"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šç³»ç»Ÿç¯å¢ƒç‰©ç†å‡†å¤‡ (ä¸ç¼©å‡)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] è™šæ‹Ÿæœºç£ç›˜ç©ºé—´ç‰©ç†çº§æ¸…ç†
        run: |
          echo "==== æ­£åœ¨å¯åŠ¨æ·±å±‚ç©ºé—´å›æ”¶ ===="
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          df -h

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²å…¨å¥—äº¤å‰ç¼–è¯‘ç”Ÿäº§å·¥å…·é“¾
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python3-dev python-is-python3 curl zip git ccache aria2 \
            pahole dwarves kmod cpio expect rsync libncurses-dev \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi \
            wget tar libarchive-tools lz4 liblz4-tool zstd libzstd-dev

      - name: ğŸ“¥ [Step 03] åŒæ­¥å†…æ ¸æºç  (sm8650 Full Source)
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½²è°·æ­Œå®˜æ–¹ Clang r498220b (LLVM 17)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          # è°·æ­Œå®˜æ–¹é“¾æ¥é‡‡ç”¨ tar.gz æ ¼å¼ï¼Œè§£å‹å‘½ä»¤ç‰©ç†å¹³é“º
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.tar.gz
          tar -C ${{ env.CLANG_ROOT }} -xzf clang.tar.gz
          rm clang.tar.gz
          echo "==== éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬ ===="
          ${{ env.CLANG_ROOT }}/bin/clang --version

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šå†…æ ¸åº•å±‚é€»è¾‘ç¡¬æ ¸æ³¨å…¥ (ç‰©ç†å±•å¼€)
      # ========================================================================
      - name: ğŸ“¡ [Step 05] ç½‘ç»œåè®®æ ˆä¼˜åŒ–ï¼šBBRv3 æ·±åº¦å¹³é“º
        run: |
          cd workspace/common
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          
          # ç‰©ç†æ³¨å…¥é…ç½®é¡¹ï¼Œä¸ä½¿ç”¨ç¼©å†™
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ_CODEL=y" >> arch/arm64/configs/gki_defconfig

      - name: ğŸ’‰ [Step 06] ç‰©ç†çº§ä»£ç æ³¨å…¥ï¼šPhantom è°ƒåº¦å™¨ä¸ GPU é”å®š
        run: |
          cd workspace/common
          # 1. ç‰©ç†ç¼–å†™ Phantom Engine æ ¸å¿ƒ
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          void apply_phantom_policy(struct task_struct *p) {
              if (p && p->comm && (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread"))) {
                  cpumask_t ui_mask;
                  cpumask_clear(&ui_mask);
                  cpumask_set_cpu(7, &ui_mask); /* ç»‘å®š 8G3 çš„ Cortex-X4 è¶…å¤§æ ¸ */
                  if (p->nr_cpus_allowed > 1) set_cpus_allowed_ptr(p, &ui_mask);
                  p->static_prio = 95;
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

          # 2. ç‰©ç†åˆ›å»º GPU è°ƒä¼˜å±‚
          mkdir -p drivers/gpu/phantom_kgsl
          cat <<'EOF' > drivers/gpu/phantom_kgsl/phantom_gpu_boost.c
          #include <linux/module.h>
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 480000000) *freq = 615000000;
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" > drivers/gpu/phantom_kgsl/Makefile
          echo "obj-y += phantom_kgsl/" >> drivers/gpu/Makefile

      - name: ğŸ§¬ [Step 07] å†…å­˜ä¼˜åŒ–ï¼šZRAM/LZ4 & 8G3 ç¼“å­˜é€»è¾‘è¡¥å…¨
        run: |
          cd workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git p_repo
          cd common
          git apply -p1 < ../p_repo/zram_patch/001-lz4.patch || true
          {
            echo "CONFIG_ZRAM=y"
            echo "CONFIG_ZRAM_DEF_COMP_LZ4=y"
            echo "CONFIG_LZ4_COMPRESS=y"
            echo "CONFIG_HZ_1000=y"
          } >> arch/arm64/configs/gki_defconfig
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' arch/arm64/configs/gki_defconfig

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æ ¸å¿ƒæ‰§è¡Œ (ç‰©ç†å±•å¼€ç¯å¢ƒå˜é‡ä¸åˆ†æ­¥æ„å»º)
      # ========================================================================
      - name: ğŸ“‚ [Step 08] Ccache çŠ¶æ€åŠ è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-official-clang-${{ github.sha }}
          restore-keys: ccache-sm8650-official-clang-

      - name: ğŸ—ï¸ [Step 09] ç‰©ç†å¯¹é½å·¥å…·é“¾ä¸ç¯å¢ƒå£°æ˜
        run: |
          cd workspace/common
          mkdir -p out
          cp arch/arm64/configs/gki_defconfig out/.config
          
          # ç‰©ç†å°† Clang è·¯å¾„å‹å…¥ç³»ç»Ÿ PATH
          echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 10] å¯åŠ¨å…¨é‡ç”Ÿäº§çº§ç¼–è¯‘ (Clang r498220b + 8G3 ç‰¹åŒ–)
        run: |
          cd workspace/common
          
          # 1. ç‰©ç†å£°æ˜æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œä¸ä½¿ç”¨ä»»ä½•ç¼©å†™å˜é‡å
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CC="ccache clang"
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          
          # 2. æ³¨å…¥é’ˆå¯¹ 8G3 (v9.2-a) çš„ç”Ÿäº§çº§ç¼–è¯‘ Flag
          # æ¢ç”¨ r498220b ç¨³å®šçš„ä¼˜åŒ–ç»„åˆï¼Œé¿å¼€ experimental åŠŸèƒ½
          export KCFLAGS="-march=armv8-a+crc+crypto -O3 -pipe -fno-strict-aliasing"

          echo "==== é˜¶æ®µ A: åŒæ­¥æ—§é…ç½® (olddefconfig) ===="
          yes "" | make O=out ARCH=arm64 olddefconfig
          
          echo "==== é˜¶æ®µ B: å¯¼å‡º UAPI å¤´æ–‡ä»¶ ===="
          make O=out ARCH=arm64 headers_install
          
          echo "==== é˜¶æ®µ C: å¯åŠ¨ä¸»é•œåƒ Image æ„å»º ===="
          make -j$(nproc) O=out ARCH=arm64 KCFLAGS="$KCFLAGS" V=1 Image 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šæˆæœå°è£… (ç‰©ç†å±•å¼€ AnyKernel3 é€»è¾‘)
      # ========================================================================
      - name: ğŸ“¦ [Step 11] AnyKernel3 æ»¡è¡€å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel-SM8650-Official.zip *
          else
            echo "è‡´å‘½é”™è¯¯ï¼šImage æ–‡ä»¶ç¼ºå¤±ï¼Œç¼–è¯‘å¯èƒ½åœ¨é“¾æ¥é˜¶æ®µå´©æºƒ" && exit 1
          fi

      - name: ğŸ“¤ [Step 12] å…¨é‡æˆå“å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Official-Clang
          path: |
            Phantom-Kernel-SM8650-Official.zip
            workspace/build_log.txt

      - name: ğŸ“Š [Step 13] æ„å»ºç»Ÿè®¡æŠ¥å‘Š
        run: ccache -s