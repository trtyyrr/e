name: Phantom Kernel Ultimate x SM8650 Full-Ext
run-name: Build v6.1.118 - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_ZIP: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_ZIP: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ [Step 01] ç¯å¢ƒæ·±åº¦æ¸…ç†
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: ğŸ› ï¸ [Step 02] å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python-is-python3 curl zip git ccache aria2 pahole dwarves \
            kmod cpio expect rsync libncurses-dev binutils-aarch64-linux-gnu

      - name: ğŸ“¥ [Step 03] åŒæ­¥å†…æ ¸æºç 
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_ZIP }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½² Clang 20 ç¼–è¯‘å™¨
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_ZIP }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip
          echo "Clang Version: $(${ { env.CLANG_ROOT } }/bin/clang --version | head -n 1)"

      - name: ğŸ“¡ [Step 05] å®˜æ–¹å¯¼å…¥ï¼šBBRv3 æºç æ›¿æ¢
        run: |
          cd workspace/common
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          # ç¡®ä¿ Defconfig åŒ…å« BBRv3 æ”¯æŒ
          echo "CONFIG_TCP_CONG_BBR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> arch/arm64/configs/gki_defconfig

      - name: ğŸ’‰ [Step 06] æ³¨å…¥ Phantom è°ƒåº¦å¼•æ“
        run: |
          cd workspace/common
          cat <<'EOF' > kernel/sched/phantom_engine.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          void apply_phantom_boost(struct task_struct *p) {
              if (p && p->comm && (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread"))) {
                  cpumask_t mask;
                  cpumask_clear(&mask);
                  cpumask_set_cpu(7, &mask);
                  set_cpus_allowed_ptr(p, &mask);
              }
          }
          EOF
          echo "obj-y += phantom_engine.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] GPU è·¯å¾„è‡ªä¿®å¤ä¸é¢‘ç‡é”
        run: |
          cd workspace/common
          GPU_DIR=$(find . -maxdepth 5 -name "adreno_dispatch.c" | xargs dirname | head -n 1)
          if [ -z "$GPU_DIR" ]; then GPU_DIR="drivers/gpu/msm"; fi
          mkdir -p "$GPU_DIR"
          cat <<'EOF' > "$GPU_DIR/phantom_gpu.c"
          #include <linux/module.h>
          void phantom_gpu_tune(unsigned int *f) { if (f && *f < 400000000) *f = 615000000; }
          EOF
          # ä¿®æ­£å¼•å·åµŒå¥—é—®é¢˜
          echo "obj-y += phantom_gpu.o" >> "$GPU_DIR/Makefile"

      - name: ğŸ›¡ï¸ [Step 08] BBG Guard å­˜å‚¨é˜²æŠ¤
        run: |
          cd workspace/common
          cat <<'EOF' > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          int check_safe_wipe(struct request *rq) {
              if (rq && rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == 0x11) return 1; // REQ_OP_SECURE_ERASE
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (check_safe_wipe(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: âš™ï¸ [Step 09] ä¿®æ­£ Error 2 (ç¦ç”¨ LTO/BTF/CFI)
        run: |
          cd workspace/common
          CONF="arch/arm64/configs/gki_defconfig"
          # ä½¿ç”¨æ›´å®‰å…¨çš„ sed æ›¿æ¢é€»è¾‘ï¼Œé¿å…å¼•å·åµŒå¥—
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          {
            echo "CONFIG_LTO_NONE=y"
            echo "CONFIG_CFI_CLANG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
          } >> $CONF
          sed -i 's/ -dirty//g' scripts/setlocalversion
          rm -f android/abi_gki_protected_exports_*

      - name: ğŸ’¾ [Step 10] æ¢å¤ Ccache ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: phantom-sm8650-${{ github.sha }}
          restore-keys: phantom-sm8650-

      - name: ğŸ—ï¸ [Step 11] æ‰§è¡Œç¼–è¯‘ (j2 é™æµç¨³å¥ç‰ˆ)
        run: |
          cd workspace/common
          export PATH="${{ env.CLANG_ROOT }}/bin:$PATH"
          # æ˜¾å¼å®šä¹‰æ‰€æœ‰å·¥å…·ï¼Œé¿å… Makefile æ‰¾ä¸åˆ°å·¥å…·è·¯å¾„
          ARGS="O=out ARCH=arm64 CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- CLANG_TRIPLE=aarch64-linux-gnu-"
          make $ARGS mrproper
          make $ARGS gki_defconfig
          # æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ ccache åŒ…è£…
          make -j2 $ARGS CC="ccache clang" V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [Step 12] AnyKernel3 å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMG" ak3/ 2>/dev/null || cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel.zip *
          else
            exit 1
          fi

      - name: ğŸ“¤ [Step 13] ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel
          path: |
            Phantom-Kernel.zip
            workspace/build_log.txt