name: Phantom Kernel Ultimate CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      CLANG_REPO: https://github.com/kdrag0n/proton-clang
      KERNEL_SRC: https://android.googlesource.com/kernel/common
      KERNEL_BRANCH: android12-5.10

    steps:
      - name: ğŸš€ 1. ç¯å¢ƒå‡†å¤‡
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl zip git libncurses-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ 2. åŒæ­¥æºç 
        run: |
          # å…‹éš†å†…æ ¸
          git clone --depth=1 ${{ env.KERNEL_SRC }} -b ${{ env.KERNEL_BRANCH }} kernel
          # å…‹éš†å®˜æ–¹ BBRv3 (Google ä»“åº“)
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3
          # å…‹éš†å·¥å…·é“¾
          git clone --depth=1 ${{ env.CLANG_REPO }} clang

      - name: ğŸ’‰ 3. æ³¨å…¥æ·±åº¦é€»è¾‘
        run: |
          cd kernel
          # --- [ç½‘ç»œ: å¼ºè¡Œè¦†ç›–å®˜æ–¹ BBRv3] ---
          # è¦†ç›– tcp_bbr.c å¹¶æ³¨å…¥å¿…è¦çš„å¯¼å‡ºç¬¦å·
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          
          # --- [è°ƒåº¦: ç‹¬ç«‹åŠ é€Ÿæ¨¡å—] ---
          cat <<EOF > kernel/sched/phantom_sched.c
          #include <linux/sched.h>
          #include <linux/string.h>
          void phantom_boost_task(struct task_struct *p) {
              if (p && p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "surfaceflinger"))) {
                  p->static_prio = 100;
              }
          }
          EOF
          echo "obj-y += phantom_sched.o" >> kernel/sched/Makefile

          # --- [è°ƒé€Ÿå™¨: SSG Governor] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          static int ssg_target(struct cpufreq_policy *p, unsigned int t, unsigned int r) {
              return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
          }
          static struct cpufreq_governor ssg_gov = {.name="samsung_ssg", .target=ssg_target};
          static int __init ssg_init(void) { return cpufreq_register_governor(&ssg_gov); }
          fs_initcall(ssg_init);
          EOF
          echo "obj-y += ssg_governor.o" >> drivers/cpufreq/phantom/Makefile
          echo "obj-y += phantom/" >> drivers/cpufreq/Makefile

          # --- [å®‰å…¨: BBG é˜²æ ¼æœº] ---
          sed -i '/mmc_blk_issue_discard_rq/i \    if (strstr(rq->rq_disk->disk_name, "mmcblk0")) { return -EPERM; }' drivers/mmc/core/block.c

      - name: ğŸ—ï¸ 4. è‡ªåŠ¨åŒ–ç¼–è¯‘
        run: |
          cd kernel
          CLANG_PATH=$GITHUB_WORKSPACE/clang/bin
          # æ•´åˆç¼–è¯‘å‚æ•°
          export MAKE_FLAGS="O=out ARCH=arm64 CC=$CLANG_PATH/clang LD=$CLANG_PATH/ld.lld AR=$CLANG_PATH/llvm-ar NM=$CLANG_PATH/llvm-nm OBJCOPY=$CLANG_PATH/llvm-objcopy OBJDUMP=$CLANG_PATH/llvm-objdump STRIP=$CLANG_PATH/llvm-strip CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1 HOSTCC=gcc HOSTCXX=g++"

          # 1. ç”Ÿæˆé…ç½®
          make $MAKE_FLAGS gki_defconfig
          
          # 2. åŠ¨æ€è°ƒæ•´é…ç½® (å…³é—­ WERROR æ˜¯å…³é”®)
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO_CLANG_THIN
            
          # 3. æ­£å¼ç¼–è¯‘
          make -j$(nproc --all) $MAKE_FLAGS

      - name: ğŸ“¦ 5. å°è£… AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          # æœç´¢å¹¶æ‹·è´ç”Ÿæˆçš„å†…æ ¸é•œåƒ
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          cd ak3 && rm -rf .git && zip -r9 ../Phantom-Kernel-BBRv3.zip *
          
      - name: ğŸ“¤ 6. å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-BBRv3-Release
          path: Phantom-Kernel-BBRv3.zip