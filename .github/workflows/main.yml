name: OKI Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ OKI æ¶æ„ä¸€åŠ å¹³æ¿ Pro æ»¡è¡€æ„å»º [ç‰©ç†ä¿®å¤ç‰ˆ] - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  # æ¢ç”¨ ZyC ç»´æŠ¤çš„ Clang 17 ç”Ÿäº§çº§ç›´é“¾ï¼Œé¿å¼€ Google Source çš„ 400 é”™è¯¯
  CLANG_URL: "https://github.com/ZyCromerZ/Clang/releases/download/17.0.0-20231010-release/Clang-17.0.0-20231010.tar.gz"
  CLANG_ROOT: "${{ github.workspace }}/clang-oki"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_oki"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"

jobs:
  ultimate_oki_build:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šåŸå­åŒ–ç¯å¢ƒéƒ¨ç½² (ä¿æŒç‰©ç†å¹³é“º)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] ç‰©ç†ç©ºé—´å›æ”¶ 01
        run: sudo docker image prune -a -f
      - name: ğŸ§¹ [Step 02] ç‰©ç†ç©ºé—´å›æ”¶ 02
        run: sudo rm -rf /usr/share/dotnet
      - name: ğŸ§¹ [Step 03] ç‰©ç†ç©ºé—´å›æ”¶ 03
        run: sudo rm -rf /usr/local/lib/android
      - name: ğŸ§¹ [Step 04] ç‰©ç†ç©ºé—´å›æ”¶ 04
        run: sudo rm -rf /opt/ghc
      - name: ğŸ§¹ [Step 05] ç‰©ç†ç©ºé—´å›æ”¶ 05
        run: sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
      - name: ğŸ§¹ [Step 06] ç‰©ç†ç©ºé—´å›æ”¶ 06
        run: sudo apt-get autoremove -y && sudo apt-get clean && df -h

      - name: ğŸ› ï¸ [Step 07] éƒ¨ç½²ä¾èµ– - bc
        run: sudo apt-get install -y bc
      - name: ğŸ› ï¸ [Step 08] éƒ¨ç½²ä¾èµ– - flex
        run: sudo apt-get install -y flex
      - name: ğŸ› ï¸ [Step 09] éƒ¨ç½²ä¾èµ– - bison
        run: sudo apt-get install -y bison
      - name: ğŸ› ï¸ [Step 10] éƒ¨ç½²ä¾èµ– - libssl
        run: sudo apt-get install -y libssl-dev
      - name: ğŸ› ï¸ [Step 11] éƒ¨ç½²ä¾èµ– - libelf
        run: sudo apt-get install -y libelf-dev
      - name: ğŸ› ï¸ [Step 12] éƒ¨ç½²ä¾èµ– - python3
        run: sudo apt-get install -y python3 python3-dev
      - name: ğŸ› ï¸ [Step 13] éƒ¨ç½²ä¾èµ– - aria2
        run: sudo apt-get install -y aria2
      - name: ğŸ› ï¸ [Step 14] éƒ¨ç½²ä¾èµ– - lz4
        run: sudo apt-get install -y lz4 liblz4-tool
      - name: ğŸ› ï¸ [Step 15] éƒ¨ç½²ä¾èµ– - dtc
        run: sudo apt-get install -y device-tree-compiler

      - name: ğŸ“¥ [Step 16] ä¸‹è½½ OKI æºç 
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 17] ä¸‹è½½ç”Ÿäº§çº§ Clang (ä¿®æ­£ 400 é”™è¯¯)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          cd ${{ github.workspace }}
          # å¢åŠ  User-Agent ä¼ªè£…ï¼Œé˜²æ­¢è¢«æœåŠ¡ç«¯æ‹¦æˆª
          aria2c -s16 -x16 -k1M --user-agent="Mozilla/5.0" "${{ env.CLANG_URL }}" -o clang.tar.gz
          tar -C ${{ env.CLANG_ROOT }} -xzf clang.tar.gz && rm clang.tar.gz
          echo "==== ç¼–è¯‘å™¨å®Œæ•´æ€§æ ¡éªŒ ===="
          ${{ env.CLANG_ROOT }}/bin/clang --version

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šOKI æ ¸å¿ƒé…ç½®ç‰©ç†æ³¨å…¥ (ç‰©ç†å±•å¼€)
      # ========================================================================
      - name: âš™ï¸ [Step 18] OKI Config - æ³¨å…¥ç½‘ç»œåŠ é€Ÿ
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONF
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> $CONF
      
      - name: âš™ï¸ [Step 19] OKI Config - æ³¨å…¥è°ƒåº¦ä¼˜åŒ–
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_HZ_1000=y" >> $CONF
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $CONF
          echo "CONFIG_SCHED_WALT=y" >> $CONF

      - name: âš™ï¸ [Step 20] OKI Config - æ³¨å…¥å†…å­˜ä¼˜åŒ–
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          echo "CONFIG_ZRAM=y" >> $CONF
          echo "CONFIG_ZRAM_DEF_COMP_LZ4=y" >> $CONF
          echo "CONFIG_LZ4_COMPRESS=y" >> $CONF

      - name: âš™ï¸ [Step 21] OKI Config - å¼ºåˆ¶éš”ç¦» GKI é™åˆ¶
        run: |
          CONF="workspace/common/arch/arm64/configs/gki_defconfig"
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          echo "CONFIG_LTO_NONE=y" >> $CONF
          echo "CONFIG_UNUSED_SYMBOLS=y" >> $CONF
          echo "CONFIG_TRIM_UNUSED_KSYMS=n" >> $CONF
          echo "CONFIG_DEBUG_INFO_BTF=n" >> $CONF

      - name: ğŸ’‰ [Step 22] ç‰©ç†æ³¨å…¥ OKI é€»è¾‘æ ¸å¿ƒ C ä»£ç 
        run: |
          cd workspace/common/kernel/sched/
          echo "æ­£åœ¨ç‰©ç†ç”Ÿæˆ oki_logic.c ..."
          printf "#include <linux/sched.h>\n#include <linux/cpumask.h>\n#include <linux/module.h>\n" > oki_logic.c
          printf "void apply_oki_policy(struct task_struct *p) {\n" >> oki_logic.c
          printf "  if (p && p->comm && (strstr(p->comm, \"surfaceflinger\") || strstr(p->comm, \"RenderThread\"))) {\n" >> oki_logic.c
          printf "    cpumask_t mask; cpumask_clear(&mask); cpumask_set_cpu(7, &mask);\n" >> oki_logic.c
          printf "    set_cpus_allowed_ptr(p, &mask);\n" >> oki_logic.c
          printf "  }\n}\nEXPORT_SYMBOL_GPL(apply_oki_policy);\n" >> oki_logic.c
          echo "obj-y += oki_logic.o" >> Makefile

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æµç¨‹åŸå­åŒ–æ‰§è¡Œ (ç‰©ç†ç¯å¢ƒå˜é‡å¹³é“º)
      # ========================================================================
      - name: ğŸ“‚ [Step 23] æŒ‚è½½ Ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: oki-ccache-sm8650-fix-${{ github.sha }}
          restore-keys: oki-ccache-sm8650-fix-

      - name: ğŸ—ï¸ [Step 24] ç‰©ç†å¯¹é½å·¥å…·é“¾è·¯å¾„
        run: echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH

      - name: ğŸ—ï¸ [Step 25] ç‰©ç†å£°æ˜ LLVM å·¥å…·é›†
        run: |
          {
            echo "ARCH=arm64"
            echo "SUBARCH=arm64"
            echo "LLVM=1"
            echo "LLVM_IAS=1"
            echo "CC=ccache clang"
            echo "LD=ld.lld"
            echo "AR=llvm-ar"
            echo "NM=llvm-nm"
            echo "OBJCOPY=llvm-objcopy"
            echo "STRIP=llvm-strip"
            echo "CCACHE_DIR=${{ env.CCACHE_DIR }}"
          } >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 26] OKI æ„å»º - åˆå§‹åŒ–é…ç½®
        run: |
          cd workspace/common
          make O=out ARCH=arm64 gki_defconfig
          yes "" | make O=out ARCH=arm64 olddefconfig

      - name: ğŸ—ï¸ [Step 27] OKI æ„å»º - å¯¼å‡ºå¤´æ–‡ä»¶ (åˆ†é˜¶æ®µåŸå­æ“ä½œ)
        run: |
          cd workspace/common
          make O=out ARCH=arm64 headers_install

      - name: ğŸ—ï¸ [Step 28] OKI æ„å»º - æ‰§è¡Œå†…æ ¸ Image ç¼–è¯‘
        run: |
          cd workspace/common
          export KCFLAGS="-march=armv8-a+crc+crypto -O3 -pipe"
          make -j$(nproc) O=out ARCH=arm64 KCFLAGS="$KCFLAGS" V=1 Image 2>&1 | tee ../image_log.txt

      - name: ğŸ—ï¸ [Step 29] OKI æ„å»º - æ‰§è¡Œ DTBS ç¼–è¯‘
        run: |
          cd workspace/common
          make -j$(nproc) O=out ARCH=arm64 dtbs 2>&1 | tee ../dtbs_log.txt

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šç‰©ç†æˆæœå°è£…
      # ========================================================================
      - name: ğŸ“¦ [Step 30] å‡†å¤‡ AnyKernel3
        run: git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
      
      - name: ğŸ“¦ [Step 31] ç‰©ç†å½’æ¡£ Image ä¸ DTB
        run: |
          cp workspace/common/out/arch/arm64/boot/Image ak3/
          find workspace/common/out/arch/arm64/boot/dts/qcom/ -name "*.dtb" -exec cp {} ak3/dtb \; || true

      - name: ğŸ“¦ [Step 32] ç‰©ç†æ‰“åŒ…å¹¶å‘å¸ƒæˆæœ
        run: |
          cd ak3
          sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
          zip -r9 ../OKI-Kernel-SM8650-Fixed.zip *

      - name: ğŸ“¤ [Step 33] ä¸Šä¼ æœ€ç»ˆäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OKI-Final-Artifact
          path: |
            OKI-Kernel-SM8650-Fixed.zip
            workspace/*.txt

      - name: ğŸ“Š [Step 34] æ‰“å°ç»Ÿè®¡
        run: ccache -s