name: Phantom Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - ç‰©ç†æ»¡è¡€ç‰ˆ

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šæè‡´ç¯å¢ƒåˆå§‹åŒ– (ç‰©ç†å±•å¼€)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] è™šæ‹Ÿæœºç£ç›˜ç©ºé—´æ·±åº¦é‡Šæ”¾ (ç‰©ç†å†—ä½™æ¸…ç†)
        run: |
          echo "==== [DEBUG] æ­£åœ¨æ‰«æç³»ç»Ÿé¢„ç•™å†—ä½™æ–‡ä»¶ ===="
          df -h
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo rm -rf /usr/local/bin/aliyun /usr/local/bin/az /usr/local/bin/kubectl
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "==== [DEBUG] æ¸…ç†å®Œæˆï¼Œå½“å‰å¯ç”¨ç©ºé—´å¦‚ä¸‹ ===="
          df -h

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²å·¥ä¸šçº§äº¤å‰ç¼–è¯‘ä¾èµ– (å…¨é‡è¡¥é½)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python3-dev python-is-python3 curl zip git ccache aria2 \
            pahole dwarves kmod cpio expect rsync libncurses-dev \
            binutils-aarch64-linux-gnu binutils-arm-linux-gnueabi \
            wget tar libarchive-tools lz4 liblz4-tool zstd libzstd-dev

      - name: ğŸ“¥ [Step 03] åŒæ­¥ä¸€åŠ  sm8650 æºç  (ç‰©ç†é“¾è·¯æ ¡éªŒ)
        run: |
          mkdir -p workspace && cd workspace
          echo "æ­£åœ¨è¿æ¥è¿œç¨‹ä»“åº“åŒæ­¥ sm8650_v_15.0.0 æ ¸å¿ƒä»£ç ..."
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          [ -f kernel.zip ] || (echo "ä¸‹è½½å¤±è´¥" && exit 1)
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip

      - name: ğŸ“¥ [Step 04] éƒ¨ç½² LLVM-Clang 20 (é’ˆå¯¹ Cortex-X4 ç‰¹åŒ–ç‰ˆ)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip
          echo "Clang 20 ç¼–è¯‘å™¨å“ˆå¸Œå€¼æ ¡éªŒä¸­..."
          ${{ env.CLANG_ROOT }}/bin/clang --version

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šå†…æ ¸é€»è¾‘æ·±åº¦æ³¨å…¥ (ç‰©ç†å±•å¼€ C ä»£ç )
      # ========================================================================
      - name: ğŸ“¡ [Step 05] ç½‘ç»œåè®®æ ˆï¼šå®˜æ–¹ BBRv3 é€»è¾‘å…¨é‡é‡æ„
        run: |
          cd workspace/common
          echo "æ­£åœ¨ç§»é™¤æ—§ç‰ˆ TCP æ‹¥å¡æ§åˆ¶é€»è¾‘..."
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          
          echo "æ­£åœ¨æ³¨å…¥ BBRv3 ç¡¬ä»¶åŠ é€Ÿå®å®šä¹‰..."
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig
          cat <<'EOF' >> arch/arm64/configs/gki_defconfig
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_NET_SCH_FQ_CODEL=y
          CONFIG_NET_SCH_CAKE=y
          CONFIG_BPF_SYSCALL=y
          CONFIG_NET_CLS_BPF=y
          CONFIG_NET_ACT_BPF=y
          CONFIG_BPF_JIT=y
          CONFIG_BPF_JIT_ALWAYS_ON=y
          EOF

      - name: ğŸ’‰ [Step 06] è°ƒåº¦å™¨å†…æ ¸çº§è¡¥ä¸ï¼šPhantom Engine æ»¡è¡€ç‰ˆ
        run: |
          cd workspace/common
          echo "æ­£åœ¨ç¼–å†™é’ˆå¯¹ sm8650 (1+3+2+2) æ¶æ„çš„ä»»åŠ¡è´Ÿè½½å‡è¡¡é€»è¾‘..."
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>
          #include <linux/sched/rt.h>

          /* æåº¦æ¿€è¿›çš„è°ƒåº¦ç­–ç•¥ï¼šå°†æ¸²æŸ“å…³é”®çº¿ç¨‹å¼ºåˆ¶æ³µå…¥ CPU 7 (X4 æ ¸å¿ƒ) */
          void apply_phantom_policy(struct task_struct *p) {
              if (p && p->comm) {
                  if (strstr(p->comm, "surfaceflinger") || 
                      strstr(p->comm, "RenderThread") || 
                      strstr(p->comm, "hwcomposer") ||
                      strstr(p->comm, "com.android.systemui")) {
                      
                      cpumask_t ui_mask;
                      cpumask_clear(&ui_mask);
                      cpumask_set_cpu(7, &ui_mask); /* é”å®šè¶…å¤§æ ¸ */
                      
                      if (p->nr_cpus_allowed > 1) {
                          set_cpus_allowed_ptr(p, &ui_mask);
                      }
                      
                      /* æå‡å®æ—¶ä¼˜å…ˆçº§ */
                      if (p->policy == SCHED_NORMAL) {
                          p->static_prio = 95; 
                      }
                  }
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] Adreno 750 GPU é¢‘ç‡é”ä¸æ¸©æ§æ‹¦æˆª
        run: |
          cd workspace/common
          echo "æ‰«æ GPU é©±åŠ¨ä½ç‚¹..."
          GPU_DIR=$(find . -maxdepth 5 -name "adreno_dispatch.c" | xargs dirname | head -n 1)
          [ -z "$GPU_DIR" ] && GPU_DIR="drivers/gpu/msm"
          
          cat <<'EOF' > "$GPU_DIR/phantom_gpu_boost.c"
          #include <linux/module.h>
          /* é˜»æ­¢ Adreno GPU åœ¨ 144Hz åœºæ™¯ä¸‹å› ç­–ç•¥ä¸å½“è€Œé™é¢‘ */
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 480000000) {
                  *freq = 615000000; /* é”å®šæœ€ä½ 615MHz */
              }
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> "$GPU_DIR/Makefile"

      - name: ğŸ§¬ [Step 08] å†…å­˜åŠ é€Ÿï¼šZRAM ä¸ LZ4-Ultra ç®—æ³•å¹³é“º
        run: |
          cd workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git p_repo
          cd common
          echo "æ­£åœ¨ç‰©ç†åº”ç”¨ LZ4 ARM64 æ±‡ç¼–ä¼˜åŒ–è¡¥ä¸..."
          git apply -p1 < ../p_repo/zram_patch/001-lz4.patch || true
          cp ../p_repo/zram_patch/lz4armv8.S lib/ 2>/dev/null
          
          cat <<'EOF' >> arch/arm64/configs/gki_defconfig
          CONFIG_ZRAM=y
          CONFIG_ZRAM_DEF_COMP_LZ4=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_LZ4HC_COMPRESS=y
          CONFIG_LZ4_DECOMPRESS=y
          EOF

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘æ ¸å¿ƒå‚æ•°ä¸“é¡¹ (ç‰©ç†å±•å¼€ Polly ä¸ SM8650 ç‰¹åŒ–)
      # ========================================================================
      - name: âš™ï¸ [Step 09] ç¨³å®šæ€§ä¸ç¬¦å·ä¿®æ­£ï¼šç‰©ç†å‰”é™¤å†²çª
        run: |
          cd workspace/common
          echo "æ­£åœ¨ç‰©ç†ç§»é™¤ Sony/Xperia æŠ¥é”™è®¾å¤‡æ ‘..."
          sed -i '/sony/d' arch/arm64/boot/dts/qcom/Makefile
          
          echo "æ­£åœ¨æ³¨å…¥ LTO-NONE ç¨³å®šæ€§è¡¥ä¸..."
          CONF="arch/arm64/configs/gki_defconfig"
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          {
            echo "CONFIG_LTO_NONE=y"
            echo "CONFIG_CFI_CLANG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
            echo "CONFIG_KPROBES=n"
            echo "CONFIG_HZ_1000=y"
          } >> $CONF
          sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' $CONF
          sed -i 's/ -dirty//g' scripts/setlocalversion

      - name: ğŸ“‚ [Step 10] Ccache æŒä¹…åŒ–ç¼“å­˜åŠ è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-full-service-${{ github.sha }}
          restore-keys: ccache-sm8650-full-service-

      - name: ğŸ—ï¸ [Step 11] ç¯å¢ƒç‰©ç†å¯¹é½ (å…¨é‡è·¯å¾„å±•å¼€)
        run: |
          cd workspace/common
          mkdir -p out
          cp arch/arm64/configs/gki_defconfig out/.config
          
          echo "PATH=${{ env.CLANG_ROOT }}/bin:$PATH" >> $GITHUB_ENV
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=Phantom" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=Ultra-Machine" >> $GITHUB_ENV

      - name: ğŸ—ï¸ [Step 12] æ»¡è¡€ç¼–è¯‘æ‰§è¡Œï¼šClang 20 + Polly æ·±åº¦ä¼˜åŒ–
        run: |
          cd workspace/common
          
          # ç‰©ç†å±•å¼€æ‰€æœ‰çš„ç¼–è¯‘å™¨ Flag
          # åŒ…å« Polly å¾ªç¯é‡æ„ã€sm8650 æŒ‡ä»¤é›†ç‰¹åŒ–ã€å¯„å­˜å™¨ä¼˜åŒ–
          export KCFLAGS="-march=armv9.2-a+crypto+fp16+dotprod -mtune=neoverse-v2 \
            -mllvm -polly \
            -mllvm -polly-ast-detect-unprofitable \
            -mllvm -polly-run-inliner \
            -mllvm -polly-vectorizer=stripmine \
            -mllvm -polly-reschedule=true \
            -mllvm -polly-opt-fusion=max \
            -mllvm -polly-check-parallel=true \
            -O3 -pipe -fno-strict-aliasing"

          # ç‰©ç†å®šä¹‰æ‰€æœ‰çš„ç¼–è¯‘å·¥å…·
          export LLVM=1
          export LLVM_IAS=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CC="ccache clang"
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip

          echo "==== [PHASE A] åŒæ­¥æ—§é…ç½®è‡ªé€‚åº” ===="
          yes "" | make O=out ARCH=arm64 olddefconfig
          
          echo "==== [PHASE B] å¯åŠ¨å†…æ ¸ä¸»é•œåƒé“¾æ¥ (Image) ===="
          make -j2 O=out ARCH=arm64 V=1 Image 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šå…¨é‡å°è£…ä¸å‘å¸ƒ
      # ========================================================================
      - name: ğŸ“¦ [Step 13] AnyKernel3 æ»¡è¡€ç‰ˆåˆ·æœºåŒ…åˆ¶ä½œ
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            # ç‰©ç†ä¿®æ”¹åˆ·æœºæè¿°ï¼Œå¢åŠ å°Šè´µæ„Ÿ
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            sed -i 's/patch_vbmeta_flag=0/patch_vbmeta_flag=1/g' anykernel.sh
            zip -r9 ../Phantom-Kernel-SM8650-Ultra.zip *
          else
            echo "è‡´å‘½é”™è¯¯ï¼šImage æ–‡ä»¶ç¼ºå¤±" && exit 1
          fi

      - name: ğŸ“¤ [Step 14] å…¨é‡å‘å¸ƒæ„å»ºæˆæœ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release-Full
          path: |
            Phantom-Kernel-SM8650-Ultra.zip
            workspace/build_log.txt
            workspace/common/out/.config

      - name: ğŸ“Š [Step 15] ç¼–è¯‘ç»Ÿè®¡ä¸ Ccache çŠ¶æ€
        run: |
          echo "==== æœ€ç»ˆä»»åŠ¡æ¦‚è§ˆ ===="
          ccache -s
          df -h
          echo "Phantom Kernel Ultimate æ„å»ºä»»åŠ¡å·²åœ†æ»¡å®Œæˆã€‚"