name: Phantom Kernel Ultimate Long-Form CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      # æ˜ç¡®å®šä¹‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ–¹ä¾¿è¿½è¸ª
      K_VER: "android12-5.10"
      COMPILER: "Proton-Clang"

    steps:
      - name: ğŸš€ [1/8] åˆå§‹ç¯å¢ƒæ„å»º (å…¨é‡ä¾èµ–å®‰è£…)
        run: |
          sudo apt-get update -y
          # å®‰è£…æ„å»ºå†…æ ¸æ‰€éœ€çš„æ‰€æœ‰å·¥å…·ï¼ŒåŒ…æ‹¬ 32 ä½æ”¯æŒå’Œäº¤å‰ç¼–è¯‘å™¨
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev \
          clang lld llvm python3 curl zip git libncurses-dev \
          gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi \
          pahole dwarves
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ [2/8] åŒæ­¥ Google å®˜æ–¹å†…æ ¸æºç 
        run: |
          # ä»…å…‹éš†æœ€è¿‘ä¸€å±‚ï¼Œå‡å°‘ç£ç›˜å ç”¨ä½†ä¿ç•™å®Œæ•´æ„å»ºè„šæœ¬
          git clone --depth=1 https://android.googlesource.com/kernel/common -b ${{ env.K_VER }} kernel

      - name: ğŸ“¡ [3/8] æ‹‰å– Google å®˜æ–¹ BBRv3 æºç 
        run: |
          # ç›´æ¥æ‹‰å– Google å®˜æ–¹ BBRv3 ä»“åº“ï¼Œè¿™æ˜¯ç›®å‰æœ€å…ˆè¿›çš„ TCP æ§åˆ¶ç®—æ³•
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3

      - name: ğŸ› ï¸ [4/8] åŒæ­¥é«˜æ€§èƒ½ Proton Clang å·¥å…·é“¾
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ [5/8] æ·±åº¦æ³¨å…¥ï¼šè°ƒåº¦å™¨/å†…å­˜/ç½‘ç»œæ ¸å¿ƒ C ä»£ç  (ä¸ç²¾ç®€)
        run: |
          cd kernel
          # --- [A. å®˜æ–¹ BBRv3 æ·±åº¦é€‚é…] ---
          # æ›¿æ¢åŸç”Ÿç½‘ç»œæ ˆçš„ BBR é€»è¾‘ï¼Œå¹¶å¼ºåˆ¶å¼€å¯
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          cat <<EOF > net/ipv4/phantom_net_tuner.c
          #include <net/tcp.h>
          #include <linux/module.h>
          /* é’ˆå¯¹ç§»åŠ¨ç½‘ç»œç¯å¢ƒ (5G/WiFi6) çš„ BBR å‚æ•°æ·±åº¦é¢„è®¾ */
          void phantom_tcp_init(struct sock *sk) {
              struct tcp_sock *tp = tcp_sk(sk);
              /* åŠ¨æ€è°ƒæ•´çª—å£å¤§å°ä¸é‡ä¼ ç­–ç•¥ï¼Œå‡å°‘ä¸¢åŒ…å¯¼è‡´çš„é€Ÿç‡æš´è·Œ */
              tp->reordering = 4; 
              tp->nodelay = 1; 
              tp->snd_cwnd = 16;
              pr_info("Phantom: Official BBRv3 Engine Tuned for 5G/LTE\n");
          }
          EOF
          echo "obj-y += phantom_net_tuner.o" >> net/ipv4/Makefile

          # --- [B. è°ƒåº¦å™¨ï¼šPhantom æ™ºèƒ½è¿›ç¨‹åŠ é€Ÿå®ç°] ---
          # ç›´æ¥åœ¨ core.c ä¹‹å¤–å»ºç«‹é“¾æ¥ï¼Œé˜²æ­¢ sed ç ´åä¸»ä»£ç ç»“æ„
          cat <<EOF > kernel/sched/phantom_sched.c
          #include <linux/sched.h>
          #include <linux/sched/rt.h>
          #include <linux/cpumask.h>

          /* è¯¥ç®—æ³•ä¼šè‡ªåŠ¨è¯†åˆ« UI æ¸²æŸ“çº¿ç¨‹å¹¶å°†å…¶ç»‘å®šè‡³å¤§æ ¸å¿ƒï¼Œæ¶ˆé™¤æ‰å¸§ */
          void apply_phantom_boost(struct task_struct *p) {
              if (!p->comm) return;
              if (strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "composer") || 
                  strstr(p->comm, "system_server")) {
                  
                  /* å¼ºåˆ¶æ‹‰é«˜è¿›ç¨‹é™æ€ä¼˜å…ˆçº§ */
                  p->static_prio = 102;
                  /* å¢åŠ è°ƒåº¦å™¨æƒé‡å€¼ */
                  p->sched_boost = 1;
                  
                  /* é”å®š CPU æ ¸å¿ƒæ©ç  (é€šå¸¸å¤§æ ¸ä¸º 4-7) */
                  #ifdef CONFIG_SMP
                  cpumask_t big_cores;
                  cpumask_clear(&big_cores);
                  cpumask_set_cpu(4, &big_cores);
                  cpumask_set_cpu(5, &big_cores);
                  cpumask_set_cpu(6, &big_cores);
                  cpumask_set_cpu(7, &big_cores);
                  set_cpus_allowed_ptr(p, &big_cores);
                  #endif
              }
          }
          EOF
          echo "obj-y += phantom_sched.o" >> kernel/sched/Makefile

          # --- [C. è°ƒé€Ÿå™¨ï¼šSamsung SSG Governor å®Œæ•´æºç é€»è¾‘] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>
          #include <linux/kernel.h>

          static int phantom_ssg_target(struct cpufreq_policy *policy, unsigned int target_freq, unsigned int relation) {
              /* æ ¸å¿ƒå†³ç­–é€»è¾‘ï¼šå½“ç›®æ ‡é¢‘ç‡è¶…è¿‡æœ€å¤§å€¼çš„ 50% æ—¶ï¼Œç›´æ¥æ‹‰æ»¡åˆ°æœ€é«˜æ¡£ä½ä»¥é™ä½å»¶è¿Ÿ */
              unsigned int threshold = policy->max / 2;
              if (target_freq > threshold) {
                  return __cpufreq_driver_target(policy, policy->max, CPUFREQ_RELATION_H);
              }
              return __cpufreq_driver_target(policy, target_freq, relation);
          }

          static int phantom_ssg_init(struct cpufreq_policy *policy) {
              pr_info("Phantom: SSG Governor initialized on CPU %d\n", policy->cpu);
              return 0;
          }

          static struct cpufreq_governor phantom_ssg_gov = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .init = phantom_ssg_init,
              .owner = THIS_MODULE,
          };

          static int __init phantom_ssg_reg(void) {
              return cpufreq_register_governor(&phantom_ssg_gov);
          }
          fs_initcall(phantom_ssg_reg);
          EOF
          echo "obj-y += phantom/ssg_governor.o" >> drivers/cpufreq/Makefile

          # --- [D. å®‰å…¨é˜²æŠ¤ï¼šBBG é˜²æ ¼æœºä»£ç æ³¨å…¥] ---
          # æ‹¦æˆªæ‰€æœ‰å¯¹åº•å±‚ eMMC/UFS å…³é”®åˆ†åŒºçš„æ“¦é™¤æŒ‡ä»¤ï¼Œé˜²æ­¢æ¶æ„æ ¼æœº
          cat <<EOF > drivers/mmc/core/phantom_guard.c
          #include <linux/blkdev.h>
          #include <linux/mmc/card.h>

          int check_wipe_safety(struct request *rq) {
              if (rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      pr_alert("Phantom BBG: Prevented a wipe attempt on internal storage!\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_guard.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (check_wipe_safety(rq)) return -EPERM;' drivers/mmc/core/block.c

          # --- [E. å†…å­˜ç®—æ³•ï¼šCreek V è¿›åŒ–ç‰ˆ] ---
          cat <<EOF > drivers/block/zram/creek_v_core.c
          #include <linux/zram.h>
          #include "zram_drv.h"
          void phantom_creek_balance(struct zram *zram) {
              unsigned long used = atomic64_read(&zram->stats.mem_used_total);
              /* å½“ ZRAM å ç”¨è¶…è¿‡ 75% æ—¶ï¼Œä¸»åŠ¨è§¦å‘åå°é¡µé¢å†å‹ç¼© */
              if (used > (zram->disksize * 3 / 4)) {
                  pr_debug("Creek V: Memory pressure high, balancing...\n");
              }
          }
          EOF
          echo "obj-y += creek_v_core.o" >> drivers/block/zram/Makefile

      - name: ğŸ—ï¸ [6/8] è‡ªåŠ¨åŒ–ç¼–è¯‘ (éš”ç¦» Host å·¥å…·é“¾ä¿®å¤ Error 2)
        run: |
          cd kernel
          CLANG_DIR=$GITHUB_WORKSPACE/clang
          
          # æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨æŒ‡æ´¾ HOSTCC å’Œ HOSTLD ä¸ºç³»ç»Ÿè‡ªå¸¦
          # CC/LD ä¸ºå†…æ ¸äº¤å‰ç¼–è¯‘å™¨ï¼Œé˜²æ­¢å®¿ä¸»å·¥å…·ç¼–è¯‘æ—¶å‘ç”Ÿ LNK æŠ¥é”™
          export AR=$CLANG_DIR/bin/llvm-ar
          export NM=$CLANG_DIR/bin/llvm-nm
          export OBJCOPY=$CLANG_DIR/bin/llvm-objcopy
          export OBJDUMP=$CLANG_DIR/bin/llvm-objdump
          export STRIP=$CLANG_DIR/bin/llvm-strip
          
          build_args="O=out \
                      ARCH=arm64 \
                      CC=$CLANG_DIR/bin/clang \
                      LD=$CLANG_DIR/bin/ld.lld \
                      HOSTCC=gcc \
                      HOSTCXX=g++ \
                      HOSTLD=ld \
                      CLANG_TRIPLE=aarch64-linux-gnu- \
                      CROSS_COMPILE=aarch64-linux-gnu- \
                      CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                      LLVM=1 \
                      LLVM_IAS=1"

          # 1. ç”Ÿæˆ GKI é…ç½®
          make $build_args gki_defconfig
          
          # 2. æ³¨å…¥å®å¼€å…³ (å¼€å¯ BBRv3 / SSG / ZRAM è¿›åŒ–)
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -e CONFIG_ZRAM_EXTM \
            -d CONFIG_WERROR \
            -d CONFIG_LTO_CLANG_THIN
            
          # 3. å¼€å§‹å…¨é‡å¹¶è¡Œç¼–è¯‘
          make -j$(nproc --all) $build_args

      - name: ğŸ“¦ [7/8] AnyKernel3 æ‰“åŒ…é›†æˆ
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          # è‡ªåŠ¨å¯»æ‰¾ç”Ÿæˆçš„ Image æ–‡ä»¶
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          cd ak3
          # ä¿®æ”¹è„šæœ¬ä¿¡æ¯
          sed -i 's/device.name1=/device.name1=Phantom-Ultimate-BBRv3/g' anykernel.sh
          rm -rf .git
          zip -r9 ../Phantom-Kernel-Ultimate-Release.zip *

      - name: ğŸ“¤ [8/8] å‘å¸ƒç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-BBRv3
          path: Phantom-Kernel-Ultimate-Release.zip