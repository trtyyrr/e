name: Phantom Kernel Ultimate CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
    steps:
      - name: ğŸš€ 1. ç¯å¢ƒå‡†å¤‡
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl zip git libncurses-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ 2. åŒæ­¥æºç 
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: ğŸ’‰ 3. æ·±åº¦æ³¨å…¥æ ¸å¿ƒä»£ç  (ä¸ç¼©å‡)
        run: |
          cd kernel
          # BBRv3 å®˜æ–¹é€»è¾‘é€‚é…
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          sed -i 's/obj-$(CONFIG_TCP_CONG_BBR) += tcp_bbr.o/obj-y += tcp_bbr.o/g' net/ipv4/Makefile

          # è·¨æ ¸è°ƒåº¦åŠ é€Ÿ
          cat <<EOF > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          void phantom_boost_logic(struct task_struct *p) {
              if (p && p->comm && (strstr(p->comm, "RenderThread") || strstr(p->comm, "surfaceflinger"))) {
                  p->static_prio = 105; 
                  p->sched_boost = 1;
              }
          }
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

          # Samsung SSG Governor
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>
          static int phantom_ssg_target(struct cpufreq_policy *p, unsigned int tf, unsigned int r) {
              if (tf > (p->max * 6 / 10)) return __cpufreq_driver_target(p, p->max, CPUFREQ_RELATION_H);
              return __cpufreq_driver_target(p, tf, r);
          }
          static struct cpufreq_governor p_ssg = {.name="samsung_ssg", .target=phantom_ssg_target, .owner=THIS_MODULE};
          static int __init p_ssg_init(void) { return cpufreq_register_governor(&p_ssg); }
          fs_initcall(p_ssg_init);
          EOF
          echo "obj-y += phantom/ssg_governor.o" >> drivers/cpufreq/Makefile

          # BBG é˜²æ ¼æœº
          sed -i '/mmc_blk_issue_discard_rq/i if (rq && rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) return -EPERM;' drivers/mmc/core/block.c

      - name: ğŸ—ï¸ 4. è‡ªåŠ¨åŒ–ç¼–è¯‘ (éš”ç¦» HOST é“¾æ¥å™¨)
        run: |
          cd kernel
          CLANG_DIR=$GITHUB_WORKSPACE/clang
          
          # å®šä¹‰å‚æ•°ï¼šå…³é”®åœ¨äºæ˜¾å¼æŒ‡å®š HOSTLDFLAGS å’Œ HOSTLD
          # å¼ºåˆ¶å®¿ä¸»å·¥å…·ä½¿ç”¨ç³»ç»Ÿ ld (/usr/bin/ld)ï¼Œå†…æ ¸ä½¿ç”¨ proton ld.lld
          args="O=out \
                ARCH=arm64 \
                CC=$CLANG_DIR/bin/clang \
                LD=$CLANG_DIR/bin/ld.lld \
                AR=$CLANG_DIR/bin/llvm-ar \
                NM=$CLANG_DIR/bin/llvm-nm \
                OBJCOPY=$CLANG_DIR/bin/llvm-objcopy \
                OBJDUMP=$CLANG_DIR/bin/llvm-objdump \
                STRIP=$CLANG_DIR/bin/llvm-strip \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=aarch64-linux-gnu- \
                CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                HOSTCC=gcc \
                HOSTCXX=g++ \
                HOSTLD=ld \
                HOSTLDFLAGS=-L/usr/lib/x86_64-linux-gnu"

          # 1. ç”Ÿæˆé…ç½®
          make $args gki_defconfig
          
          # 2. å®è°ƒæ•´
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -d CONFIG_WERROR \
            -d CONFIG_LTO_CLANG_THIN
            
          # 3. ç¼–è¯‘
          make -j$(nproc --all) $args

      - name: ğŸ“¦ 5. å°è£… AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          cd ak3 && rm -rf .git && zip -r9 ../Phantom-Kernel-Ultimate.zip *
          
      - name: ğŸ“¤ 6. å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release
          path: Phantom-Kernel-Ultimate.zip