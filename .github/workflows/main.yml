name: Phantom Kernel Ultimate CI
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      CLANG_REPO: https://github.com/kdrag0n/proton-clang
      KERNEL_SRC: https://android.googlesource.com/kernel/common
      KERNEL_BRANCH: android12-5.10

    steps:
      - name: ğŸš€ 1. ç¯å¢ƒå‡†å¤‡
        run: |
          sudo apt-get update -y
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl zip git libncurses-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          echo "BUILD_TIME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: ğŸ“¥ 2. åŒæ­¥æºç 
        run: |
          git clone --depth=1 ${{ env.KERNEL_SRC }} -b ${{ env.KERNEL_BRANCH }} kernel
          git clone --depth=1 https://github.com/google/bbr.git -b v3 bbr_v3
          git clone --depth=1 ${{ env.CLANG_REPO }} clang

      - name: ğŸ’‰ 3. æ·±åº¦æ³¨å…¥ 400+ è¡Œæ ¸å¿ƒä»£ç 
        run: |
          cd kernel

          # --- [A. å®˜æ–¹ BBRv3 é€‚é…é€»è¾‘] ---
          cp ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          # ä¿®æ”¹ Makefile ç¡®ä¿æ”¯æŒ BBRv3
          sed -i 's/obj-$(CONFIG_TCP_CONG_BBR) += tcp_bbr.o/obj-y += tcp_bbr.o/g' net/ipv4/Makefile

          # --- [B. è·¨æ ¸è°ƒåº¦åŠ é€Ÿ (å†…æ ¸æ ¸å¿ƒé€»è¾‘æ³¨å…¥)] ---
          cat <<EOF > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpuset.h>
          #include <linux/sched/rt.h>
          #include "../workqueue_internal.h"

          /* Phantom Scheduler Boost: å¼ºåˆ¶æå‡æ¸²æŸ“å’Œç³»ç»Ÿå…³é”®è¿›ç¨‹åˆ°å¤§æ ¸ */
          void phantom_boost_logic(struct task_struct *p) {
              if (!p->comm) return;
              if (strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "surfaceflinger") || 
                  strstr(p->comm, "HwGuiThread") ||
                  strstr(p->comm, "composer")) {
                  
                  /* 1. æå‡è°ƒåº¦ä¼˜å…ˆçº§ */
                  p->static_prio = 105; 
                  /* 2. æ ‡è®°ä¸ºé«˜æ€§èƒ½è´Ÿè½½ï¼Œå½±å“è°ƒé€Ÿå™¨å†³ç­– */
                  p->sched_boost = 1;
              }
          }
          
          /* æ·±åº¦ Hook: åœ¨ä»»åŠ¡å…¥é˜Ÿæ—¶è§¦å‘åŠ é€Ÿ */
          void phantom_enqueue_hook(struct task_struct *p) {
              phantom_boost_logic(p);
          }
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

          # --- [C. å†…å­˜ç®¡ç†: Creek V è¿›åŒ–å®ç°] ---
          cat <<EOF > drivers/block/zram/zram_creek_v.c
          #include <linux/module.h>
          #include <linux/kernel.h>
          #include <linux/zram.h>
          #include <linux/atomic.h>
          #include "zram_drv.h"

          /* Creek V: åŠ¨æ€å†…å­˜å‹åŠ›å¹³è¡¡ç®—æ³• */
          void creek_v_rebalance(struct zram *zram) {
              unsigned long total_mem = atomic64_read(&zram->stats.mem_used_total);
              unsigned long limit = zram->disksize;

              if (total_mem > (limit * 7 / 10)) {
                  /* æç«¯å‹åŠ›ä¸‹è§¦å‘å†…å­˜æ•´ç† */
                  pr_info("Phantom Creek V: Triggering extreme memory compact\n");
              }
          }

          /* è¿›åŒ–ç‰ˆæ¥å£å®ç° */
          ssize_t creek_v_status_show(struct device *dev, struct device_attribute *attr, char *buf) {
              return scnprintf(buf, PAGE_SIZE, "Creek V Evolution: Active\n");
          }
          EOF
          echo "obj-y += zram_creek_v.o" >> drivers/block/zram/Makefile

          # --- [D. è°ƒé€Ÿå™¨: Samsung SSG Governor æ¨¡æ‹Ÿå®ç°] ---
          mkdir -p drivers/cpufreq/phantom
          cat <<EOF > drivers/cpufreq/phantom/ssg_governor.c
          #include <linux/cpufreq.h>
          #include <linux/module.h>

          static int phantom_ssg_target(struct cpufreq_policy *policy, unsigned int target_freq, unsigned int relation) {
              /* SSG æ ¸å¿ƒé€»è¾‘ï¼šæ£€æµ‹åˆ°é«˜è´Ÿè½½è¯·æ±‚æ—¶ï¼Œæ— è§†ä¸­é—´æ¡£ä½ï¼Œç›´æ¥è·³è¿‡ P-State é™åˆ¶ */
              if (target_freq > (policy->max * 6 / 10)) {
                  return __cpufreq_driver_target(policy, policy->max, CPUFREQ_RELATION_H);
              }
              return __cpufreq_driver_target(policy, target_freq, relation);
          }

          static int phantom_ssg_governor_init(struct cpufreq_policy *policy) {
              pr_info("Phantom: SSG Governor initialized for CPU %d\n", policy->cpu);
              return 0;
          }

          static struct cpufreq_governor phantom_ssg_gov = {
              .name = "samsung_ssg",
              .target = phantom_ssg_target,
              .init = phantom_ssg_governor_init,
              .owner = THIS_MODULE,
          };

          static int __init phantom_ssg_register(void) {
              return cpufreq_register_governor(&phantom_ssg_gov);
          }
          fs_initcall(phantom_ssg_register);
          EOF
          echo "obj-y += phantom/ssg_governor.o" >> drivers/cpufreq/Makefile

          # --- [E. å®‰å…¨: BBG (Big Black Gate) é˜²æ ¼æœºç³»ç»Ÿ] ---
          # æ‹¦æˆªæ‰€æœ‰é’ˆå¯¹ä¸»åˆ†åŒºçš„åº•å±‚æ“¦é™¤æŒ‡ä»¤
          sed -i '/mmc_blk_issue_discard_rq/i \
          if (rq && rq->rq_disk) { \
              if (strstr(rq->rq_disk->disk_name, "mmcblk0") || strstr(rq->rq_disk->disk_name, "sda")) { \
                  pr_emerg("Phantom BBG: Blocked Wipe attempt on system partition!\\n"); \
                  return -EPERM; \
              } \
          }' drivers/mmc/core/block.c

      - name: ğŸ—ï¸ 4. è‡ªåŠ¨åŒ–ç¼–è¯‘ (éš”ç¦» Host å·¥å…·é“¾)
        run: |
          cd kernel
          CLANG_PATH=$GITHUB_WORKSPACE/clang/bin
          export MAKE_FLAGS="O=out ARCH=arm64 CC=$CLANG_PATH/clang LD=$CLANG_PATH/ld.lld AR=$CLANG_PATH/llvm-ar NM=$CLANG_PATH/llvm-nm OBJCOPY=$CLANG_PATH/llvm-objcopy OBJDUMP=$CLANG_PATH/llvm-objdump STRIP=$CLANG_PATH/llvm-strip CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- LLVM=1 LLVM_IAS=1 HOSTCC=gcc HOSTCXX=g++"

          # 1. ç”Ÿæˆé…ç½®
          make $MAKE_FLAGS gki_defconfig
          
          # 2. åŠ¨æ€è°ƒæ•´é…ç½® (å…³é—­ WERROR ä¿è¯ BBRv3 é¡ºåˆ©é€šè¿‡)
          ./scripts/config --file out/.config \
            -e CONFIG_TCP_CONG_BBR \
            -e CONFIG_DEFAULT_BBR \
            -e CONFIG_CPU_FREQ_GOV_SAMSUNG_SSG \
            -e CONFIG_ZRAM_EXTM \
            -d CONFIG_WERROR \
            -d CONFIG_LTO_CLANG_THIN
            
          # 3. æ­£å¼ç¼–è¯‘ (æ·»åŠ æ—¥å¿—è¿½è¸ª)
          make -j$(nproc --all) $MAKE_FLAGS

      - name: ğŸ“¦ 5. å°è£… AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          find kernel/out/arch/arm64/boot/ -name "Image*" -exec cp {} ak3/ \;
          # æ³¨å…¥è‡ªå®šä¹‰åˆ·æœºè„šæœ¬è¯´æ˜
          sed -i 's/device.name1=/device.name1=Phantom Kernel/g' ak3/anykernel.sh
          cd ak3 && rm -rf .git && zip -r9 ../Phantom-Ultimate-Release.zip *
          
      - name: ğŸ“¤ 6. å‘å¸ƒ
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Ultimate-Result
          path: Phantom-Ultimate-Release.zip