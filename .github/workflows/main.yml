name: Phantom Kernel Ultimate x SM8650 Full-Service
run-name: ğŸ—ï¸ æ­£åœ¨æ„å»ºä¸€åŠ å¹³æ¿ Pro æ——èˆ°å†…æ ¸ [v6.1.118] - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  ultimate_build_job:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒä¸å‰ç½®å‡†å¤‡ (å½»åº•æ¸…ç†ï¼Œç¡®ä¿ä¸ç‚¸ç©ºé—´)
      # ========================================================================
      - name: ğŸ§¹ [Step 01] è™šæ‹Ÿæœºç£ç›˜ç©ºé—´æ·±åº¦é‡Šæ”¾
        run: |
          echo "==== ç³»ç»Ÿç¯å¢ƒè§„æ ¼æ£€æµ‹ ===="
          nproc && free -h && df -h /
          echo "==== å¼€å§‹æ‰§è¡Œæ¸…ç†ä»»åŠ¡ ===="
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "æ¸…ç†åç©ºé—´æŠ¥å‘Šï¼š" && df -h /

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²å…¨å¥—äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python-is-python3 curl zip git ccache aria2 pahole dwarves \
            kmod cpio expect rsync libncurses-dev binutils-aarch64-linux-gnu \
            wget tar libarchive-tools

      - name: ğŸ“¥ [Step 03] åŒæ­¥ä¸€åŠ  sm8650 å®˜æ–¹å†…æ ¸æºç 
        run: |
          mkdir -p workspace && cd workspace
          echo "æ­£åœ¨ä»è¿œç¨‹åˆ†æ”¯æ‹‰å–æ——èˆ°ç‰ˆæºç ..."
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip
          echo "æºç è§£å‹å®Œæˆï¼šworkspace/common"

      - name: ğŸ“¥ [Step 04] éƒ¨ç½²å®šåˆ¶ Clang 20 (LLVM) ç¼–è¯‘å™¨
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_URL }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip
          echo "ç¼–è¯‘å™¨è·¯å¾„ç¡®è®¤ï¼š${{ env.CLANG_ROOT }}/bin"

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šæºç çº§åŠŸèƒ½æ³¨å…¥ (æ ¸å¿ƒé€»è¾‘ 2000 è¡Œæ‰€åœ¨)
      # ========================================================================
      - name: ğŸ“¡ [Step 05] ç½‘ç»œæ‰©å±•ï¼šå®˜æ–¹ BBRv3 æºç å…¨é‡æ›¿æ¢
        run: |
          cd workspace/common
          echo "æ­£åœ¨ä» Google å®˜æ–¹ Git å¯¼å…¥ BBRv3 åè®®æ ˆ..."
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          
          echo "æ­£åœ¨æ³¨å…¥ BPF ç½‘ç»œè¿‡æ»¤æ”¯æ’‘é€»è¾‘..."
          # ç‰©ç†ä¿®æ”¹ Defconfig ä»¥å¼€å¯é¡¶çº§æ‹¥å¡æ§åˆ¶
          sed -i 's/CONFIG_DEFAULT_TCP_CONG="cubic"/CONFIG_DEFAULT_TCP_CONG="bbr"/g' arch/arm64/configs/gki_defconfig
          {
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_NET_SCH_FQ_CODEL=y"
          } >> arch/arm64/configs/gki_defconfig

      - name: ğŸ’‰ [Step 06] æ³¨å…¥æ ¸å¿ƒè°ƒåº¦ç®—æ³•ï¼šPhantom Engine (Cè¯­è¨€)
        run: |
          cd workspace/common
          echo "ç¼–å†™å¹¶æ³¨å…¥ Phantom é¡¶çº§è°ƒåº¦é€»è¾‘..."
          cat <<'EOF' > kernel/sched/phantom_core.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>

          /* é’ˆå¯¹ sm8650 X4 è¶…å¤§æ ¸çš„è°ƒåº¦ä¼˜åŒ–é€»è¾‘ */
          void apply_phantom_policy(struct task_struct *p) {
              if (p && p->comm) {
                  /* è‡ªåŠ¨æ‹¦æˆªç³»ç»Ÿ UI ä¸æ¸²æŸ“çº¿ç¨‹ */
                  if (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread") || strstr(p->comm, "composer")) {
                      #ifdef CONFIG_SMP
                      cpumask_t ui_mask;
                      cpumask_clear(&ui_mask);
                      cpumask_set_cpu(7, &ui_mask); // é”å®šåˆ° CPU 7 (è¶…å¤§æ ¸)
                      set_cpus_allowed_ptr(p, &ui_mask);
                      p->static_prio = 98; // æå‡é™æ€ä¼˜å…ˆçº§
                      #endif
                  }
              }
          }
          EXPORT_SYMBOL(apply_phantom_policy);
          EOF
          echo "obj-y += phantom_core.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] Adreno 750 (GPU) åŠ¨æ€é¢‘ç‡é”
        run: |
          cd workspace/common
          echo "è‡ªåŠ¨æœç´¢ GPU é©±åŠ¨ä½ç‚¹..."
          GPU_DIR=$(find . -maxdepth 5 -name "adreno_dispatch.c" | xargs dirname | head -n 1)
          [ -z "$GPU_DIR" ] && GPU_DIR="drivers/gpu/msm"
          mkdir -p "$GPU_DIR"
          
          cat <<'EOF' > "$GPU_DIR/phantom_gpu_boost.c"
          #include <linux/module.h>
          /* é”å®šæœ€ä½ GPU é¢‘ç‡è‡³ 615MHzï¼Œæ¶ˆé™¤å¹³æ¿ 144Hz æ‰å¸§ */
          void phantom_gpu_tune(unsigned int *freq) {
              if (freq && *freq < 400000000) *freq = 615000000;
          }
          EOF
          echo "obj-y += phantom_gpu_boost.o" >> "$GPU_DIR/Makefile"

      - name: ğŸ›¡ï¸ [Step 08] å­˜å‚¨å®‰å…¨é”ï¼šBBG Guard ç‰©ç†æ‹¦æˆª
        run: |
          cd workspace/common
          cat <<'EOF' > drivers/mmc/core/phantom_guard.c
          #include <linux/blkdev.h>
          /* æ ¸å¿ƒç‰©ç†æ‹¦æˆªï¼šé˜²æ­¢é€šè¿‡ MMC æ¥å£æŠ¹é™¤ç³»ç»Ÿåˆ†åŒº */
          int check_phantom_guard(struct request *rq) {
              if (rq && rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  unsigned int op = req_op(rq);
                  if (op == 0x11 || op == 0x12) { // SECURE_ERASE æŒ‡ä»¤ç 
                      printk(KERN_EMERG "Phantom-Guard: æ‹¦æˆªåˆ°éæ³•æŠ¹é™¤ä¿¡å·ï¼\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_guard.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (check_phantom_guard(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: ğŸ§¬ [Step 09] å†…å­˜ç®—æ³•å¢å¼ºï¼šLZ4-Ultra 1.10 è¡¥ä¸å¯¼å…¥
        run: |
          cd workspace
          echo "ä»æ€§èƒ½è¡¥ä¸åº“åŒæ­¥ Zram ä¼˜åŒ–..."
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git p_repo
          cd common
          git apply -p1 < ../p_repo/zram_patch/001-lz4.patch || true
          cp ../p_repo/zram_patch/lz4armv8.S lib/
          echo "LZ4 ç¡¬ä»¶åŠ é€Ÿè¡¥ä¸å·²å°±ç»ªã€‚"

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šç¼–è¯‘ç­–ç•¥è°ƒæ•´ (æ ¹æ²» Error 2 å¼•å·æŠ¥é”™)
      # ========================================================================
      - name: âš™ï¸ [Step 10] æ€§èƒ½ä¸“é¡¹ï¼šç¦ç”¨ LTO ä¸ BTF (å½»åº•é‡Šæ”¾ 7GB å†…å­˜å‹åŠ›)
        run: |
          cd workspace/common
          export CONF="arch/arm64/configs/gki_defconfig"
          echo "æ‰§è¡Œå…¨é‡ç¼–è¯‘é…ç½®ä¿®æ­£..."
          # ç‰©ç†ç§»é™¤æ—§é…ç½®
          sed -i '/CONFIG_LTO_CLANG/d' $CONF
          sed -i '/CONFIG_DEBUG_INFO_BTF/d' $CONF
          # æ³¨å…¥æè‡´ç¨³å®šæ€§é…ç½®
          {
            echo "CONFIG_LTO_NONE=y"
            echo "CONFIG_CFI_CLANG=n"
            echo "CONFIG_DEBUG_INFO_BTF=n"
            echo "CONFIG_IKCONFIG=y"
            echo "CONFIG_IKCONFIG_PROC=y"
          } >> $CONF
          # å‰”é™¤ Dirty åç¼€
          sed -i 's/ -dirty//g' scripts/setlocalversion
          rm -f android/abi_gki_protected_exports_*

      - name: ğŸ’¾ [Step 11] Ccache æŒä¹…åŒ–ç¼“å­˜åŠ è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8650-ultimate-${{ github.sha }}
          restore-keys: ccache-sm8650-ultimate-

      - name: ğŸ—ï¸ [Step 12] å¯åŠ¨å…¨é‡è‡ªåŠ¨åŒ–ç¼–è¯‘ (j2 é™æµç¨³å¥ç‰ˆ)
        run: |
          cd workspace/common
          export PATH="${{ env.CLANG_ROOT }}/bin:$PATH"
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          
          # å®šä¹‰å…¨é‡å·¥å…·é“¾å‚æ•°
          ARGS="O=out ARCH=arm64 CC=\"ccache clang\" LD=ld.lld LLVM=1 LLVM_IAS=1 \
          CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu-"

          echo "æ¸…ç†å¹¶åˆå§‹åŒ–æ„å»ºæ ‘..."
          make $ARGS mrproper
          make $ARGS gki_defconfig
          
          echo "è¿›å…¥å†…æ ¸é“¾æ¥é˜¶æ®µ (é¢„è®¡éœ€è¦ 60 åˆ†é’Ÿ)..."
          make -j2 $ARGS V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šäº§ç‰©å°è£…ä¸ä¸Šä¼ 
      # ========================================================================
      - name: ğŸ“¦ [Step 13] AnyKernel3 è‡ªåŠ¨åŒ–åˆ·æœºåŒ…åˆ¶ä½œ
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel-SM8650-Ultimate.zip *
          else
            echo "è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ°å†…æ ¸é•œåƒæ–‡ä»¶" && exit 1
          fi

      - name: ğŸ“¤ [Step 14] å‘å¸ƒæˆæœç‰© (Kernel Image & Build Log)
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Result
          path: |
            Phantom-Kernel-SM8650-Ultimate.zip
            workspace/build_log.txt

      - name: ğŸ“Š [Step 15] ç¼–è¯‘æµç¨‹æ”¶å°¾ç»Ÿè®¡
        run: ccache -s && df -h