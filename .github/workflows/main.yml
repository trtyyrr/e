name: OKI Kernel Ultimate x SM8650 Epic-Full
run-name: ğŸ—ï¸ OKI æ¶æ„ä¸€åŠ å¹³æ¿ Pro ç‰©ç†çº§å…¨å±•å¼€ [v6.1.118] - ${{ github.actor }}

on:
  workflow_dispatch:

env:
  DEVICE_NAME: "OnePlusPadPro"
  # æ¢ç”¨ AOSP å®˜æ–¹æœ€å¼ºç”Ÿäº§çº§ç¼–è¯‘å™¨ç›´é“¾ (r483580)
  CLANG_ROOT: "${{ github.workspace }}/clang-oki"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_oki"
  SOURCE_URL: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"

jobs:
  ultimate_oki_build:
    runs-on: ubuntu-latest
    steps:
      # ========================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šç‰©ç†ç¯å¢ƒåŸå­çº§éƒ¨ç½² (æ¯ä¸€é¡¹éƒ½æ˜¯ç‹¬ç«‹æ­¥éª¤)
      # ========================================================================
      - name: ğŸ§¹ [Step 001] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 01
        run: sudo docker image prune -a -f
      - name: ğŸ§¹ [Step 002] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 02
        run: sudo rm -rf /usr/share/dotnet
      - name: ğŸ§¹ [Step 003] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 03
        run: sudo rm -rf /usr/local/lib/android
      - name: ğŸ§¹ [Step 004] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 04
        run: sudo rm -rf /opt/ghc
      - name: ğŸ§¹ [Step 005] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 05
        run: sudo rm -rf /usr/local/share/powershell
      - name: ğŸ§¹ [Step 006] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 06
        run: sudo rm -rf /usr/share/swift
      - name: ğŸ§¹ [Step 007] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 07
        run: sudo rm -rf /usr/local/lib/node_modules
      - name: ğŸ§¹ [Step 008] ç‰©ç†ç©ºé—´å›æ”¶ - èŠ‚ç‚¹ 08
        run: sudo rm -rf /usr/lib/google-cloud-sdk

      - name: ğŸ› ï¸ [Step 009] éƒ¨ç½²ä¾èµ– - bc
        run: sudo apt-get install -y bc
      - name: ğŸ› ï¸ [Step 010] éƒ¨ç½²ä¾èµ– - flex
        run: sudo apt-get install -y flex
      - name: ğŸ› ï¸ [Step 011] éƒ¨ç½²ä¾èµ– - bison
        run: sudo apt-get install -y bison
      - name: ğŸ› ï¸ [Step 012] éƒ¨ç½²ä¾èµ– - libssl-dev
        run: sudo apt-get install -y libssl-dev
      - name: ğŸ› ï¸ [Step 013] éƒ¨ç½²ä¾èµ– - libelf-dev
        run: sudo apt-get install -y libelf-dev
      - name: ğŸ› ï¸ [Step 014] éƒ¨ç½²ä¾èµ– - clang
        run: sudo apt-get install -y clang
      - name: ğŸ› ï¸ [Step 015] éƒ¨ç½²ä¾èµ– - lld
        run: sudo apt-get install -y lld
      - name: ğŸ› ï¸ [Step 016] éƒ¨ç½²ä¾èµ– - llvm
        run: sudo apt-get install -y llvm
      - name: ğŸ› ï¸ [Step 017] éƒ¨ç½²ä¾èµ– - python3
        run: sudo apt-get install -y python3
      - name: ğŸ› ï¸ [Step 018] éƒ¨ç½²ä¾èµ– - python3-dev
        run: sudo apt-get install -y python3-dev
      - name: ğŸ› ï¸ [Step 019] éƒ¨ç½²ä¾èµ– - curl
        run: sudo apt-get install -y curl
      - name: ğŸ› ï¸ [Step 020] éƒ¨ç½²ä¾èµ– - zip
        run: sudo apt-get install -y zip
      - name: ğŸ› ï¸ [Step 021] éƒ¨ç½²ä¾èµ– - unzip
        run: sudo apt-get install -y unzip
      - name: ğŸ› ï¸ [Step 022] éƒ¨ç½²ä¾èµ– - git
        run: sudo apt-get install -y git
      - name: ğŸ› ï¸ [Step 023] éƒ¨ç½²ä¾èµ– - ccache
        run: sudo apt-get install -y ccache
      - name: ğŸ› ï¸ [Step 024] éƒ¨ç½²ä¾èµ– - aria2
        run: sudo apt-get install -y aria2
      - name: ğŸ› ï¸ [Step 025] éƒ¨ç½²ä¾èµ– - pahole
        run: sudo apt-get install -y pahole
      - name: ğŸ› ï¸ [Step 026] éƒ¨ç½²ä¾èµ– - dwarves
        run: sudo apt-get install -y dwarves
      - name: ğŸ› ï¸ [Step 027] éƒ¨ç½²ä¾èµ– - rsync
        run: sudo apt-get install -y rsync
      - name: ğŸ› ï¸ [Step 028] éƒ¨ç½²ä¾èµ– - device-tree-compiler
        run: sudo apt-get install -y device-tree-compiler

      # ========================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šç‰©ç†ä¿®æ­£ç¼–è¯‘å™¨ä¸‹è½½ (å¤šæºå†—ä½™)
      # ========================================================================
      - name: ğŸ“¥ [Step 029] ç¼–è¯‘å™¨ - å»ºç«‹ç‰©ç†ç›®å½•
        run: mkdir -p ${{ env.CLANG_ROOT }}
      
      - name: ğŸ“¥ [Step 030] ç¼–è¯‘å™¨ - å°è¯•å®˜æ–¹æºä¸‹è½½ (AOSP)
        run: |
          cd ${{ github.workspace }}
          aria2c -s16 -x16 -k1M "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r483580.tar.gz" -o clang.tar.gz || \
          wget https://raw.githubusercontent.com/cctv18/oneplus_sm8650_toolchain/main/clang-r483580.tar.gz -O clang.tar.gz || \
          curl -LO https://github.com/ZyCromerZ/Clang/releases/download/17.0.0-20231010-release/Clang-17.0.0-20231010.tar.gz

      - name: ğŸ“¥ [Step 031] ç¼–è¯‘å™¨ - ç‰©ç†å±•å¼€
        run: tar -C ${{ env.CLANG_ROOT }} -xzf clang.tar.gz && rm clang.tar.gz

      - name: ğŸ“¥ [Step 032] ç¼–è¯‘å™¨ - ç‰ˆæœ¬ç‰©ç†ç¡®è®¤
        run: ${{ env.CLANG_ROOT }}/bin/clang --version

      # ========================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šæºç ç‰©ç†åŒæ­¥
      # ========================================================================
      - name: ğŸ“¥ [Step 033] æºç  - ç‰©ç†ä¸‹è½½æ‰§è¡Œ
        run: aria2c -s16 -x16 -k1M ${{ env.SOURCE_URL }} -o kernel.zip
      - name: ğŸ“¥ [Step 034] æºç  - ç‰©ç†å»ºç«‹ç©ºé—´
        run: mkdir -p workspace
      - name: ğŸ“¥ [Step 035] æºç  - ç‰©ç†å±•å¼€å†…å®¹
        run: unzip -q kernel.zip -d workspace/
      - name: ğŸ“¥ [Step 036] æºç  - ç‰©ç†è·¯å¾„é‡æ„
        run: mv workspace/android_kernel_common_oneplus_sm8650-* workspace/common
      - name: ğŸ“¥ [Step 037] æºç  - ç‰©ç†æ¸…ç†å½’æ¡£
        run: rm kernel.zip

      # ========================================================================
      # ç¬¬å››é˜¶æ®µï¼šOKI æ ¸å¿ƒé…ç½®åŸå­å¹³é“º (ç¦æ­¢åˆå¹¶ï¼Œæ¯ä¸€é¡¹ç‹¬ç«‹æ­¥éª¤)
      # ========================================================================
      - name: âš™ï¸ [Step 038] OKI Config - ç‰©ç†æ³¨å…¥ BBR
        run: echo "CONFIG_TCP_CONG_BBR=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 039] OKI Config - ç‰©ç†æ³¨å…¥é»˜è®¤ç®—æ³•
        run: echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 040] OKI Config - ç‰©ç†æ³¨å…¥ FQ è°ƒåº¦å™¨
        run: echo "CONFIG_NET_SCH_FQ=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 041] OKI Config - ç‰©ç†æ³¨å…¥ 1000Hz æ”¯æŒ
        run: echo "CONFIG_HZ_1000=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 042] OKI Config - ç‰©ç†ä¿®æ­£ HZ é¢‘ç‡å€¼
        run: sed -i 's/CONFIG_HZ=250/CONFIG_HZ=1000/g' workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 043] OKI Config - ç‰©ç†æ³¨å…¥ WALT
        run: echo "CONFIG_SCHED_WALT=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 044] OKI Config - ç‰©ç†æ³¨å…¥ ZRAM
        run: echo "CONFIG_ZRAM=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 045] OKI Config - ç‰©ç†æ³¨å…¥ LZ4HC
        run: echo "CONFIG_LZ4HC_COMPRESS=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 046] OKI Config - ç‰©ç†æ³¨å…¥ ZSMALLOC
        run: echo "CONFIG_ZSMALLOC=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 047] OKI Config - ç‰©ç†å±è”½ LTO é™åˆ¶
        run: sed -i '/CONFIG_LTO_CLANG/d' workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 048] OKI Config - ç‰©ç†å£°æ˜ LTO_NONE
        run: echo "CONFIG_LTO_NONE=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 049] OKI Config - ç‰©ç†å±è”½ BTF é™åˆ¶
        run: sed -i '/CONFIG_DEBUG_INFO_BTF/d' workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 050] OKI Config - ç‰©ç†å£°æ˜ BTF_OFF
        run: echo "CONFIG_DEBUG_INFO_BTF=n" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 051] OKI Config - ç‰©ç†å¼€å¯æ‰€æœ‰ç¬¦å·å¯¼å‡º
        run: echo "CONFIG_UNUSED_SYMBOLS=y" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 052] OKI Config - ç‰©ç†ç¦ç”¨å†…æ ¸è£å‰ª
        run: echo "CONFIG_TRIM_UNUSED_KSYMS=n" >> workspace/common/arch/arm64/configs/gki_defconfig
      - name: âš™ï¸ [Step 053] OKI Config - ç‰©ç†ç¦ç”¨ CFI ä¿æŠ¤
        run: echo "CONFIG_CFI_CLANG=n" >> workspace/common/arch/arm64/configs/gki_defconfig

      # ========================================================================
      # ç¬¬äº”é˜¶æ®µï¼šç¯å¢ƒå˜é‡ç‰©ç†å¹³é“º (æ¯ä¸€é¡¹éƒ½æ˜¾å¼å£°æ˜)
      # ========================================================================
      - name: ğŸ—ï¸ [Step 054] ç¯å¢ƒ - PATH ç‰©ç†å¹³é“º
        run: echo "${{ env.CLANG_ROOT }}/bin" >> $GITHUB_PATH
      - name: ğŸ—ï¸ [Step 055] ç¯å¢ƒ - ARCH ç‰©ç†å£°æ˜
        run: echo "ARCH=arm64" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 056] ç¯å¢ƒ - SUBARCH ç‰©ç†å£°æ˜
        run: echo "SUBARCH=arm64" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 057] ç¯å¢ƒ - LLVM ç‰©ç†å£°æ˜
        run: echo "LLVM=1" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 058] ç¯å¢ƒ - LLVM_IAS ç‰©ç†å£°æ˜
        run: echo "LLVM_IAS=1" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 059] ç¯å¢ƒ - CC ç‰©ç†å£°æ˜
        run: echo "CC=ccache clang" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 060] ç¯å¢ƒ - LD ç‰©ç†å£°æ˜
        run: echo "LD=ld.lld" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 061] ç¯å¢ƒ - AR ç‰©ç†å£°æ˜
        run: echo "AR=llvm-ar" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 062] ç¯å¢ƒ - NM ç‰©ç†å£°æ˜
        run: echo "NM=llvm-nm" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 063] ç¯å¢ƒ - OBJCOPY ç‰©ç†å£°æ˜
        run: echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 064] ç¯å¢ƒ - STRIP ç‰©ç†å£°æ˜
        run: echo "STRIP=llvm-strip" >> $GITHUB_ENV
      - name: ğŸ—ï¸ [Step 065] ç¯å¢ƒ - CCACHE_DIR ç‰©ç†å£°æ˜
        run: echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      # ========================================================================
      # ç¬¬å…­é˜¶æ®µï¼šç¼–è¯‘æ‰§è¡Œ (åŸå­åŒ–ç‰©ç†æ­¥éª¤)
      # ========================================================================
      - name: ğŸ“‚ [Step 066] Ccache - ç‰©ç†æŒ‚è½½
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: oki-ccache-fix-v2-${{ github.sha }}
          restore-keys: oki-ccache-fix-v2-

      - name: ğŸ—ï¸ [Step 067] OKI ç¼–è¯‘ - åˆå§‹åŒ– Out
        run: mkdir -p workspace/common/out
      - name: ğŸ—ï¸ [Step 068] OKI ç¼–è¯‘ - ç”Ÿæˆé…ç½®
        run: make -C workspace/common O=out ARCH=arm64 gki_defconfig
      - name: ğŸ—ï¸ [Step 069] OKI ç¼–è¯‘ - åŒæ­¥é…ç½®
        run: yes "" | make -C workspace/common O=out ARCH=arm64 olddefconfig
      - name: ğŸ—ï¸ [Step 070] OKI ç¼–è¯‘ - å¯¼å‡º UAPI å¤´æ–‡ä»¶
        run: make -C workspace/common O=out ARCH=arm64 headers_install
      
      - name: ğŸ—ï¸ [Step 071] OKI ç¼–è¯‘ - æ ¸å¿ƒé•œåƒ Image
        run: |
          export KCFLAGS="-march=armv8-a+crc+crypto -O3 -pipe"
          make -j$(nproc) -C workspace/common O=out ARCH=arm64 KCFLAGS="$KCFLAGS" V=1 Image 2>&1 | tee workspace/image_build.log

      - name: ğŸ—ï¸ [Step 072] OKI ç¼–è¯‘ - è®¾å¤‡æ ‘ DTBS
        run: make -j$(nproc) -C workspace/common O=out ARCH=arm64 dtbs 2>&1 | tee workspace/dtbs_build.log

      # ========================================================================
      # ç¬¬ä¸ƒé˜¶æ®µï¼šæˆæœå°è£… (ç‰©ç†å¹³é“º)
      # ========================================================================
      - name: ğŸ“¦ [Step 073] å°è£… - å…‹éš† AK3
        run: git clone --depth=1 https://github.com/osm0sis/AnyKernel3 workspace/ak3
      - name: ğŸ“¦ [Step 074] å°è£… - æ‹·è´é•œåƒ
        run: cp workspace/common/out/arch/arm64/boot/Image workspace/ak3/
      - name: ğŸ“¦ [Step 075] å°è£… - é€‚é…åç§° 1
        run: sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" workspace/ak3/anykernel.sh
      - name: ğŸ“¦ [Step 076] å°è£… - é€‚é…åç§° 2
        run: sed -i "s/device.name2=/device.name2=OnePlus12/g" workspace/ak3/anykernel.sh
      - name: ğŸ“¦ [Step 077] å°è£… - ç¦ç”¨è®¾å¤‡æ ¡éªŒ
        run: sed -i "s/do.devicecheck=1/do.devicecheck=0/g" workspace/ak3/anykernel.sh
      - name: ğŸ“¦ [Step 078] å°è£… - ç‰©ç†å‹ç¼©
        run: cd workspace/ak3 && zip -r9 ../../OKI-Kernel-Final.zip *

      - name: ğŸ“¤ [Step 079] å‘å¸ƒ - ä¸Šä¼ é•œåƒåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: OKI-Final-Package
          path: OKI-Kernel-Final.zip

      - name: ğŸ“Š [Step 080] ç»Ÿè®¡ - ç‰©ç†æ‰“å°
        run: ccache -s