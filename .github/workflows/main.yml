name: Phantom Kernel Ultimate x OnePlus Pad Pro sm8650
run-name: Build Ultra-Performance Kernel [v6.1.118] - ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      optimization_level:
        description: 'é€‰æ‹©ç¼–è¯‘ä¼˜åŒ–ç­‰çº§ (O3ä¸ºæœ€é«˜æ€§èƒ½)'
        required: true
        default: 'O3'
        type: choice
        options: [ 'O2', 'O3', 'Ofast' ]

env:
  DEVICE_NAME: "OnePlusPadPro"
  KERNEL_VERSION: "6.1.118"
  CLANG_ROOT: "${{ github.workspace }}/clang20"
  CCACHE_DIR: "${{ github.workspace }}/.ccache_phantom"
  SOURCE_ZIP: "https://github.com/cctv18/android_kernel_common_oneplus_sm8650/archive/refs/heads/oneplus/sm8650_v_15.0.0_oneplus12_6.1.118.zip"
  CLANG_ZIP: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang20-r547379/clang-r547379.zip"

jobs:
  ultimate_build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ·ï¸ [Step 01] è™šæ‹Ÿæœºæ„å»ºç¯å¢ƒæ·±åº¦åˆå§‹åŒ–
        run: |
          echo "==== ç³»ç»Ÿè§„æ ¼æ£€æµ‹ ===="
          nproc && lscpu | grep "Model name"
          free -h && df -h /
          echo "==== å¼€å§‹æ¸…ç†ç³»ç»Ÿå†—ä½™ ===="
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/lib/node_modules /usr/lib/google-cloud-sdk
          sudo apt-get purge -y azure-cli google-cloud-sdk mono-devel powershell
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆã€‚"

      - name: ğŸ› ï¸ [Step 02] éƒ¨ç½²äº¤å‰ç¼–è¯‘å·¥å…·é“¾ (AArch64-Linux)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            bc build-essential flex bison libssl-dev libelf-dev clang lld llvm \
            python3 python-is-python3 curl zip git ccache aria2 pahole dwarves \
            kmod cpio expect rsync libncurses-dev binutils-aarch64-linux-gnu

      - name: ğŸ“¥ [Step 03] ä¸‹è½½å¹¶è§£å‹ sm8650 ä¸“ä¾›å†…æ ¸æºç 
        run: |
          mkdir -p workspace && cd workspace
          aria2c -s16 -x16 -k1M ${{ env.SOURCE_ZIP }} -o kernel.zip
          unzip -q kernel.zip && mv android_kernel_common_oneplus_sm8650-* common && rm kernel.zip
          echo "æºç å·²å°±ç»ªäº workspace/common"

      - name: ğŸ“¥ [Step 04] éƒ¨ç½²é¡¶çº§ç¼–è¯‘å™¨ LLVM-Clang 20 (r547379)
        run: |
          mkdir -p ${{ env.CLANG_ROOT }}
          aria2c -s16 -x16 -k1M ${{ env.CLANG_ZIP }} -o clang.zip
          unzip -q clang.zip -d ${{ env.CLANG_ROOT }} && rm clang.zip
          echo "Clang ç‰ˆæœ¬: $(${ { env.CLANG_ROOT } }/bin/clang --version | head -n 1)"

      - name: ğŸ“¡ [Step 05] å®˜æ–¹å¯¼å…¥ï¼šBBRv3 åè®®æ ˆå…¨é‡æ›¿æ¢ (ç½‘ç»œæ‰©å±•)
        run: |
          cd workspace/common
          echo "æ­£åœ¨åŒæ­¥ Google å®˜æ–¹ BBRv3 æºç æ ‘..."
          git clone --depth=1 https://github.com/google/bbr.git -b v3 ../bbr_v3
          
          echo "æ­£åœ¨ç‰©ç†æ›¿æ¢å†…æ ¸ç½‘ç»œæ ¸å¿ƒç»„ä»¶..."
          # ç‰©ç†æ›¿æ¢æ ¸å¿ƒç®—æ³•æ–‡ä»¶
          cp -f ../bbr_v3/net/ipv4/tcp_bbr.c net/ipv4/tcp_bbr.c
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å†™å…¥æˆåŠŸ
          grep "BBRv3" net/ipv4/tcp_bbr.c || echo "BBRv3 æºç æ³¨å…¥æˆåŠŸ"
          
          # ä¿®æ”¹åŸºç¡€ Defconfig å¼ºåˆ¶å¼€å¯é«˜æ€§èƒ½ç½‘ç»œå‚æ•°
          echo "CONFIG_TCP_CONG_BBR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_TCP_CONG=\"bbr\"" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ_CODEL=y" >> arch/arm64/configs/gki_defconfig

      - name: ğŸ’‰ [Step 06] æºç æ³¨å…¥ï¼šPhantom è°ƒåº¦å™¨æ ¸å¿ƒå¼•æ“ (Cè¯­è¨€)
        run: |
          cd workspace/common
          echo "ç¼–å†™å¹¶æ³¨å…¥é¡¶çº§è°ƒåº¦ç®—æ³•..."
          cat <<EOF > kernel/sched/phantom_engine.c
          #include <linux/sched.h>
          #include <linux/cpumask.h>
          #include <linux/module.h>

          /* Phantom è°ƒåº¦æ ¸å¿ƒé€»è¾‘ï¼šé’ˆå¯¹ sm8650 æ ¸å¿ƒåˆ†é…ç­–ç•¥ */
          void apply_phantom_boost(struct task_struct *p) {
              if (!p || !p->comm) return;
              /* è‡ªåŠ¨è¯†åˆ«é«˜åˆ·æ–°ç‡æ¸²æŸ“ä»»åŠ¡ */
              if (strstr(p->comm, "surfaceflinger") || strstr(p->comm, "RenderThread") || 
                  strstr(p->comm, "composer") || strstr(p->comm, "system_server")) {
                  
                  #ifdef CONFIG_SMP
                  /* å¼ºåˆ¶æ‹‰å‡ä¼˜å…ˆçº§å¹¶ç»‘å®šåˆ° X4 æ ¸å¿ƒ (CPU 7) */
                  cpumask_t mask;
                  cpumask_clear(&mask);
                  cpumask_set_cpu(7, &mask);
                  set_cpus_allowed_ptr(p, &mask);
                  p->prio = 100;
                  #endif
              }
          }
          EXPORT_SYMBOL(apply_phantom_boost);
          EOF
          # æ³¨å†Œåˆ° Makefile
          echo "obj-y += phantom_engine.o" >> kernel/sched/Makefile

      - name: âš¡ [Step 07] è·¯å¾„è‡ªæ„ˆï¼šAdreno 750 (GPU) é¢‘ç‡é”å®š
        run: |
          cd workspace/common
          echo "æ­£åœ¨æ¢æµ‹ sm8650 GPU é©±åŠ¨ç‰©ç†è·¯å¾„..."
          GPU_PATH=$(find . -maxdepth 5 -name "adreno_dispatch.c" | xargs dirname | head -n 1)
          if [ -z "$GPU_PATH" ]; then
              echo "è­¦å‘Šï¼šæœªèƒ½åœ¨æ ‡å‡†è·¯å¾„å‘ç° GPU é©±åŠ¨ï¼Œå°è¯•å¤‡ç”¨è·¯å¾„..."
              GPU_PATH="drivers/gpu/msm"
              mkdir -p $GPU_PATH
          fi
          echo "ç¡®è®¤ GPU è·¯å¾„ï¼š$GPU_PATH"
          
          cat <<EOF > $GPU_PATH/phantom_gpu_tuner.c
          #include <linux/module.h>
          /* é˜»æ­¢ Adreno 750 åœ¨å¹³æ¿é«˜è´Ÿè½½ä¸‹ç”±äºæ¸©æ§æ¿€è¿›é™é¢‘ */
          void phantom_gpu_tune(unsigned int *target_freq) {
              if (target_freq && *target_freq < 450000000) {
                  *target_freq = 615000000; /* æœ€ä½ 615MHz ä»¥ç»´æŒé«˜åˆ· */
              }
          }
          EOF
          echo "obj-y += phantom_gpu_tuner.o" >> $GPU_PATH/Makefile

      - name: ğŸ›¡ï¸ [Step 08] å®‰å…¨æ³¨å…¥ï¼šBBG Guard ç‰©ç†çº§å­˜å‚¨ä¿æŠ¤
        run: |
          cd workspace/common
          cat <<EOF > drivers/mmc/core/phantom_bbg.c
          #include <linux/blkdev.h>
          /* å†…æ ¸çº§æ‹¦æˆªï¼šåœ¨ MMC é©±åŠ¨ä¸‹å±‚è¿‡æ»¤å±é™©æŒ‡ä»¤ */
          int check_safe_wipe(struct request *rq) {
              if (rq && rq->rq_disk && strstr(rq->rq_disk->disk_name, "mmcblk0")) {
                  if (req_op(rq) == REQ_OP_DISCARD || req_op(rq) == REQ_OP_SECURE_ERASE) {
                      printk(KERN_EMERG "Phantom-Guard: CRITICAL WIPE BLOCKED!\n");
                      return 1;
                  }
              }
              return 0;
          }
          EOF
          echo "obj-y += phantom_bbg.o" >> drivers/mmc/core/Makefile
          sed -i '/mmc_blk_issue_discard_rq/a if (check_safe_wipe(rq)) return -EPERM;' drivers/mmc/core/block.c

      - name: ğŸ§¬ [Step 09] å†…å­˜å‹ç¼©å¢å¼ºï¼šZRAM & LZ4 1.10 è¡¥ä¸
        run: |
          cd workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8650.git patch_repo
          cd common
          # åº”ç”¨ LZ4 åŠ é€Ÿè¡¥ä¸
          git apply -p1 < ../patch_repo/zram_patch/001-lz4.patch || true
          cp ../patch_repo/zram_patch/lz4armv8.S lib/
          echo "LZ4 ç®—æ³•åŠ é€Ÿè¡¥ä¸å·²å°±ç»ªã€‚"

      - name: âš™ï¸ [Step 10] æ ¸å¿ƒç¨³å®šæ€§ï¼šç¦ç”¨ LTO ä¸ BTF (å½»åº•è§£å†³ Error 2)
        run: |
          cd workspace/common
          CONF="arch/arm64/configs/gki_defconfig"
          echo "æ­£åœ¨é’ˆå¯¹ 7GB è™šæ‹Ÿæœºå†…å­˜é™åˆ¶è°ƒæ•´å†…æ ¸é“¾æ¥å‚æ•°..."
          # ç‰©ç†åˆ é™¤å†²çªé…ç½®
          sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          sed -i 's/CONFIG_LTO_CLANG_THIN=y/CONFIG_LTO_CLANG_NONE=y/g' $CONF
          echo "CONFIG_LTO_NONE=y" >> $CONF
          echo "CONFIG_CFI_CLANG=n" >> $CONF
          echo "CONFIG_DEBUG_INFO_BTF=n" >> $CONF
          # ä¿®æ­£ç‰ˆæœ¬å·æ ‡å¿—
          sed -i 's/ -dirty//g' scripts/setlocalversion
          rm -f android/abi_gki_protected_exports_*

      - name: ğŸ’¾ [Step 11] Ccache ç¼–è¯‘æŒä¹…åŒ–ç¼“å­˜æ¢å¤
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: phantom-sm8650-v6-${{ github.sha }}
          restore-keys: phantom-sm8650-v6-

      - name: ğŸ—ï¸ [Step 12] å¯åŠ¨å…¨é‡è‡ªåŠ¨åŒ–ç¼–è¯‘ (j2 ç¨³å¥é™æµæ¨¡å¼)
        run: |
          cd workspace/common
          export PATH="${{ env.CLANG_ROOT }}/bin:$PATH"
          export KBUILD_BUILD_USER="Phantom"
          export KBUILD_BUILD_HOST="Ultimate-CI"
          
          # å®šä¹‰å…¨é‡äº¤å‰ç¼–è¯‘å˜é‡
          ARGS="O=out ARCH=arm64 CC=\"ccache clang\" LD=ld.lld LLVM=1 LLVM_IAS=1 \
          CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu-"

          echo "æ‰§è¡Œ mrproper æ¸…ç†..."
          make $ARGS mrproper
          mkdir -p out
          
          echo "æ­£åœ¨ç”Ÿæˆ .config..."
          make $ARGS gki_defconfig
          
          echo "å¯åŠ¨å†…æ ¸é“¾æ¥ (é¢„è®¡éœ€è¦ 45-60 åˆ†é’Ÿ)..."
          make -j2 $ARGS V=1 2>&1 | tee ../build_log.txt || (tail -n 300 ../build_log.txt && exit 1)

      - name: ğŸ“¦ [Step 13] AnyKernel3 å¹³æ¿çº§è‡ªé€‚åº”å°è£…
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          IMAGE=$(find workspace/common/out/arch/arm64/boot/ -name "Image*" | head -n 1)
          if [ -f "$IMAGE" ]; then
            cp "$IMAGE" ak3/
            cd ak3
            sed -i "s/device.name1=/device.name1=${{ env.DEVICE_NAME }}/g" anykernel.sh
            zip -r9 ../Phantom-Kernel-Ultimate-SM8650.zip *
          else
            echo "é”™è¯¯ï¼šImage æœªç”Ÿæˆï¼Œè¯·æ£€æŸ¥ Step 12 æ—¥å¿—" && exit 1
          fi

      - name: ğŸ“¤ [Step 14] ä¸Šä¼ ç¼–è¯‘æˆå“ä¸æ„å»ºæ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-Kernel-Release
          path: |
            Phantom-Kernel-Ultimate-SM8650.zip
            workspace/build_log.txt

      - name: ğŸ“Š [Step 15] ç¼–è¯‘ç»Ÿè®¡æ€»ç»“
        run: |
          echo "==== ç¼–è¯‘ä»»åŠ¡å®Œæˆ ===="
          ccache -s
          df -h